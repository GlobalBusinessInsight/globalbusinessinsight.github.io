<!DOCTYPE html>
<html lang="en">
<head>
 <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6214772877334340"
     crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airbus Skywise Ontology: Full Cockpit Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts: Orbitron for Sci-Fi, JetBrains Mono for Data, Inter for UI -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;700&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #050b14; /* Deep Space Blue */
            color: #e2e8f0;
            overflow: hidden;
            font-family: "Inter", sans-serif;
        }
        .font-mono { font-family: "JetBrains Mono", monospace; }
        .font-sci { font-family: "Orbitron", sans-serif; }
        
        .glass {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(56, 189, 248, 0.15);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 2px; }

        /* Step Highlight Animation */
        .step-item {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0.3;
            transform: translateX(0);
            border-left: 2px solid transparent;
        }
        .step-item.active {
            opacity: 1;
            transform: translateX(5px);
            background: linear-gradient(90deg, rgba(56, 189, 248, 0.1), transparent);
            border-left: 2px solid #38bdf8;
        }

        /* Log Entry Animation */
        .log-entry { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Neon Text Effect */
        .text-glow { text-shadow: 0 0 10px rgba(56, 189, 248, 0.5); }
    </style>
</head>
<body class="h-screen w-screen flex text-sm bg-[#020408]">

    <!-- LEFT SIDEBAR: NARRATIVE -->
    <div class="w-80 h-full glass z-20 flex flex-col border-r border-sky-900/20 shrink-0">
        <div class="p-6 border-b border-sky-900/20 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-sky-500 to-transparent opacity-50"></div>
            <h1 class="font-sci font-bold text-sky-400 tracking-widest text-xl mb-1 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                SKYWISE <span class="text-white">OS</span>
            </h1>
            <p class="text-[10px] text-slate-400 uppercase tracking-wide font-mono">Ontology Digital Twin</p>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-6">
            <div id="step-1" class="step-item p-4 rounded-r-lg">
                <div class="text-[10px] font-bold text-sky-400 mb-1 tracking-wider font-sci">PHASE 01</div>
                <h3 class="font-bold text-white mb-2">Data Ingestion</h3>
                <p class="text-xs text-slate-400 leading-relaxed">
                    Real-time integration of QAR sensor data and SAP maintenance records. Observe the dense data packets flowing on the links below.
                </p>
            </div>

            <div id="step-2" class="step-item p-4 rounded-r-lg">
                <div class="text-[10px] font-bold text-indigo-400 mb-1 tracking-wider font-sci">PHASE 02</div>
                <h3 class="font-bold text-white mb-2">Semantic Linking</h3>
                <p class="text-xs text-slate-400 leading-relaxed">
                    The Ontology layer automatically builds "Aircraft-Engine-Route" links. The central <strong class="text-sky-300">A320 Master Dashboard</strong> activates, showing real-time flight parameters.
                </p>
            </div>

            <div id="step-3" class="step-item p-4 rounded-r-lg">
                <div class="text-[10px] font-bold text-red-500 mb-1 tracking-wider font-sci">PHASE 03</div>
                <h3 class="font-bold text-white mb-2">Anomaly Detection</h3>
                <p class="text-xs text-slate-400 leading-relaxed">
                    <span class="text-red-400 font-bold">ALERT TRIGGERED:</span> Upper RR Engine gauge shows high EGT. A320 Dashboard automatically switches strategy to "Condition-Based".
                </p>
            </div>

            <div id="step-4" class="step-item p-4 rounded-r-lg">
                <div class="text-[10px] font-bold text-emerald-500 mb-1 tracking-wider font-sci">PHASE 04</div>
                <h3 class="font-bold text-white mb-2">Closed Loop Action</h3>
                <p class="text-xs text-slate-400 leading-relaxed">
                    Predictive maintenance application automatically issues work orders. System status recovers, dashboard metrics return to green/safe zones.
                </p>
            </div>
        </div>

        <!-- Controls -->
        <div class="p-5 border-t border-sky-900/20 bg-slate-900/80">
            <div class="flex justify-between text-[10px] text-slate-500 mb-2 font-mono">
                <span>SIMULATION TIME</span>
                <span id="timer-text">00.00s</span>
            </div>
            <div class="w-full h-1 bg-slate-800 rounded-full overflow-hidden mb-4">
                <div id="global-progress" class="h-full bg-sky-500 w-0 transition-all duration-100 shadow-[0_0_10px_rgba(14,165,233,0.5)]"></div>
            </div>
            <button id="restartBtn" class="w-full py-2 border border-slate-700 hover:bg-sky-500/10 hover:border-sky-500/50 rounded text-xs text-sky-100 transition-all font-sci tracking-wide group">
                <span class="group-hover:text-glow transition-all">REBOOT SYSTEM</span>
            </button>
        </div>
    </div>

    <!-- CENTER: Main Canvas -->
    <div class="flex-1 relative bg-[#020408] overflow-hidden cursor-crosshair flex flex-col justify-center items-center">
        <!-- Dynamic Grid Background -->
        <div class="absolute inset-0 pointer-events-none opacity-10" 
             style="background-image: linear-gradient(rgba(56,189,248,0.3) 1px, transparent 1px), linear-gradient(90deg, rgba(56,189,248,0.3) 1px, transparent 1px); background-size: 40px 40px;">
        </div>
        
        <!-- Logo Injection: Approx 10cm (380px) from bottom, centered -->
        <div class="absolute bottom-[380px] left-1/2 transform -translate-x-1/2 z-0 opacity-80 pointer-events-none">
            <!-- Using .svg extension instead of .svgeee -->
            <img src="https://globalbusinessinsight.github.io/picture/inossem_logo.svg" alt="Inossem Logo" class="w-32 md:w-40 drop-shadow-[0_0_10px_rgba(255,255,255,0.3)]">
        </div>

        <canvas id="mainCanvas" class="absolute top-0 left-0 block w-full h-full z-10"></canvas>

        <!-- Top Left Status -->
        <div class="absolute top-6 left-8 glass px-4 py-2 rounded border-l-4 border-emerald-500 flex items-center gap-4 transition-all duration-500 z-20" id="system-badge">
            <div class="relative flex h-3 w-3">
              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
              <span class="relative inline-flex rounded-full h-3 w-3 bg-emerald-500" id="status-dot"></span>
            </div>
            <div>
                <div class="text-[10px] text-slate-400 font-bold tracking-widest font-sci">SYSTEM STATUS</div>
                <div class="text-sm text-emerald-400 font-mono font-bold" id="status-text">OPERATIONAL</div>
            </div>
        </div>
    </div>

    <!-- RIGHT SIDEBAR: Metrics -->
    <div class="w-80 h-full glass z-20 flex flex-col border-l border-sky-900/20 shrink-0">
        <!-- Value Dashboard -->
        <div class="h-[40%] border-b border-sky-900/20 p-6 flex flex-col bg-gradient-to-b from-slate-900/50 to-transparent">
            <h2 class="text-[10px] font-bold text-emerald-500 tracking-widest mb-6 font-sci flex items-center gap-2">
                <span class="w-2 h-2 bg-emerald-500 rounded-sm"></span>
                VALUE REALIZED
            </h2>
            
            <div class="space-y-4">
                <div class="relative p-5 rounded-lg bg-slate-800/30 border border-slate-700/50 group hover:border-emerald-500/30 transition-colors">
                    <div class="absolute top-0 right-0 p-2 opacity-20 group-hover:opacity-40 transition-opacity">
                        <svg class="w-8 h-8 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <div class="text-[10px] text-slate-500 uppercase mb-1 tracking-wider">Cost Avoidance</div>
                    <div class="text-3xl font-mono text-white font-bold tracking-tighter flex items-center">
                        $<span id="val-savings">0</span>k
                        <span class="ml-2 text-xs text-emerald-500 bg-emerald-500/10 px-2 py-1 rounded opacity-0 transition-opacity" id="val-savings-inc">+12k</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="p-3 rounded-lg bg-slate-800/30 border border-slate-700/50">
                        <div class="text-[9px] text-slate-500 uppercase mb-1">AOG Prevented</div>
                        <div class="text-xl font-mono text-sky-400 font-bold" id="val-aog">0</div>
                    </div>
                    <div class="p-3 rounded-lg bg-slate-800/30 border border-slate-700/50">
                        <div class="text-[9px] text-slate-500 uppercase mb-1">Delay Saved</div>
                        <div class="text-xl font-mono text-indigo-400 font-bold" id="val-delay">0<span class="text-xs text-slate-500 ml-1">min</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Log -->
        <div class="flex-1 flex flex-col overflow-hidden bg-[#03060a]">
            <div class="p-3 border-b border-slate-800/50 bg-slate-900/50 flex justify-between items-center backdrop-blur">
                <span class="text-[10px] font-bold text-slate-400 font-sci tracking-widest">DATA STREAM</span>
                <div class="flex items-center gap-1.5">
                    <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></span>
                    <span class="text-[9px] text-emerald-500 font-mono">CONNECTED</span>
                </div>
            </div>
            <div id="log-container" class="flex-1 overflow-y-auto p-4 font-mono text-[10px] space-y-3 text-slate-400 scroll-smooth custom-scrollbar">
                <div class="text-slate-600 italic opacity-50">Waiting for Ontology init...</div>
            </div>
        </div>
    </div>

    <script>
        (function() {
            const canvas = document.getElementById('mainCanvas');
            const ctx = canvas.getContext('2d');
            let viewW, viewH;
            
            // Simulation Config
            const PHASE_DURATION = 6000; 
            const TOTAL_PHASES = 4;
            let startTime = null;
            let currentPhase = 0;
            
            // State
            let metrics = { savings: 0, aog: 0, delay: 0 };
            
            // Layout Coordinates
            let coords = {};

            // --- DASHBOARD STATES ---
            
            // 1. A320 Master Dashboard 
            let a320Dash = {
                gw: 64.2, // Gross Weight (Tons)
                cg: 28.5, // Center of Gravity (%)
                fob: 5.8, // Fuel on Board (Tons)
                systems: {
                    HYD: 'OK', ELEC: 'OK', PNEU: 'OK', APU: 'OFF'
                },
                strategy: 'SCHEDULED' // Maint Strategy
            };

            // 2. RR Engine Dashboard
            let engineDash = { n1: 82.5, egt: 645, vib: 0.4, status: 'NORM' };

            // 3. Route Radar
            let routeDash = { dist: 840, oat: -54, tcas: [], scanAngle: 0 };

            // 4. App Analytics
            let appDash = { health: 98, prob: 0.2, rul: 1240 };

            const COLORS = {
                bg: '#050b14',
                sky: '#38bdf8',
                skyDark: '#0c4a6e',
                emerald: '#10b981',
                emeraldDark: '#064e3b',
                red: '#ef4444',
                redDark: '#450a0a',
                indigo: '#6366f1',
                slate: '#64748b',
                white: '#f8fafc'
            };

            // Entities
            const entities = {
                sources: [], objects: [], app: null, particles: [], links: []
            };

            // --- INITIALIZATION ---
            function initScene() {
                viewW = canvas.width = canvas.offsetWidth;
                viewH = canvas.height = canvas.offsetHeight;

                // Layout Definitions
                const srcY = viewH - 80;
                const objY = viewH / 2 - 40; // Objects slightly higher to fit A320 dash below
                const appY = 80;

                coords = { srcY, objY, appY };

                // 1. Sources
                entities.sources = [
                    { x: viewW * 0.2, y: srcY, label: 'QAR (IoT)', sub: 'MQTT Stream' },
                    { x: viewW * 0.5, y: srcY, label: 'SAP (MRO)', sub: 'ERP DB' },
                    { x: viewW * 0.8, y: srcY, label: 'WMS (Parts)', sub: 'Inventory' }
                ];

                // 2. Ontology Objects
                entities.objects = [
                    { x: viewW * 0.25, y: objY, label: 'A320 Aircraft', id: 'MSN-001', r: 30, isAlert: false },
                    { x: viewW * 0.5, y: objY, label: 'V2500 Engine', id: 'ENG-02', r: 30, isAlert: false },
                    { x: viewW * 0.75, y: objY, label: 'Flight Route', id: 'FLT-882', r: 30, isAlert: false }
                ];

                // 3. App
                entities.app = { x: viewW * 0.5, y: appY, w: 200, h: 50, label: 'Predictive Maint', active: false };

                // Init TCAS
                routeDash.tcas = [{r: 18, a: 0.2, s: 0.01}, {r: 30, a: 2.5, s: -0.008}];
            }

            // --- LOOP & LOGIC ---
            function loop(timestamp) {
                if (!startTime) startTime = timestamp;
                const elapsed = timestamp - startTime;
                const cycleTime = PHASE_DURATION * TOTAL_PHASES;
                const progress = (elapsed % cycleTime) / cycleTime;
                const phaseIndex = Math.floor((elapsed % cycleTime) / PHASE_DURATION) + 1;

                if (currentPhase !== phaseIndex) {
                    currentPhase = phaseIndex;
                    updateUI(currentPhase);
                    triggerPhaseEvents(currentPhase);
                }

                updateDataValues();
                if (Math.random() < 0.03) addLog(currentPhase);

                // Drawing
                ctx.clearRect(0, 0, viewW, viewH);
                
                // 1. Links Layer (with Data Info)
                drawRichLinks(currentPhase);
                
                // 2. Base Entities
                drawSources();
                drawObjects(currentPhase, timestamp);
                
                // 3. Dashboards (The visual candy)
                if (currentPhase >= 2) {
                    drawEngineDashboard(entities.objects[1].x, entities.objects[1].y - 80);
                    drawRouteDashboard(entities.objects[2].x, entities.objects[2].y + 80);
                    // A320 Big Dashboard
                    drawA320Dashboard(entities.objects[0].x, entities.objects[0].y + 85);
                }
                
                if (currentPhase >= 3) {
                    drawAppDashboard(entities.app.x, entities.app.y + entities.app.h + 40);
                }

                drawApp(currentPhase);
                
                // 4. Particles
                updateAndDrawParticles(currentPhase);

                // UI Updates
                document.getElementById('global-progress').style.width = `${progress * 100}%`;
                document.getElementById('timer-text').innerText = (elapsed/1000).toFixed(2) + 's';

                requestAnimationFrame(loop);
            }

            function updateDataValues() {
                // Route Radar
                routeDash.scanAngle += 0.08;
                routeDash.tcas.forEach(b => b.a += b.s);

                // A320 Dash Logic
                a320Dash.gw -= 0.001; // Burning fuel
                a320Dash.fob -= 0.001;

                if (currentPhase === 3) { // ALERT
                    engineDash.status = 'SURGE';
                    engineDash.egt = 920 + Math.random() * 80;
                    engineDash.n1 = 80 + Math.random() * 5;
                    
                    appDash.health += (45 - appDash.health) * 0.1;
                    appDash.prob = 0.92;

                    a320Dash.systems.HYD = 'WARN'; // Simulated cascading issue
                    a320Dash.strategy = 'CONDITION-BASED'; // Strategy shift
                } else if (currentPhase === 4) { // FIX
                    engineDash.status = 'RECOVER';
                    engineDash.egt += (645 - engineDash.egt) * 0.05;
                    
                    appDash.health += (98 - appDash.health) * 0.05;
                    appDash.prob = 0.05;

                    a320Dash.systems.HYD = 'OK';
                    a320Dash.strategy = 'MAINT-PENDING';
                } else { // NORMAL
                    engineDash.status = 'NORM';
                    engineDash.egt = 645 + Math.random()*5;
                    
                    appDash.health = 99;
                    appDash.prob = 0.01;

                    a320Dash.systems.HYD = 'OK';
                    a320Dash.strategy = 'SCHEDULED';
                }
            }

            // --- DRAWING: NEW DASHBOARDS ---

            // 1. A320 MASTER DASHBOARD
            function drawA320Dashboard(cx, cy) {
                const w = 180;
                const h = 110;
                const x = cx - w/2;
                const y = cy - h/2;

                // Connector
                ctx.beginPath();
                ctx.moveTo(cx, y);
                ctx.lineTo(cx, entities.objects[0].y + entities.objects[0].r);
                ctx.strokeStyle = 'rgba(56, 189, 248, 0.4)';
                ctx.stroke();

                // Glass Panel Body
                ctx.save();
                ctx.fillStyle = 'rgba(15, 23, 42, 0.9)';
                ctx.strokeStyle = a320Dash.systems.HYD === 'WARN' ? COLORS.red : COLORS.sky;
                ctx.lineWidth = 1;
                ctx.shadowColor = a320Dash.systems.HYD === 'WARN' ? 'rgba(239, 68, 68, 0.3)' : 'rgba(56, 189, 248, 0.2)';
                ctx.shadowBlur = 15;
                
                ctx.beginPath();
                ctx.roundRect(x, y, w, h, 6);
                ctx.fill();
                ctx.stroke();
                ctx.restore();

                // Header
                ctx.fillStyle = '#94a3b8';
                ctx.font = 'bold 9px Orbitron';
                ctx.fillText('AIRCRAFT STATUS // A320-200', x + 10, y + 15);
                
                // Divider
                ctx.fillStyle = '#334155';
                ctx.fillRect(x + 10, y + 20, w - 20, 1);

                // Section 1: Systems Grid
                const sysY = y + 35;
                const sysKeys = Object.keys(a320Dash.systems);
                sysKeys.forEach((key, i) => {
                    const status = a320Dash.systems[key];
                    const kx = x + 15 + (i * 40);
                    
                    ctx.fillStyle = '#64748b';
                    ctx.font = '8px Inter';
                    ctx.fillText(key, kx, sysY);

                    // Status Light
                    const color = status === 'OK' ? COLORS.emerald : (status === 'OFF' ? COLORS.slate : COLORS.red);
                    ctx.fillStyle = color;
                    ctx.fillRect(kx, sysY + 4, 25, 4);
                });

                // Section 2: Flight Data (GW, CG, FOB)
                const dataY = y + 60;
                ctx.fillStyle = '#94a3b8';
                ctx.font = '8px Inter';
                ctx.fillText(`GW: ${a320Dash.gw.toFixed(1)} T`, x + 15, dataY);
                ctx.fillText(`CG: ${a320Dash.cg.toFixed(1)} %`, x + 80, dataY);
                ctx.fillText(`FOB: ${a320Dash.fob.toFixed(1)} T`, x + 130, dataY);

                // Section 3: Maintenance Strategy (Footer)
                ctx.fillStyle = '#1e293b';
                ctx.fillRect(x + 6, y + 85, w - 12, 18);
                
                ctx.fillStyle = '#64748b';
                ctx.fillText("POLICY:", x + 12, y + 97);
                
                ctx.fillStyle = a320Dash.strategy === 'CONDITION-BASED' ? COLORS.red : COLORS.sky;
                ctx.font = 'bold 9px JetBrains Mono';
                ctx.textAlign = 'right';
                ctx.fillText(a320Dash.strategy, x + w - 12, y + 97);
                ctx.textAlign = 'left'; // Reset
            }

            // 2. Rich Links (With Data Packets)
            function drawRichLinks(phase) {
                if (phase < 2) return;

                const drawLink = (start, end, label) => {
                    // Line
                    ctx.beginPath();
                    ctx.moveTo(start.x, start.y);
                    ctx.lineTo(end.x, end.y);
                    ctx.strokeStyle = 'rgba(56, 189, 248, 0.15)';
                    ctx.lineWidth = 1;
                    ctx.stroke();

                    // Data Info Tag (Static)
                    const mx = (start.x + end.x) / 2;
                    const my = (start.y + end.y) / 2;
                    
                    ctx.fillStyle = '#0f172a';
                    ctx.fillRect(mx - 20, my - 6, 40, 12);
                    ctx.strokeStyle = '#1e293b';
                    ctx.strokeRect(mx - 20, my - 6, 40, 12);
                    
                    ctx.fillStyle = '#64748b';
                    ctx.font = '8px JetBrains Mono';
                    ctx.textAlign = 'center';
                    ctx.fillText(label, mx, my + 3);
                    ctx.textAlign = 'left';
                };

                // Link Objects
                drawLink(entities.objects[0], entities.objects[1], "CAN-BUS");
                drawLink(entities.objects[0], entities.objects[2], "SAT-COM");
                
                // Link Objects to App (Phase 3+)
                if (phase >= 3) {
                    ctx.setLineDash([4, 4]);
                    drawLink(entities.objects[1], {x: entities.app.x, y: entities.app.y + entities.app.h}, "TLS 1.3");
                    ctx.setLineDash([]);
                }
            }

            // 3. RR Engine Dash
            function drawEngineDashboard(cx, cy) {
                const r = 40;
                ctx.beginPath(); ctx.moveTo(cx, cy + r); ctx.lineTo(entities.objects[1].x, entities.objects[1].y - entities.objects[1].r);
                ctx.strokeStyle = 'rgba(255,255,255,0.1)'; ctx.stroke();

                // Body
                ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2);
                ctx.fillStyle = '#0f172a'; ctx.strokeStyle = engineDash.status === 'SURGE' ? COLORS.red : '#334155';
                ctx.lineWidth = 2; ctx.fill(); ctx.stroke();

                // Values
                drawGauge(cx, cy, r-5, engineDash.n1, 100, COLORS.sky);
                ctx.fillStyle = engineDash.status === 'SURGE' ? COLORS.red : COLORS.sky;
                ctx.font = 'bold 12px Mono'; ctx.textAlign = 'center';
                ctx.fillText(engineDash.n1.toFixed(1), cx, cy + 5);
                
                ctx.font = '8px Inter'; ctx.fillStyle = '#64748b';
                ctx.fillText('N1 RPM', cx, cy - 15);
                ctx.fillText(`EGT ${Math.floor(engineDash.egt)}`, cx, cy + 20);
            }

            function drawGauge(x, y, r, val, max, color) {
                const start = Math.PI * 0.75; const end = Math.PI * 2.25;
                const curr = start + (val/max)*(end-start);
                ctx.beginPath(); ctx.arc(x, y, r, start, end); ctx.strokeStyle = '#1e293b'; ctx.stroke();
                ctx.beginPath(); ctx.arc(x, y, r, start, curr); ctx.strokeStyle = color; ctx.stroke();
            }

            // 4. Route Radar
            function drawRouteDashboard(cx, cy) {
                const w = 90; const h = 60;
                ctx.beginPath(); ctx.moveTo(cx, cy - h/2); ctx.lineTo(entities.objects[2].x, entities.objects[2].y + entities.objects[2].r);
                ctx.strokeStyle = 'rgba(255,255,255,0.1)'; ctx.stroke();

                ctx.fillStyle = '#020617'; ctx.strokeStyle = COLORS.emerald; ctx.lineWidth = 1;
                ctx.beginPath(); ctx.roundRect(cx - w/2, cy - h/2, w, h, 4); ctx.fill(); ctx.stroke();

                // Radar scan
                const rx = cx - 20; const ry = cy;
                ctx.beginPath(); ctx.moveTo(rx, ry); ctx.arc(rx, ry, 22, routeDash.scanAngle, routeDash.scanAngle+0.5); ctx.lineTo(rx, ry);
                ctx.fillStyle = 'rgba(16, 185, 129, 0.2)'; ctx.fill();

                // Text
                ctx.fillStyle = '#fff'; ctx.font = '9px Mono'; ctx.textAlign = 'left';
                ctx.fillText(`DIST ${Math.floor(routeDash.dist)}`, cx + 10, cy - 10);
                ctx.fillText(`OAT ${routeDash.oat}`, cx + 10, cy + 5);
            }

            // 5. App Analytics
            function drawAppDashboard(cx, cy) {
                const spacing = 60;
                // Connector
                ctx.beginPath(); ctx.moveTo(cx, cy - 20); ctx.lineTo(cx, entities.app.y + entities.app.h);
                ctx.strokeStyle = COLORS.sky; ctx.stroke();

                drawDial(cx - spacing, cy, "HEALTH", appDash.health, "%", appDash.health < 60 ? COLORS.red : COLORS.emerald);
                drawDial(cx, cy, "FAIL PROB", (appDash.prob*100).toFixed(0), "%", appDash.prob > 0.5 ? COLORS.red : COLORS.sky);
                drawDial(cx + spacing, cy, "RUL", Math.floor(appDash.rul), "H", COLORS.indigo);
            }

            function drawDial(x, y, lbl, val, unit, c) {
                ctx.beginPath(); ctx.arc(x, y, 20, 0, Math.PI*2);
                ctx.fillStyle = 'rgba(15,23,42,0.8)'; ctx.strokeStyle = c; ctx.lineWidth = 2; ctx.fill(); ctx.stroke();
                ctx.fillStyle = '#fff'; ctx.textAlign = 'center'; ctx.font = 'bold 10px Mono'; ctx.fillText(val, x, y+3);
                ctx.fillStyle = '#64748b'; ctx.font = '7px Inter'; ctx.fillText(lbl, x, y-26);
            }

            // --- BASE ENTITIES ---
            function drawSources() {
                entities.sources.forEach(s => {
                    ctx.fillStyle = '#0f172a'; ctx.strokeStyle = '#334155';
                    ctx.beginPath(); ctx.roundRect(s.x - 50, s.y - 20, 100, 35, 4); ctx.fill(); ctx.stroke();
                    ctx.fillStyle = '#94a3b8'; ctx.font = '10px Inter'; ctx.textAlign = 'center'; ctx.fillText(s.label, s.x, s.y - 5);
                    ctx.fillStyle = '#475569'; ctx.font = '8px Mono'; ctx.fillText(s.sub, s.x, s.y + 8);
                });
            }

            function drawObjects(phase, time) {
                entities.objects.forEach(o => {
                    const isActive = phase >= 1;
                    const isAlert = o.isAlert || (o.id === 'ENG-02' && engineDash.status === 'SURGE');
                    if(isActive) {
                        const pulse = Math.sin(time/300)*5;
                        ctx.beginPath(); ctx.arc(o.x, o.y, o.r + 8 + pulse, 0, Math.PI*2);
                        ctx.fillStyle = isAlert ? 'rgba(239,68,68,0.2)' : 'rgba(56,189,248,0.1)'; ctx.fill();
                    }
                    ctx.beginPath(); ctx.arc(o.x, o.y, o.r, 0, Math.PI*2);
                    ctx.fillStyle = isAlert ? '#450a0a' : '#0f172a'; ctx.strokeStyle = isAlert ? COLORS.red : COLORS.sky;
                    ctx.lineWidth = 2; ctx.fill(); ctx.stroke();
                    ctx.fillStyle = '#fff'; ctx.font = 'bold 11px Inter'; ctx.textAlign = 'center'; ctx.fillText(o.label, o.x, o.y + 4);
                });
            }

            function drawApp(phase) {
                const app = entities.app;
                const active = phase >= 3;
                const action = phase === 4;
                
                ctx.fillStyle = '#0f172a'; ctx.strokeStyle = active ? (action ? COLORS.emerald : COLORS.red) : '#334155';
                ctx.lineWidth = 2;
                ctx.beginPath(); ctx.roundRect(app.x - app.w/2, app.y, app.w, app.h, 6); ctx.fill(); ctx.stroke();
                ctx.fillStyle = '#fff'; ctx.font = 'bold 12px Inter'; ctx.textAlign = 'center'; ctx.fillText(app.label, app.x, app.y + 20);
                
                if(active) {
                    ctx.font = '9px Mono'; ctx.fillStyle = action ? COLORS.emerald : COLORS.red;
                    ctx.fillText(action ? "[OPTIMIZATION APPLIED]" : "[ANOMALY DETECTED]", app.x, app.y + 35);
                }
            }

            // --- PARTICLES (Enhanced with Data Text) ---
            function updateAndDrawParticles(phase) {
                // Spawn
                if (Math.random() < 0.06) {
                    let start, end, color, type = 'dot';
                    if (phase === 1) {
                        start = entities.sources[Math.floor(Math.random()*3)];
                        end = entities.objects[Math.floor(Math.random()*3)];
                        color = COLORS.sky;
                        if(Math.random() < 0.3) type = 'text'; // Text packet
                    } else if (phase >= 2) {
                        start = entities.objects[Math.floor(Math.random()*3)];
                        end = { x: entities.app.x, y: entities.app.y + entities.app.h };
                        color = (start.isAlert || phase===3) ? COLORS.red : COLORS.sky;
                    }

                    if (start && end) {
                        entities.particles.push({
                            x: start.x, y: start.y, tx: end.x, ty: end.y,
                            color, size: 2, speed: 0.015 + Math.random()*0.01, 
                            progress: 0, type, 
                            label: ['JSON', 'XML', 'BIN'][Math.floor(Math.random()*3)]
                        });
                    }
                }

                // Action Particle
                if (phase === 4 && Math.random() < 0.02) {
                     entities.particles.push({
                        x: entities.app.x, y: entities.app.y + entities.app.h,
                        tx: entities.sources[1].x, ty: entities.sources[1].y,
                        color: COLORS.emerald, size: 4, speed: 0.03, progress: 0, type: 'action'
                    });
                }

                // Update & Draw
                for (let i = entities.particles.length - 1; i >= 0; i--) {
                    const p = entities.particles[i];
                    p.progress += p.speed;
                    const cx = p.x + (p.tx - p.x) * p.progress;
                    const cy = p.y + (p.ty - p.y) * p.progress;
                    
                    if (p.type === 'text') {
                        // Draw Text Packet
                        ctx.fillStyle = p.color;
                        ctx.font = '9px Mono';
                        ctx.fillText(p.label, cx, cy);
                    } else {
                        // Draw Dot
                        ctx.beginPath();
                        ctx.arc(cx, cy, p.size, 0, Math.PI*2);
                        ctx.fillStyle = p.color;
                        ctx.fill();
                    }
                    
                    if (p.progress >= 1) entities.particles.splice(i, 1);
                }
            }

            // --- UI ---
            function triggerPhaseEvents(phase) {
                if (phase === 1) {
                    entities.objects.forEach(o => o.isAlert = false);
                    setStatus('OPERATIONAL', 'bg-emerald-500', 'text-emerald-400');
                } else if (phase === 3) {
                    setStatus('CRITICAL ALERT', 'bg-red-500 animate-ping', 'text-red-500');
                } else if (phase === 4) {
                    setStatus('OPTIMIZING', 'bg-sky-500', 'text-sky-400');
                    updateMetrics();
                }
            }

            function setStatus(text, dotClass, textClass) {
                document.getElementById('status-text').innerText = text;
                document.getElementById('status-text').className = `text-sm font-mono font-bold ${textClass}`;
                document.getElementById('status-dot').className = `relative inline-flex rounded-full h-3 w-3 ${dotClass.split(' ')[0]}`;
                document.getElementById('system-badge').className = `absolute top-6 left-8 glass px-4 py-2 rounded border-l-4 ${textClass.replace('text', 'border')} transition-all duration-500 flex items-center gap-4 z-20`;
            }

            function updateMetrics() {
                metrics.savings += 12; metrics.aog += 1; metrics.delay += 35;
                document.getElementById('val-savings').innerText = metrics.savings;
                document.getElementById('val-aog').innerText = metrics.aog;
                document.getElementById('val-delay').innerText = metrics.delay;
                
                const inc = document.getElementById('val-savings-inc');
                inc.style.opacity = 1; setTimeout(() => inc.style.opacity = 0, 1500);
            }

            function addLog(phase) {
                const logs = document.getElementById('log-container');
                if (logs.children.length > 10) logs.removeChild(logs.firstElementChild);
                const div = document.createElement('div');
                div.className = 'log-entry text-slate-500 mb-1';
                let txt = phase===1 ? "INGEST: PACKET RECEIVED" : (phase===2 ? "LINK: GRAPH UPDATED" : (phase===3 ? "WARN: HIGH PRIORITY" : "ACTION: SAP SYNC"));
                div.innerText = `> ${txt}`;
                logs.appendChild(div); logs.scrollTop = logs.scrollHeight;
            }

            function updateUI(phase) {
                document.querySelectorAll('.step-item').forEach(el => el.classList.remove('active'));
                const el = document.getElementById(`step-${phase}`);
                if(el) el.classList.add('active');
            }

            document.getElementById('restartBtn').onclick = () => {
                startTime = null; currentPhase = 0; metrics = {savings:0, aog:0, delay:0}; initScene();
            };
            
            window.addEventListener('resize', initScene);
            initScene();
            requestAnimationFrame(loop);
        })();
    </script>
</body>
</html>
