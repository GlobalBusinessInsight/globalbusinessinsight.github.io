<!DOCTYPE html>
<html lang="zh-CN" class="scroll-smooth">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6214772877334340"
     crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>电动重卡运输报价及成本测算系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Professional Neutrals (Slate) with Blue/Indigo Accents -->
    <!-- Application Structure Plan: The application is now a multi-tab system: "Quote & Cost", "Profit Analysis", "Cash Flow", and "Benchmarking". This modular design cleanly separates distinct functionalities. Interactive inputs are central to all tabs, allowing for dynamic simulation. This structure transforms the tool from a simple calculator into a comprehensive decision-support dashboard. -->
    <!-- Visualization & Content Choices: Cost/Quote -> Interactive inputs and a dynamic doughnut chart with datalabels. Profit Analysis -> Sliders for what-if analysis directly manipulating a profit margin gauge. Cash Flow -> Time-series inputs generating a cumulative cash flow line chart. Benchmarking -> An input triggers an API call (simulated) to fetch and display market data in cards. This approach uses the best interactive element for each specific analytical task. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
            color: #1e293b; /* slate-800 */
        }
        .main-tab {
            transition: all 0.2s ease-in-out;
            border-bottom: 3px solid transparent;
        }
        .main-tab.active {
            border-color: #4f46e5; /* indigo-600 */
            color: #4f46e5;
        }
        .condition-btn {
            transition: all 0.2s ease-in-out;
        }
        .condition-btn.active {
            background-color: #3b82f6; /* blue-600 */
            color: #ffffff;
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07);
        }
        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.25rem;
            margin-bottom: 1.5rem;
        }
        .input-field label {
            display: block;
            font-weight: 500;
            color: #475569; /* slate-600 */
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
        }
        .input-field input, .input-field select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #cbd5e1; /* slate-300 */
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        .calc-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e2e8f0; /* slate-200 */
        }
        .calc-label { font-weight: 500; color: #475569; }
        .calc-value { font-weight: 600; color: #1e293b; }
        .calc-formula { font-size: 0.75rem; color: #94a3b8; text-align: right; }
        
        .slider-group label { display: block; margin-bottom: 0.5rem; font-weight: 500;}
        .slider-group input[type="range"] { width: 100%;}
        .slider-group .slider-value { font-weight: bold; color: #3b82f6; }
        .investment-batch {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">电动重卡运输报价及成本测算系统</h1>
            <p class="mt-3 max-w-2xl mx-auto text-md text-slate-600">一个集报价、成本、毛利、现金流及行业对标于一体的综合决策支持工具。</p>
        </header>

        <div class="w-full max-w-7xl mx-auto">
            <div class="mb-8 border-b border-slate-300">
                <nav class="flex space-x-8 -mb-px" aria-label="Tabs">
                    <button data-view="cost-quote" class="main-tab active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">报价与成本</button>
                    <button data-view="profit" class="main-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">毛利分析</button>
                    <button data-view="cashflow" class="main-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">现金流模拟</button>
                    <button data-view="benchmark" class="main-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">行业对标</button>
                </nav>
            </div>
            <div id="content-view"></div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            Chart.register(ChartDataLabels);

            const mainTabs = document.querySelectorAll('.main-tab');
            const contentView = document.getElementById('content-view');
            let currentView = 'cost-quote';
            let appState = {
                quoteParams: null,
                internalParams: null,
                quoteResult: null,
                internalResult: null,
                cashflowResults: null
            };
            let charts = {};

            const DEFAULT_PARAMS = {
                quote: {
                    title: "客户报价单",
                    values: {
                        tractionHeadCost: 450000, trailerCost: 80000, depreciationYears: 3, depreciationRate: 0.95,
                        tripDays: 2, driverDailySalary: 600, insurancePerYear: 25000, workDaysPerYear: 310,
                        managementCost3Years: 180000, electricityPrice: 0.6, serviceFee: 0.3,
                        maintenancePerKm: 0.5, payloadTons: 33, tripDistanceOneWay: 480,
                        heavyLoadOutbound: 1.6, motherSonReturn: 0.8
                    }
                },
                internal: {
                    title: "内部成本估算",
                    values: {
                        tractionHeadCost: 450000, trailerCost: 80000, depreciationYears: 5, depreciationRate: 1.0,
                        tripDays: 1.5, driverDailySalary: 600, insurancePerYear: 25000, workDaysPerYear: 310,
                        managementCost3Years: 180000, electricityPrice: 0.45, serviceFee: 0.3,
                        maintenancePerKm: 0.5, payloadTons: 33, tripDistanceOneWay: 480,
                        heavyLoadOutbound: 1.6, motherSonReturn: 0.8
                    }
                }
            };
            
            const ENERGY_WINTER_MULTIPLIER = 1.25;

            function calculateCosts(params, condition) {
                const winterMultiplier = condition === 'winter' ? ENERGY_WINTER_MULTIPLIER : 1.0;
                
                const heavyLoadConsumption = params.heavyLoadOutbound * winterMultiplier;
                const motherSonReturnConsumption = params.motherSonReturn * winterMultiplier;

                const vehicleCost = params.tractionHeadCost + params.trailerCost;
                const totalEnergyKwh = (params.tripDistanceOneWay * heavyLoadConsumption) + (params.tripDistanceOneWay * motherSonReturnConsumption);
                const comprehensiveElectricityPrice = params.electricityPrice + params.serviceFee;
                const totalEnergyCost = totalEnergyKwh * comprehensiveElectricityPrice;
                
                const maintenanceCost = params.tripDistanceOneWay * 2 * params.maintenancePerKm;
                const driverCost = params.driverDailySalary * params.tripDays;
                const dailyDepreciation = (params.workDaysPerYear > 0 && params.depreciationYears > 0) ? (vehicleCost * params.depreciationRate / params.depreciationYears) / params.workDaysPerYear : 0;
                const depreciationCost = dailyDepreciation * params.tripDays;
                const dailyInsurance = params.insurancePerYear / 365;
                const insuranceCost = dailyInsurance * params.tripDays;
                const dailyManagement = (params.workDaysPerYear > 0) ? (params.managementCost3Years / 3) / params.workDaysPerYear : 0;
                const managementCost = dailyManagement * params.tripDays;

                const costs = {
                    energy: totalEnergyCost,
                    maintenance: maintenanceCost,
                    driver: driverCost,
                    depreciation: depreciationCost,
                    insurance: insuranceCost,
                    management: managementCost,
                };
                
                costs.total = Object.values(costs).reduce((sum, val) => sum + val, 0);
                costs.perTon = costs.total / (params.payloadTons || 1);
                costs.perTonKm = costs.perTon / (params.tripDistanceOneWay || 1);
                
                costs.formulas = {
                    energy: `(${totalEnergyKwh.toFixed(0)} kWh * ${comprehensiveElectricityPrice.toFixed(2)}元)`,
                    maintenance: `(${params.tripDistanceOneWay * 2} km * ${params.maintenancePerKm.toFixed(2)}元)`,
                    driver: `(${params.driverDailySalary}元 * ${params.tripDays}天)`,
                    depreciation: `(${vehicleCost/10000}万*${params.depreciationRate*100}%÷${params.depreciationYears}年÷${params.workDaysPerYear}天)*${params.tripDays}天`,
                    insurance: `(${params.insurancePerYear/10000}万÷365天)*${params.tripDays}天`,
                    management: `(${params.managementCost3Years/10000}万÷3年÷${params.workDaysPerYear}天)*${params.tripDays}天`,
                };

                return costs;
            }

            function renderCostQuoteView() {
                const viewHTML = `
                    <div class="grid lg:grid-cols-2 gap-8 xl:gap-12">
                        ${renderSingleCalculator('quote', '客户报价单')}
                        ${renderSingleCalculator('internal', '内部成本估算')}
                    </div>
                    <div class="mt-8 flex justify-end space-x-4">
                        <button id="export-quote-btn" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">导出报价 (Excel)</button>
                        <button id="export-internal-btn" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">导出成本 (Excel)</button>
                        <button id="export-all-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">全部导出 (Excel)</button>
                    </div>
                `;
                contentView.innerHTML = viewHTML;
                ['quote', 'internal'].forEach(type => {
                    updateSingleCalculator(type, 'standard');
                    attachCalculatorEventListeners(type);
                });
                attachExportEventListeners();
            }
            
            function renderSingleCalculator(type, title) {
                const model = DEFAULT_PARAMS[type];
                return `
                    <div id="${type}-calculator" class="card p-6">
                        <h2 class="text-2xl font-bold text-slate-800 mb-4">${title}</h2>
                        <div class="grid xl:grid-cols-2 gap-6">
                            <div id="${type}-inputs-container">
                                <h3 class="font-bold text-lg mb-4 border-b pb-2">参数输入</h3>
                                <div class="input-group">
                                    ${Object.entries(model.values).map(([id, value]) => renderInputField(type, id, id, value)).join('')}
                                </div>
                            </div>
                            <div id="${type}-outputs-container">
                                <div class="mb-4">
                                    <div class="flex rounded-lg shadow-sm w-full max-w-xs">
                                        <button data-type="${type}" data-condition="standard" class="condition-btn active flex-1 px-4 py-2 text-sm font-medium rounded-l-md">标准</button>
                                        <button data-type="${type}" data-condition="winter" class="condition-btn flex-1 px-4 py-2 text-sm font-medium rounded-r-md">冬季</button>
                                    </div>
                                </div>
                                <div id="${type}-calculation-results"></div>
                                <div class="chart-container h-64 mt-4"><canvas id="${type}-chart"></canvas></div>
                            </div>
                        </div>
                    </div>
                `;
            }

            function renderInputField(type, id, label, value) {
                const labels = {
                    tripDistanceOneWay: '运输距离 (km)', tractionHeadCost: '牵引头成本 (元)', trailerCost: '挂车成本 (元)',
                    depreciationYears: '折旧年限 (年)', depreciationRate: '折旧率 (%)', tripDays: '单次任务天数',
                    driverDailySalary: '司机日薪 (元)', electricityPrice: '电价 (元/度)', serviceFee: '服务费 (元/度)',
                    maintenancePerKm: '维保 (元/km)', managementCost3Years: '管理成本 (元/3年)', workDaysPerYear: '年工作天数',
                    insurancePerYear: '年保险 (元)', payloadTons: '载重 (吨)',
                    heavyLoadOutbound: '重载去程能耗 (kWh/km)', motherSonReturn: '子母车返程能耗 (kWh/km)'
                };
                const step = (id.includes('Price') || id.includes('Fee') || id.includes('PerKm') || id.includes('Days') || id.includes('heavy') || id.includes('mother')) ? 0.01 : 1;
                const displayValue = id === 'depreciationRate' ? value * 100 : value;
                return `<div class="input-field"><label for="${type}-${id}">${labels[id]}</label><input type="number" id="${type}-${id}" value="${displayValue}" step="${step}"></div>`;
            }

            function renderCalculationResults(type, costs) {
                const container = document.getElementById(`${type}-calculation-results`);
                const scenarioTitle = document.querySelector(`#${type}-outputs-container .condition-btn.active`).textContent;
                const resultsHTML = `
                    <h3 class="font-bold text-lg mb-2">${scenarioTitle} - 成本明细</h3>
                    <div class="space-y-2 text-sm">
                        ${Object.keys(costs).filter(k => !['total', 'perTon', 'perTonKm', 'formulas'].includes(k)).map(key => renderCalcRow(key, costs[key], costs.formulas[key])).join('')}
                    </div>
                    <div class="mt-4 pt-4 border-t-2 border-slate-200 space-y-2 font-semibold">
                        ${renderTotalRow('单车单次任务总成本', costs.total, 'text-blue-600 text-xl')}
                        ${renderTotalRow('单位吨煤成本', costs.perTon)}
                        ${renderTotalRow('单位吨公里成本', costs.perTonKm)}
                    </div>`;
                container.innerHTML = resultsHTML;
                updateCostChart(type, costs);
            }
            
            function renderCalcRow(label, value, formula) {
                const labels = { energy: '能源成本', maintenance: '维修及轮胎', driver: '司机成本', depreciation: '车辆折旧', insurance: '保险费用', management: '管理成本' };
                return `
                    <div class="calc-row">
                        <span class="calc-label">${labels[label]}</span>
                        <div>
                            <span class="calc-value">${value.toFixed(2)} 元</span>
                            <p class="calc-formula">${formula}</p>
                        </div>
                    </div>`;
            }

            function renderTotalRow(label, value, customClass = '') {
                const unit = label.includes('吨公里') ? '元/吨·公里' : (label.includes('吨') ? '元/吨' : '元');
                return `<div class="flex justify-between items-center"><span class="text-slate-800">${label}</span><span class="calc-value ${customClass}">${value.toFixed(2)} ${unit}</span></div>`;
            }

            function updateCostChart(type, costs) {
                const chartCtx = document.getElementById(`${type}-chart`).getContext('2d');
                const chartData = {
                    labels: ['能源', '司机', '折旧', '维修', '管理', '保险'],
                    datasets: [{
                        data: [costs.energy, costs.driver, costs.depreciation, costs.maintenance, costs.management, costs.insurance],
                        backgroundColor: ['#3b82f6', '#f59e0b', '#8b5cf6', '#10b981', '#ec4899', '#64748b'],
                    }]
                };
                if (charts[type]) charts[type].destroy();
                charts[type] = new Chart(chartCtx, {
                    type: 'pie',
                    data: chartData,
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                formatter: (value, ctx) => {
                                    let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    if (sum === 0) return '0%';
                                    let percentage = (value * 100 / sum).toFixed(1) + "%";
                                    return `${ctx.chart.data.labels[ctx.dataIndex]}\n${percentage}\n${Math.round(value)}元`;
                                },
                                color: '#fff',
                                font: { weight: 'bold', size: 10 }
                            }
                        }
                    }
                });
            }

            function gatherInputs(type) {
                const params = {};
                const inputs = document.querySelectorAll(`#${type}-inputs-container input`);
                inputs.forEach(input => {
                    const id = input.id.split('-')[1];
                    let value = parseFloat(input.value) || 0;
                    if (id === 'depreciationRate') value /= 100;
                    params[id] = value;
                });
                return params;
            }

            function updateSingleCalculator(type, condition) {
                const params = gatherInputs(type);
                const costs = calculateCosts(params, condition);
                appState[`${type}Params`] = params;
                appState[`${type}Result`] = costs;
                renderCalculationResults(type, costs);
            }
            
            function attachCalculatorEventListeners(type) {
                document.querySelectorAll(`#${type}-inputs-container input`).forEach(input => {
                    input.addEventListener('input', () => {
                        const activeCondition = document.querySelector(`#${type}-outputs-container .condition-btn.active`).dataset.condition;
                        updateSingleCalculator(type, activeCondition);
                    });
                });
                document.querySelectorAll(`#${type}-outputs-container .condition-btn`).forEach(btn => {
                    btn.addEventListener('click', () => {
                        const condition = btn.dataset.condition;
                        document.querySelectorAll(`#${type}-outputs-container .condition-btn`).forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        updateSingleCalculator(type, condition);
                    });
                });
            }
            
            function renderProfitView() {
                const viewHTML = `
                    <div class="card p-6 md:p-8">
                        <div class="grid lg:grid-cols-2 gap-8 xl:gap-12">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800 mb-4">毛利模拟 (What-If分析)</h2>
                                <p class="text-slate-600 mb-6">调整下方关键成本驱动因素，实时观察其对标准工况下毛利率的影响。</p>
                                <div id="profit-sliders" class="space-y-6">
                                    ${renderSlider('quote_total', '报价总额 (元)', (appState.internalResult?.total || 0), (appState.quoteResult?.total || 0) * 1.5, 10, appState.quoteResult?.total || 0)}
                                    ${renderSlider('internal_electricityPrice', '内部综合电价', 0.5, 1.5, 0.01, (appState.internalParams?.electricityPrice || 0) + (appState.internalParams?.serviceFee || 0))}
                                    ${renderSlider('internal_driverDailySalary', '内部司机日薪', 400, 1000, 10, appState.internalParams?.driverDailySalary || 0)}
                                </div>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg mb-4 text-center">毛利分析结果 (标准工况)</h3>
                                <div id="profit-results" class="text-center"></div>
                                <div class="chart-container h-64 mt-4">
                                    <canvas id="profitChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>`;
                contentView.innerHTML = viewHTML;
                updateProfitAnalysis();
                attachProfitEventListeners();
            }

            function renderSlider(id, label, min, max, step, value) {
                return `
                    <div class="slider-group">
                        <label for="${id}-slider">${label}: <span id="${id}-value" class="slider-value">${parseFloat(value).toFixed(2)}</span></label>
                        <input type="range" id="${id}-slider" min="${min}" max="${max}" step="${step}" value="${value}" class="w-full">
                    </div>`;
            }

            function updateProfitAnalysis() {
                if (!document.getElementById('quote_total-slider')) return;
                
                let quoteTotal = parseFloat(document.getElementById('quote_total-slider').value);
                let newElecPrice = parseFloat(document.getElementById('internal_electricityPrice-slider').value);
                let newDriverSalary = parseFloat(document.getElementById('internal_driverDailySalary-slider').value);

                document.getElementById('quote_total-value').textContent = quoteTotal.toFixed(0);
                document.getElementById('internal_electricityPrice-value').textContent = newElecPrice.toFixed(2);
                document.getElementById('internal_driverDailySalary-value').textContent = newDriverSalary.toFixed(0);

                let simulatedInternalParams = { ...appState.internalParams };
                simulatedInternalParams.electricityPrice = newElecPrice - (appState.internalParams.serviceFee || 0);
                simulatedInternalParams.driverDailySalary = newDriverSalary;

                const internalResult = calculateCosts(simulatedInternalParams, 'standard');
                const grossProfit = quoteTotal - internalResult.total;
                const profitMargin = (quoteTotal > 0) ? (grossProfit / quoteTotal) * 100 : 0;

                document.getElementById('profit-results').innerHTML = `
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div><p class="text-sm text-slate-500">报价总额</p><p class="text-2xl font-bold">${quoteTotal.toFixed(0)}</p></div>
                        <div><p class="text-sm text-slate-500">成本总额</p><p class="text-2xl font-bold">${internalResult.total.toFixed(0)}</p></div>
                        <div><p class="text-sm text-slate-500">毛利润</p><p class="text-2xl font-bold text-green-600">${grossProfit.toFixed(0)}</p></div>
                    </div>
                    <div class="mt-6"><p class="text-lg">毛利率: <span class="text-3xl font-bold text-indigo-600">${profitMargin.toFixed(1)}%</span></p></div>
                `;

                const profitChartCtx = document.getElementById('profitChart').getContext('2d');
                const chartData = {
                    labels: ['内部成本', '毛利润'],
                    datasets: [{
                        data: [internalResult.total, grossProfit > 0 ? grossProfit : 0],
                        backgroundColor: ['#64748b', '#16a34a'],
                    }]
                };
                if (charts.profit) charts.profit.destroy();
                charts.profit = new Chart(profitChartCtx, { type: 'doughnut', data: chartData, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
            }
            
            function attachProfitEventListeners() {
                document.querySelectorAll('#profit-sliders input[type="range"]').forEach(slider => {
                    slider.addEventListener('input', updateProfitAnalysis);
                });
            }

            function renderCashflowView() {
                const viewHTML = `
                     <div class="card p-6 md:p-8">
                        <h2 class="text-2xl font-bold text-slate-800 mb-4">现金流模拟</h2>
                        <div class="grid lg:grid-cols-2 gap-8 xl:gap-12">
                            <div>
                                <div id="cashflow-inputs">
                                    <h3 class="font-bold text-lg mb-4 border-b pb-2">资本投资计划 (CapEx)</h3>
                                    <div id="investment-batches" class="space-y-4 mb-4"></div>
                                    <button id="add-investment-batch" class="text-sm px-4 py-2 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200 mb-6">+ 添加投资批次</button>

                                    <h3 class="font-bold text-lg mb-4 border-b pb-2">运营收入与支出</h3>
                                    <div class="input-group">
                                        <div class="input-field"><label for="cf-tripsPerMonth">月均运输次数/车</label><input type="number" id="cf-tripsPerMonth" value="10"></div>
                                        <div class="input-field">
                                            <label for="cf-paymentCycleSelect">客户回款周期</label>
                                            <select id="cf-paymentCycleSelect"><option value="7">周结</option><option value="30" selected>月结</option><option value="90">季结</option><option value="custom">自定义</option></select>
                                        </div>
                                        <div class="input-field hidden" id="cf-paymentCycleCustom-wrapper"><label for="cf-paymentCycleCustom">自定义天数</label><input type="number" id="cf-paymentCycleCustom" value="45"></div>
                                        <div class="input-field">
                                            <label for="cf-salaryCycleSelect">司机工资支付周期</label>
                                            <select id="cf-salaryCycleSelect"><option value="7">周付</option><option value="30" selected>月付</option><option value="custom">自定义</option></select>
                                        </div>
                                        <div class="input-field hidden" id="cf-salaryCycleCustom-wrapper"><label for="cf-salaryCycleCustom">自定义天数</label><input type="number" id="cf-salaryCycleCustom" value="15"></div>
                                    </div>
                                    <p class="text-xs text-slate-500 mb-4">注：能源和维保成本实时发生，保险和管理成本按月支付。</p>
                                    
                                    <h3 class="font-bold text-lg mb-4 border-b pb-2">模拟设置</h3>
                                    <div class="input-group">
                                        <div class="input-field"><label for="cf-simulationMonths">模拟月数</label><input type="number" id="cf-simulationMonths" value="36"></div>
                                        <div class="input-field">
                                            <label for="cf-period">图表周期</label>
                                            <select id="cf-period"><option value="month" selected>月</option><option value="quarter">季度</option><option value="year">年</option></select>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex space-x-4">
                                    <button id="run-cashflow-sim" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">运行模拟</button>
                                    <button id="export-cashflow-btn" class="w-full px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">导出模拟 (Excel)</button>
                                </div>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg mb-4">模拟结果</h3>
                                <div class="chart-container h-64 mb-8">
                                    <p class="text-center font-semibold text-slate-700">累计现金流</p>
                                    <canvas id="cumulativeCashflowChart"></canvas>
                                </div>
                                <div class="chart-container h-64">
                                     <p class="text-center font-semibold text-slate-700">分期现金流</p>
                                    <canvas id="periodicCashflowChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>`;
                contentView.innerHTML = viewHTML;
                addInvestmentBatch(); // Add the first batch by default
                attachCashflowEventListeners();
            }
            
            let investmentBatchId = 0;
            function addInvestmentBatch() {
                investmentBatchId++;
                const batchHtml = `
                    <div class="investment-batch" data-batch-id="${investmentBatchId}">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="input-field"><label>投资类型</label><select class="investment-type"><option value="truck" selected>车辆</option><option value="station">充电桩</option></select></div>
                            <div class="input-field"><label>投资月份</label><input type="number" class="investment-month" value="${investmentBatchId === 1 ? 1 : 12}"></div>
                            <div class="input-field"><label>数量</label><input type="number" class="investment-units" value="${investmentBatchId === 1 ? 2 : 1}"></div>
                            <div class="input-field"><label>单位成本</label><input type="number" class="investment-unit-cost" value="${investmentBatchId === 1 ? 530000 : 1000000}"></div>
                            <div class="input-field"><label>自有资金比例 (%)</label><input type="number" class="investment-downpayment-rate" value="30"></div>
                            <div class="input-field"><label>贷款期限 (月)</label><input type="number" class="investment-loan-term" value="36"></div>
                            <div class="input-field col-span-2"><label>月还款额 (元)</label><input type="number" class="investment-monthly-payment" value="11500"></div>
                        </div>
                    </div>`;
                document.getElementById('investment-batches').insertAdjacentHTML('beforeend', batchHtml);
            }

            function attachCashflowEventListeners() {
                document.getElementById('add-investment-batch').addEventListener('click', addInvestmentBatch);
                document.getElementById('run-cashflow-sim').addEventListener('click', runCashflowSimulation);
                document.getElementById('export-cashflow-btn').addEventListener('click', exportCashflowToExcel);
                document.getElementById('cf-paymentCycleSelect').addEventListener('change', (e) => {
                    document.getElementById('cf-paymentCycleCustom-wrapper').classList.toggle('hidden', e.target.value !== 'custom');
                });
                document.getElementById('cf-salaryCycleSelect').addEventListener('change', (e) => {
                    document.getElementById('cf-salaryCycleCustom-wrapper').classList.toggle('hidden', e.target.value !== 'custom');
                });
            }

            function runCashflowSimulation() {
                if (!appState.quoteResult || !appState.internalResult || !appState.internalParams) {
                    alert("请先在“报价与成本”标签页计算成本。");
                    return;
                }
                
                const simParams = {
                    investmentBatches: [],
                    tripsPerMonthPerVehicle: parseFloat(document.getElementById('cf-tripsPerMonth').value),
                    paymentCycle: document.getElementById('cf-paymentCycleSelect').value === 'custom' ? parseInt(document.getElementById('cf-paymentCycleCustom').value) : parseInt(document.getElementById('cf-paymentCycleSelect').value),
                    salaryCycle: document.getElementById('cf-salaryCycleSelect').value === 'custom' ? parseInt(document.getElementById('cf-salaryCycleCustom').value) : parseInt(document.getElementById('cf-salaryCycleSelect').value),
                    simulationMonths: parseInt(document.getElementById('cf-simulationMonths').value),
                    period: document.getElementById('cf-period').value
                };
                
                document.querySelectorAll('.investment-batch').forEach(batchEl => {
                    simParams.investmentBatches.push({
                        type: batchEl.querySelector('.investment-type').value,
                        month: parseInt(batchEl.querySelector('.investment-month').value),
                        units: parseInt(batchEl.querySelector('.investment-units').value),
                        unitCost: parseFloat(batchEl.querySelector('.investment-unit-cost').value),
                        downPaymentRate: parseFloat(batchEl.querySelector('.investment-downpayment-rate').value) / 100,
                        loanTerm: parseInt(batchEl.querySelector('.investment-loan-term').value),
                        monthlyPayment: parseFloat(batchEl.querySelector('.investment-monthly-payment').value)
                    });
                });

                const results = performCashflowCalculation(simParams);
                appState.cashflowResults = results; // Save for export

                const cumulativeCtx = document.getElementById('cumulativeCashflowChart').getContext('2d');
                if (charts.cumulative) charts.cumulative.destroy();
                charts.cumulative = new Chart(cumulativeCtx, {
                    type: 'line',
                    data: { labels: results.labels, datasets: [{ label: '累计现金流', data: results.cumulativeData, borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', fill: true, tension: 0.1 }] },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                const periodicCtx = document.getElementById('periodicCashflowChart').getContext('2d');
                if (charts.periodic) charts.periodic.destroy();
                charts.periodic = new Chart(periodicCtx, {
                    type: 'bar',
                    data: { labels: results.labels, datasets: [ { label: '现金流入', data: results.periodicInflowData, backgroundColor: '#10b981' }, { label: '现金流出', data: results.periodicOutflowData, backgroundColor: '#ef4444' } ] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } } }
                });
            }

            function performCashflowCalculation(params) {
                const { investmentBatches, tripsPerMonthPerVehicle, paymentCycle, salaryCycle, simulationMonths, period } = params;
                const periodMonths = { month: 1, quarter: 3, year: 12 }[period];

                const revenuePerTrip = appState.quoteResult.total;
                const { energy, maintenance, driver } = appState.internalResult;
                const tripDays = appState.internalParams.tripDays;
                
                const variableCostPerTrip = energy + maintenance;
                const driverCostPerDay = tripDays > 0 ? driver / tripDays : 0;
                
                let cashBalance = 0;
                let accountsReceivable = 0;
                let accruedSalary = 0;
                let operatingFleetSize = 0;
                let totalMonthlyLoanPayment = 0;

                const cumulativeData = [0];
                const periodicInflowData = [];
                const periodicOutflowData = [];
                const labels = ['初始'];
                const detailedData = [];
                
                let periodicInflow = 0;
                let periodicOutflow = 0;
                let periodicNet = 0;
                let openingBalance = 0;

                for (let month = 1; month <= simulationMonths; month++) {
                    let monthlyInflow = 0;
                    let monthlyOutflow = 0;

                    const activeLoanPayments = investmentBatches.filter(b => month >= b.month && month < b.month + b.loanTerm).reduce((sum, b) => sum + b.monthlyPayment * b.units, 0);

                    investmentBatches.forEach(batch => {
                        if (batch.month === month) {
                            const totalCost = batch.units * batch.unitCost;
                            const downPayment = totalCost * batch.downPaymentRate;
                            monthlyOutflow += downPayment;
                            if (batch.type === 'truck') {
                                operatingFleetSize += batch.units;
                            }
                        }
                    });

                    const totalTripsThisMonth = tripsPerMonthPerVehicle * operatingFleetSize;
                    const monthlyRevenue = revenuePerTrip * totalTripsThisMonth;
                    const monthlyVariableCosts = variableCostPerTrip * totalTripsThisMonth;
                    const monthlyDriverCosts = driverCostPerDay * tripDays * totalTripsThisMonth;
                    const monthlyFixedCosts = (appState.internalResult.insurance + appState.internalResult.management) / tripDays * 30 * operatingFleetSize;
                    
                    accountsReceivable += monthlyRevenue;
                    accruedSalary += monthlyDriverCosts;
                    
                    monthlyOutflow += monthlyVariableCosts;

                    if (month * 30 % paymentCycle < 30) {
                        monthlyInflow += accountsReceivable;
                        accountsReceivable = 0;
                    }
                    if (month * 30 % salaryCycle < 30) {
                        monthlyOutflow += accruedSalary;
                        accruedSalary = 0;
                    }

                    monthlyOutflow += monthlyFixedCosts;
                    monthlyOutflow += activeLoanPayments;

                    cashBalance += monthlyInflow - monthlyOutflow;
                    periodicInflow += monthlyInflow;
                    periodicOutflow += monthlyOutflow;

                    if (month % periodMonths === 0) {
                        const periodLabel = `${period}${month/periodMonths}`;
                        labels.push(periodLabel);
                        cumulativeData.push(cashBalance);
                        periodicInflowData.push(periodicInflow);
                        periodicOutflowData.push(-periodicOutflow);
                        
                        detailedData.push({
                            label: periodLabel,
                            opening: openingBalance,
                            inflow: periodicInflow,
                            outflow: periodicOutflow,
                            net: periodicInflow - periodicOutflow,
                            closing: cashBalance
                        });
                        openingBalance = cashBalance;
                        periodicInflow = 0;
                        periodicOutflow = 0;
                    }
                }
                return { labels, cumulativeData, periodicInflowData, periodicOutflowData, detailedData, params };
            }

            function renderBenchmarkView() {
                const viewHTML = `
                    <div class="card p-6 md:p-8">
                        <h2 class="text-2xl font-bold text-slate-800 mb-4">行业运价对标</h2>
                        <p class="text-slate-600 mb-6">输入一个或多个省份（用逗号分隔），查询近期的公路运价作为参考。</p>
                        <div class="flex space-x-4 mb-6">
                            <input type="text" id="benchmark-provinces" class="w-full px-4 py-2 border border-slate-300 rounded-md" placeholder="例如: 甘肃, 四川">
                            <button id="run-benchmark-search" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">查询</button>
                        </div>
                        <div id="benchmark-results">
                            <p class="text-center text-slate-400">请输入省份并点击查询。</p>
                        </div>
                    </div>`;
                contentView.innerHTML = viewHTML;
                document.getElementById('run-benchmark-search').addEventListener('click', runBenchmarkSearch);
            }

            async function runBenchmarkSearch() {
                const provincesInput = document.getElementById('benchmark-provinces').value;
                const resultsContainer = document.getElementById('benchmark-results');
                if (!provincesInput.trim()) {
                    resultsContainer.innerHTML = `<p class="text-center text-red-500">请输入至少一个省份。</p>`; return;
                }
                resultsContainer.innerHTML = `<p class="text-center text-slate-500">正在查询，请稍候...</p>`;

                const apiKey = ""; // Gemini API Key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const prompt = `请为以下每个省份提供最近2年的公路货运价格（单位：元/吨·公里），并尽可能注明车辆类型和数据来源（例如：XXX公司招标价，XXX行业协会指导价）。省份：${provincesInput}。如果找不到特定省份的数据，请明确指出。`;
                
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        const formattedText = text.replace(/\*\*(.*?)\*\*/g, '<h4 class="font-bold text-lg mt-4">$1</h4>')
                                                .replace(/\* (.*?):/g, '<li><span class="font-semibold">$1</span>:')
                                                .replace(/来源：(.*?)\n/g, '<span class="text-slate-500">来源: $1</span></li>')
                                                .replace(/\n/g, '<br>');
                        resultsContainer.innerHTML = `<div class="p-4 border rounded-lg text-sm">${formattedText}</div>`;
                    } else {
                        resultsContainer.innerHTML = `<p class="text-center text-red-500">查询失败或无相关数据。</p>`;
                    }
                } catch (error) {
                    console.error("Benchmark search error:", error);
                    resultsContainer.innerHTML = `<p class="text-center text-red-500">查询时发生网络错误。</p>`;
                }
            }
            
            function attachExportEventListeners() {
                document.getElementById('export-quote-btn').addEventListener('click', () => exportToExcel('quote'));
                document.getElementById('export-internal-btn').addEventListener('click', () => exportToExcel('internal'));
                document.getElementById('export-all-btn').addEventListener('click', () => exportToExcel('all'));
            }
            
            function exportToExcel(type) {
                const wb = XLSX.utils.book_new();
                const formatDataForSheet = (costs, params, title) => {
                    const labels = {
                        tripDistanceOneWay: '运输距离 (km)', tractionHeadCost: '牵引头成本 (元)', trailerCost: '挂车成本 (元)',
                        depreciationYears: '折旧年限 (年)', depreciationRate: '折旧率 (%)', tripDays: '单次任务天数',
                        driverDailySalary: '司机日薪 (元)', electricityPrice: '电价 (元/度)', serviceFee: '服务费 (元/度)',
                        maintenancePerKm: '维保 (元/km)', managementCost3Years: '管理成本 (元/3年)', workDaysPerYear: '年工作天数',
                        insurancePerYear: '年保险 (元)', payloadTons: '载重 (吨)',
                        heavyLoadOutbound: '重载去程能耗 (kWh/km)', motherSonReturn: '子母车返程能耗 (kWh/km)'
                    };
                    const costLabels = { energy: '能源成本', maintenance: '维修及轮胎', driver: '司机成本', depreciation: '车辆折旧', insurance: '保险费用', management: '管理成本' };

                    const data = [
                        [title, null, null],
                        [],
                        ['成本指标', '金额', '单位'],
                        ['单车单次任务总成本', costs.total.toFixed(2), '元'],
                        ['单位吨煤成本', costs.perTon.toFixed(2), '元/吨'],
                        ['单位吨公里成本', costs.perTonKm.toFixed(2), '元/吨·公里'],
                        [],
                        ['成本明细', '金额', '计算公式'],
                        ...Object.entries(costs).filter(([k]) => !['total', 'perTon', 'perTonKm', 'formulas'].includes(k)).map(([key, value]) => [costLabels[key], value.toFixed(2), costs.formulas[key]]),
                        [],
                        ['基于参数', '设定值'],
                        ...Object.entries(params).map(([key, value]) => [labels[key], key === 'depreciationRate' ? `${value*100}%` : value])
                    ];
                    
                    const ws = XLSX.utils.aoa_to_sheet(data);
                    ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 2 } }];
                    ws['!cols'] = [{ wch: 25 }, { wch: 15 }, { wch: 50 }];
                    return ws;
                };

                if (type === 'quote' || type === 'all') {
                    if (appState.quoteResult && appState.quoteParams) {
                        const ws = formatDataForSheet(appState.quoteResult, appState.quoteParams, '客户报价单');
                        XLSX.utils.book_append_sheet(wb, ws, '客户报价单');
                    }
                }

                if (type === 'internal' || type === 'all') {
                    if (appState.internalResult && appState.internalParams) {
                        const ws = formatDataForSheet(appState.internalResult, appState.internalParams, '内部成本估算');
                        XLSX.utils.book_append_sheet(wb, ws, '内部成本估算');
                    }
                }
                
                if (wb.SheetNames.length > 0) {
                    XLSX.writeFile(wb, '运输成本分析.xlsx');
                } else {
                    alert('没有可导出的数据，请先进行计算。');
                }
            }

            function exportCashflowToExcel() {
                if (!appState.cashflowResults) {
                    alert('请先运行现金流模拟。');
                    return;
                }
                const { detailedData, params } = appState.cashflowResults;
                const wb = XLSX.utils.book_new();
                
                const paramData = [
                    ['现金流模拟参数'],
                    ['参数', '值'],
                    ['月均运输次数/车', params.tripsPerMonthPerVehicle],
                    ['客户回款周期 (天)', params.paymentCycle],
                    ['司机工资支付周期 (天)', params.salaryCycle],
                    ['模拟月数', params.simulationMonths],
                    ['图表周期', params.period],
                    [],
                    ['投资计划'],
                    ['批次', '类型', '投资月份', '数量', '单位成本', '自有资金比例', '贷款期限(月)', '月还款额']
                ];
                params.investmentBatches.forEach((batch, index) => {
                    paramData.push([
                        index + 1,
                        batch.type === 'truck' ? '车辆' : '充电桩',
                        batch.month,
                        batch.units,
                        batch.unitCost,
                        `${batch.downPaymentRate * 100}%`,
                        batch.loanTerm,
                        batch.monthlyPayment
                    ]);
                });

                const ws_params = XLSX.utils.aoa_to_sheet(paramData);
                ws_params['!cols'] = [{ wch: 20 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, ws_params, '模拟参数');

                const resultsData = [
                    ['现金流模拟结果'],
                    [],
                    ['周期', '期初现金', '现金流入', '现金流出', '净现金流', '期末现金']
                ];
                detailedData.forEach(row => {
                    resultsData.push([
                        row.label,
                        row.opening.toFixed(2),
                        row.inflow.toFixed(2),
                        row.outflow.toFixed(2),
                        row.net.toFixed(2),
                        row.closing.toFixed(2)
                    ]);
                });
                const ws_results = XLSX.utils.aoa_to_sheet(resultsData);
                ws_results['!cols'] = Array(6).fill({ wch: 18 });
                XLSX.utils.book_append_sheet(wb, ws_results, '现金流明细');

                XLSX.writeFile(wb, '现金流模拟分析.xlsx');
            }

            function ensureInitialCalculations() {
                if (!appState.quoteParams) {
                    appState.quoteParams = gatherInputs('quote') || DEFAULT_PARAMS.quote.values;
                    appState.quoteResult = calculateCosts(appState.quoteParams, 'standard');
                }
                if (!appState.internalParams) {
                    appState.internalParams = gatherInputs('internal') || DEFAULT_PARAMS.internal.values;
                    appState.internalResult = calculateCosts(appState.internalParams, 'standard');
                }
            }

            mainTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    mainTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentView = tab.dataset.view;
                    ensureInitialCalculations();
                    switch(currentView) {
                        case 'cost-quote': renderCostQuoteView(); break;
                        case 'profit': renderProfitView(); break;
                        case 'cashflow': renderCashflowView(); break;
                        case 'benchmark': renderBenchmarkView(); break;
                    }
                });
            });

            // Initial Render
            renderCostQuoteView();
        });
    </script>
</body>
</html>
