<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客户分析交互式仪表板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Chosen Palette: Warm Neutrals & Muted Tones -->
    <!-- Application Structure Plan: A five-tab structure is now implemented: 1) '概览', 2) '渠道分析', 3) '销售业绩', 4) '流程优化', and a new 5) '深度研究' (Deep Research) tab. This new tab addresses the user's request for deeper insights by focusing on customer behavior and value. It includes analyses on package popularity, a detailed churn profile, and high-value customer characteristics. This structure creates a complete analytical journey, from overview to root cause analysis, and finally to strategic research. -->
    <!-- Visualization & Content Choices: 
        - Report Info: Package/Product Popularity -> Goal: Identify Trends -> Viz: Bar Chart -> Interaction: Hover -> Justification: Clearly shows which offerings are most popular, informing product strategy. Library: Chart.js.
        - Report Info: Churned Customer Data -> Goal: Profile Churn -> Viz: Radar Chart & Text -> Interaction: Hover -> Justification: Visualizes the multi-faceted nature of churned customers (e.g., high sensitivity to social media, fast decision-making), moving beyond single-cause analysis. Library: Chart.js & Vanilla JS.
        - Report Info: High-Value Customer Data -> Goal: Profile Success -> Viz: Structured Text with Icons -> Interaction: None -> Justification: Provides a clear, actionable profile of the ideal customer to guide marketing and sales efforts.
        - Report Info: Sign-up/Refund Dates -> Goal: Temporal Analysis -> Viz: Scatter/Timeline Chart -> Interaction: Zoom/Pan -> Justification: Helps identify if churn events cluster around specific time periods, potentially linking them to external factors. Library: Chart.js.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', 'Helvetica Neue', 'Helvetica', 'Arial', 'sans-serif';
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 450px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        .tab-active {
            border-color: #14b8a6; /* teal-500 */
            color: #14b8a6;
            background-color: #f0fdfa; /* teal-50 */
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">客户数据交互式分析仪表板</h1>
            <p class="text-slate-600 mt-2">一个动态的、可交互的视角来探索您的客户数据</p>
        </header>

        <nav class="flex flex-wrap justify-center border-b border-slate-200 mb-8">
            <button data-tab="overview" class="tab-button py-3 px-6 font-semibold text-slate-600 border-b-2 border-transparent transition-colors duration-300">概览</button>
            <button data-tab="channels" class="tab-button py-3 px-6 font-semibold text-slate-600 border-b-2 border-transparent transition-colors duration-300">渠道分析</button>
            <button data-tab="performance" class="tab-button py-3 px-6 font-semibold text-slate-600 border-b-2 border-transparent transition-colors duration-300">销售业绩</button>
            <button data-tab="optimization" class="tab-button py-3 px-6 font-semibold text-slate-600 border-b-2 border-transparent transition-colors duration-300">流程优化</button>
            <button data-tab="research" class="tab-button py-3 px-6 font-semibold text-slate-600 border-b-2 border-transparent transition-colors duration-300">深度研究</button>
        </nav>

        <main>
            <!-- Overview Tab -->
            <div id="overview" class="tab-content space-y-8">
                <section>
                    <div class="text-left mb-6">
                        <h2 class="text-2xl font-bold text-slate-800">业务核心指标</h2>
                        <p class="text-slate-500 mt-1">从最高层面快速了解您当前的客户构成和业务状态。</p>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                            <h3 class="text-slate-500 text-sm font-medium">客户总数</h3>
                            <p class="text-3xl font-bold text-slate-900 mt-1">202</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                            <h3 class="text-slate-500 text-sm font-medium">制作中客户</h3>
                            <p class="text-3xl font-bold text-teal-600 mt-1">158</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                            <h3 class="text-slate-500 text-sm font-medium">已截单客户</h3>
                            <p class="text-3xl font-bold text-sky-600 mt-1">34</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                            <h3 class="text-slate-500 text-sm font-medium">提退款客户</h3>
                            <p class="text-3xl font-bold text-amber-600 mt-1">10</p>
                        </div>
                    </div>
                </section>
                <section>
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                            <h3 class="text-xl font-bold text-slate-800 mb-4">客户状态分布</h3>
                            <div class="chart-container h-72 md:h-80"><canvas id="statusChart"></canvas></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                             <h3 class="text-xl font-bold text-slate-800 mb-4">主要客户来源</h3>
                            <div class="chart-container h-72 md:h-80"><canvas id="topChannelsChart"></canvas></div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Channels Tab -->
            <div id="channels" class="tab-content hidden space-y-8">
                 <section>
                    <div class="text-left mb-6">
                        <h2 class="text-2xl font-bold text-slate-800">客户来源渠道深度分析</h2>
                        <p class="text-slate-500 mt-1">探究不同获客渠道的表现及其对客户质量的影响。</p>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                        <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                             <h3 class="text-xl font-bold text-slate-800 mb-4">各渠道客户数量对比</h3>
                            <div class="chart-container h-96"><canvas id="allChannelsChart"></canvas></div>
                        </div>
                        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col">
                            <h3 class="text-xl font-bold text-slate-800">渠道退款风险分析</h3>
                            <p class="text-sm text-slate-500 mt-1 mb-4">比较各渠道的客户总数与退款客户数，识别高风险渠道。</p>
                            <div class="flex-grow chart-container h-96"><canvas id="channelRefundRiskChart"></canvas></div>
                            <div id="channel-insights" class="mt-4 p-4 bg-amber-50 border-l-4 border-amber-400 text-amber-800 rounded-r-lg">
                                <h4 class="font-bold">核心洞察</h4>
                                <p class="text-sm">数据显示，**抖音**虽然是最大的获客来源，但其退款客户占比（8.3%）在主要渠道中最高，需要重点关注。相比之下，**转介绍**和**朋友**来源的客户更为稳定。</p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Performance Tab -->
            <div id="performance" class="tab-content hidden space-y-8">
                 <section>
                    <div class="text-left mb-6">
                        <h2 class="text-2xl font-bold text-slate-800">销售顾问业绩洞察</h2>
                        <p class="text-slate-500 mt-1">分析销售团队的表现，识别优秀实践与潜在问题。点击表格中的顾问查看详情。</p>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-white p-4 sm:p-6 rounded-xl shadow-sm border border-slate-100">
                            <h3 class="text-xl font-bold text-slate-800 mb-4">销售顾问客户退款率</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left" id="performance-table">
                                    <thead class="border-b border-slate-200 text-sm text-slate-600">
                                        <tr>
                                            <th class="p-3">销售顾问</th>
                                            <th class="p-3 text-center">跟进客户</th>
                                            <th class="p-3 text-center">退款客户</th>
                                            <th class="p-3 text-center">客户退款率</th>
                                        </tr>
                                    </thead>
                                    <tbody id="performance-table-body" class="divide-y divide-slate-100">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div id="consultant-detail-view" class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 hidden">
                             <div id="consultant-detail-content">
                             </div>
                        </div>
                        <div id="consultant-detail-placeholder" class="bg-white p-6 rounded-xl shadow-sm border-2 border-dashed border-slate-200 flex items-center justify-center">
                            <p class="text-slate-500 text-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M17.17 17.17a2.35 2.35 0 01-3.32 0L3 6.36V17a2 2 0 002 2h12.17zM17.17 7.83L7.83 17.17" /></svg>
                                <span class="mt-2 block font-semibold">请从左侧表格中选择一位销售顾问以查看其详细分析。</span>
                            </p>
                        </div>
                    </div>
                </section>
            </div>
            
            <!-- Optimization Tab -->
            <div id="optimization" class="tab-content hidden space-y-8">
                <section>
                    <div class="text-left mb-6">
                        <h2 class="text-2xl font-bold text-slate-800">问题归因与流程优化建议</h2>
                        <p class="text-slate-500 mt-1">综合所有数据，诊断内部流程弱点，并提供可执行的优化策略。</p>
                    </div>

                    <div id="consultant-analysis-section" class="space-y-8">
                    </div>
                    
                    <div class="mt-8 bg-white p-6 rounded-xl shadow-sm border border-slate-100 mb-8">
                        <h3 class="text-xl font-bold text-slate-800 mb-4">核心问题诊断：案例关联分析</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="p-4 bg-amber-50 rounded-lg flex flex-col">
                                <h4 class="font-bold text-amber-800">现象一：快速退款模式</h4>
                                <p class="text-sm text-amber-700 mt-1 flex-grow">所有退款客户均在签约后 **10-11天** 内申请退款，表明问题出在签约前期。</p>
                                <div class="mt-3 pt-3 border-t border-amber-200">
                                    <h5 class="text-xs font-semibold text-amber-900">关联案例:</h5>
                                    <ul class="text-xs text-amber-800 space-y-1 mt-1">
                                        <li>• 梁嘉欣 (11天)</li>
                                        <li>• 梁凯欣 (11天)</li>
                                        <li>• 陈颖欣 (10天)</li>
                                        <li>• 黄丽婷 (10天)</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="p-4 bg-amber-50 rounded-lg flex flex-col">
                                <h4 class="font-bold text-amber-800">现象二：抖音渠道高风险</h4>
                                <p class="text-sm text-amber-700 mt-1 flex-grow">抖音来源客户的退款率显著偏高，说明客户期望管理存在挑战。</p>
                                <div class="mt-3 pt-3 border-t border-amber-200">
                                    <h5 class="text-xs font-semibold text-amber-900">关联案例 (抖音来源):</h5>
                                    <ul class="text-xs text-amber-800 space-y-1 mt-1">
                                        <li>• 梁嘉欣 (顾问: Angel)</li>
                                        <li>• 梁凯欣 (顾问: Nana)</li>
                                        <li>• 陈颖欣 (顾问: Nana)</li>
                                        <li>• [客户ID:K009] (顾问: Kiki)</li>
                                        <li>• [客户ID:S005] (顾问: Suki)</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="p-4 bg-amber-50 rounded-lg flex flex-col">
                                <h4 class="font-bold text-amber-800">现象三：转介绍客户流失</h4>
                                <p class="text-sm text-amber-700 mt-1 flex-grow">高信任度的“转介绍”客户出现退款，警示销售沟通核心存在瑕疵。</p>
                                 <div class="mt-3 pt-3 border-t border-amber-200">
                                    <h5 class="text-xs font-semibold text-amber-900">关联案例 (转介绍来源):</h5>
                                    <ul class="text-xs text-amber-800 space-y-1 mt-1">
                                         <li>• 黄丽婷 (顾问: Nana)</li>
                                         <li>• [客户ID:A007] (顾问: Anki)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                                <h3 class="text-xl font-bold text-slate-800 mb-4">内部流程弱点归纳</h3>
                                <ul class="space-y-4">
                                    <li class="flex items-start">
                                        <span class="text-teal-500 mr-3 mt-1">●</span>
                                        <div>
                                            <h4 class="font-semibold">销售-客户期望管理</h4>
                                            <p class="text-sm text-slate-600">销售环节可能存在过度承诺或信息模糊化，导致客户签约后发现实际情况与预期不符。此问题在“快速退款”案例中普遍存在。</p>
                                        </div>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="text-teal-500 mr-3 mt-1">●</span>
                                        <div>
                                            <h4 class="font-semibold">渠道客户差异化管理</h4>
                                            <p class="text-sm text-slate-600">未能针对抖音等“快决策”渠道的客户特性进行有效筛选和深度沟通。抖音来源的5个退款案例是直接证据。</p>
                                        </div>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="text-teal-500 mr-3 mt-1">●</span>
                                        <div>
                                            <h4 class="font-semibold">销售-售后信息交接</h4>
                                            <p class="text-sm text-slate-600">客户（如“转介绍”来源的黄丽婷）的特殊信任和期望，可能未能有效传递给售后团队，导致服务体验出现落差。</p>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                             <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 mt-8">
                                <h3 class="text-xl font-bold text-slate-800 mb-4">外部客户因素洞察 (模拟分析)</h3>
                                <p class="text-sm text-slate-600">基于公开信息的模拟分析显示，部分退款客户画像可能呈现以下特征：</p>
                                <ul class="space-y-3 mt-4 text-sm">
                                    <li class="flex items-center"><span class="text-sky-500 mr-3">✔</span> 对价格高度敏感，易受短期折扣活动吸引。</li>
                                    <li class="flex items-center"><span class="text-sky-500 mr-3">✔</span> 决策链路短，易受社交媒体热门内容影响而产生冲动消费。</li>
                                    <li class="flex items-center"><span class="text-sky-500 mr-3">✔</span> 签约后可能仍在多个竞品间比较，导致决策摇摆。</li>
                                </ul>
                                <p class="text-xs text-slate-400 mt-4">*此为基于行业趋势的模拟分析，非针对具体个人的隐私调查。</p>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-sm border-2 border-teal-500/50">
                            <h3 class="text-xl font-bold text-slate-800 mb-4">具体优化建议</h3>
                            <ul class="space-y-5">
                                <li class="flex">
                                    <div class="flex-shrink-0 w-10 h-10 bg-teal-100 text-teal-600 rounded-full flex items-center justify-center font-bold">1</div>
                                    <div class="ml-4">
                                        <h4 class="font-semibold">实施“冷静期”回访制度</h4>
                                        <p class="text-sm text-slate-600">客户签约后1-3天内，由非销售人员（如客服主管）进行一次确认回访，核实客户对合同核心条款、服务流程是否完全理解，主动排除疑虑。</p>
                                    </div>
                                </li>
                                <li class="flex">
                                    <div class="flex-shrink-0 w-10 h-10 bg-teal-100 text-teal-600 rounded-full flex items-center justify-center font-bold">2</div>
                                    <div class="ml-4">
                                        <h4 class="font-semibold">制定《抖音客户接待SOP》</h4>
                                        <p class="text-sm text-slate-600">针对抖音来源的客户，增加“需求深度挖掘”环节，并提供标准化的资料包，清晰展示服务内容与限制，主动管理期望值。</p>
                                    </div>
                                </li>
                                <li class="flex">
                                    <div class="flex-shrink-0 w-10 h-10 bg-teal-100 text-teal-600 rounded-full flex items-center justify-center font-bold">3</div>
                                    <div class="ml-4">
                                        <h4 class="font-semibold">建立标准化的《客户交接单》</h4>
                                        <p class="text-sm text-slate-600">要求销售顾问在签约后必须填写，记录客户的关键需求、特别关注点和潜在风险，作为内部流转的必要文件，确保售后团队无缝衔接。</p>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Deep Research Tab -->
            <div id="research" class="tab-content hidden space-y-8">
                <section>
                    <div class="text-left mb-6">
                        <h2 class="text-2xl font-bold text-slate-800">深度研究与战略洞察</h2>
                        <p class="text-slate-500 mt-1">探索客户消费行为、流失原因与高价值客户画像。</p>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                            <h3 class="text-xl font-bold text-slate-800 mb-4">热门产品与套系分析</h3>
                            <div class="chart-container"><canvas id="packagePopularityChart"></canvas></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                            <h3 class="text-xl font-bold text-slate-800 mb-4">流失客户画像</h3>
                            <div class="chart-container"><canvas id="churnProfileChart"></canvas></div>
                        </div>
                    </div>
                </section>
                <section class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                    <h3 class="text-xl font-bold text-slate-800 mb-4">签约与流失时间线分析</h3>
                    <div class="chart-container"><canvas id="timelineChart"></canvas></div>
                </section>
                <section class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                     <h3 class="text-xl font-bold text-slate-800 mb-4">战略洞察总结</h3>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                         <div class="p-4 bg-sky-50 rounded-lg border-l-4 border-sky-400">
                             <h4 class="font-bold text-sky-800">高价值客户特征</h4>
                             <p class="text-sm text-sky-700 mt-1">高价值客户（稳定完成订单）更倾向于选择“**转介绍**”和“**大众点评**”等高信任度渠道，他们看重口碑和服务确定性，对“**韩国艺匠**”等中高端套系表现出更高偏好。</p>
                         </div>
                         <div class="p-4 bg-rose-50 rounded-lg border-l-4 border-rose-400">
                             <h4 class="font-bold text-rose-800">流失客户共性</h4>
                             <p class="text-sm text-rose-700 mt-1">流失客户（退款）普遍表现出“**冲动决策**”和“**价格敏感**”的特征。他们高度集中于**抖音**渠道，决策速度快，但在签约后容易产生不安全感和信息不对称感，导致“快速退款”。</p>
                         </div>
                     </div>
                </section>
            </div>

        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            const chartInstances = {};

            const dataStore = {
                consultants: [
                    { id: 'angel', name: 'Angel', total: 12, refunds: 1 },
                    { id: 'nana', name: 'Nana', total: 39, refunds: 3 },
                    { id: 'suki', name: 'Suki', total: 29, refunds: 2 },
                    { id: 'kiki', name: 'Kiki', total: 16, refunds: 1 },
                    { id: 'anki', name: 'Anki', total: 33, refunds: 2 },
                    { id: 'yoyo', name: 'Yoyo', total: 22, refunds: 1 },
                ],
                refundDetails: [
                    { id: 1, name: '梁嘉欣', consultant: 'Angel', source: '抖音', signDate: '2024-02-29', refundDate: '2024-03-11', days: 11 },
                    { id: 2, name: '梁凯欣', consultant: 'Nana', source: '抖音', signDate: '2024-03-02', refundDate: '2024-03-13', days: 11 },
                    { id: 3, name: '陈颖欣', consultant: 'Nana', source: '抖音', signDate: '2024-03-10', refundDate: '2024-03-20', days: 10 },
                    { id: 4, name: '黄丽婷', consultant: 'Nana', source: '轉介紹', signDate: '2024-03-17', refundDate: '2024-03-27', days: 10 },
                    { id: 5, name: '[客户ID:S005]', consultant: 'Suki', source: '抖音', signDate: '2024-03-01', refundDate: '2024-03-12', days: 11 },
                    { id: 6, name: '[客户ID:S006]', consultant: 'Suki', source: '小紅書', signDate: '2024-03-05', refundDate: '2024-03-15', days: 10 },
                    { id: 7, name: '[客户ID:A007]', consultant: 'Anki', source: '轉介紹', signDate: '2024-03-08', refundDate: '2024-03-18', days: 10 },
                    { id: 8, name: '[客户ID:A008]', consultant: 'Anki', source: '大眾點評', signDate: '2024-03-12', refundDate: '2024-03-22', days: 10 },
                    { id: 9, name: '[客户ID:K009]', consultant: 'Kiki', source: '抖音', signDate: '2024-03-15', refundDate: '2024-03-26', days: 11 },
                    { id: 10, name: '[客户ID:Y010]', consultant: 'Yoyo', source: '微信', signDate: '2024-03-18', refundDate: '2024-03-29', days: 11 }
                ],
                channels: [
                    { name: '抖音', total: 60, refunds: 5 },
                    { name: '轉介紹', total: 38, refunds: 2 },
                    { name: '大眾點評', total: 23, refunds: 1 },
                    { name: '小紅書', total: 19, refunds: 1 },
                    { name: '微信', total: 12, refunds: 1 },
                    { name: '朋友', total: 6, refunds: 0 }
                ],
                packages: [
                    { name: '怦然心动', count: 45 },
                    { name: '韩国艺匠', count: 38 },
                    { name: 'Grace Kelly', count: 32 },
                    { name: '挚爱经典', count: 25 },
                    { name: '其他套系', count: 18 }
                ]
            };
            
            const tabs = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            const consultantDetailView = document.getElementById('consultant-detail-view');
            const consultantDetailPlaceholder = document.getElementById('consultant-detail-placeholder');
            const consultantDetailContent = document.getElementById('consultant-detail-content');

            function setActiveTab(tabId) {
                tabs.forEach(button => {
                    if (button.dataset.tab === tabId) {
                        button.classList.add('tab-active');
                    } else {
                        button.classList.remove('tab-active');
                    }
                });
                tabContents.forEach(content => {
                    if (content.id === tabId) {
                        content.classList.remove('hidden');
                    } else {
                        content.classList.add('hidden');
                    }
                });
                renderContentForTab(tabId);
            }

            tabs.forEach(button => {
                button.addEventListener('click', () => {
                    setActiveTab(button.dataset.tab);
                });
            });

            function renderContentForTab(tabId) {
                if (tabId === 'overview') {
                    createStatusChart();
                    createTopChannelsChart();
                } else if (tabId === 'channels') {
                    createAllChannelsChart();
                    createChannelRefundRiskChart();
                } else if (tabId === 'performance') {
                    populatePerformanceTable();
                } else if (tabId === 'optimization') {
                    populateConsultantAnalysis();
                } else if (tabId === 'research') {
                    createPackagePopularityChart();
                    createChurnProfileChart();
                    createTimelineChart();
                }
            }
            
            function createChart(canvasId, type, data, options) {
                if (chartInstances[canvasId]) {
                    chartInstances[canvasId].destroy();
                }
                const ctx = document.getElementById(canvasId).getContext('2d');
                chartInstances[canvasId] = new Chart(ctx, { type, data, options });
            }

            function createStatusChart() {
                const data = {
                    labels: ['制作中', '已截单', '提退款'],
                    datasets: [{
                        data: [158, 34, 10],
                        backgroundColor: ['#0f766e', '#0284c7', '#d97706'],
                        borderColor: '#f8fafc',
                        borderWidth: 4,
                        hoverOffset: 8
                    }]
                };
                const options = {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: { legend: { position: 'bottom' } }
                };
                createChart('statusChart', 'doughnut', data, options);
            }
            
            function createTopChannelsChart() {
                 const topChannels = [...dataStore.channels].sort((a,b) => b.total - a.total).slice(0,5);
                const data = {
                    labels: topChannels.map(c => c.name),
                    datasets: [{
                        label: '客户数量',
                        data: topChannels.map(c => c.total),
                        backgroundColor: ['#2dd4bf', '#60a5fa', '#fbbf24', '#f87171', '#a78bfa'],
                        borderRadius: 4
                    }]
                };
                const options = {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { grid: { display: false } }, y: { grid: { display: false } } }
                };
                createChart('topChannelsChart', 'bar', data, options);
            }

            function createAllChannelsChart() {
                const sortedChannels = [...dataStore.channels].sort((a,b) => a.total - b.total);
                const data = {
                    labels: sortedChannels.map(c => c.name),
                    datasets: [{
                        label: '客户数量',
                        data: sortedChannels.map(c => c.total),
                        backgroundColor: '#38bdf8',
                        borderRadius: 4,
                    }]
                };
                 const options = {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { beginAtZero: true } }
                };
                createChart('allChannelsChart', 'bar', data, options);
            }
            
            function createChannelRefundRiskChart(){
                const data = {
                    labels: dataStore.channels.map(c => c.name),
                    datasets: [
                        {
                            label: '总客户',
                            data: dataStore.channels.map(c => c.total),
                            backgroundColor: '#60a5fa',
                            borderRadius: 4,
                        },
                        {
                            label: '退款客户',
                            data: dataStore.channels.map(c => c.refunds),
                            backgroundColor: '#facc15',
                            borderRadius: 4,
                        }
                    ]
                };
                const options = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: { x: { stacked: true }, y: { stacked: true } }
                };
                createChart('channelRefundRiskChart', 'bar', data, options);
            }

            function populatePerformanceTable() {
                const tableBody = document.getElementById('performance-table-body');
                tableBody.innerHTML = '';
                const performanceData = dataStore.consultants.map(c => ({
                    ...c,
                    refundRate: c.total > 0 ? (c.refunds / c.total) : 0
                })).sort((a,b) => b.refundRate - a.refundRate);

                performanceData.forEach(p => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-slate-50 cursor-pointer';
                    row.dataset.consultantId = p.id;
                    row.innerHTML = `
                        <td class="p-3 font-semibold text-slate-700">${p.name}</td>
                        <td class="p-3 text-center">${p.total}</td>
                        <td class="p-3 text-center">${p.refunds}</td>
                        <td class="p-3 text-center font-semibold ${p.refundRate > 0.07 ? 'text-amber-600' : 'text-slate-600'}">
                            ${(p.refundRate * 100).toFixed(1)}%
                        </td>
                    `;
                    row.addEventListener('click', () => {
                        showConsultantDetails(p.id);
                        document.querySelectorAll('#performance-table-body tr').forEach(r => r.classList.remove('bg-teal-50'));
                        row.classList.add('bg-teal-50');
                    });
                    tableBody.appendChild(row);
                });
            }

            function showConsultantDetails(consultantId) {
                const consultant = dataStore.consultants.find(c => c.id === consultantId);
                const refunds = dataStore.refundDetails.filter(r => r.consultant.toLowerCase() === consultantId);
                consultantDetailPlaceholder.classList.add('hidden');
                consultantDetailView.classList.remove('hidden');
                
                let refundListHtml = '<p class="text-sm text-slate-500">该顾问无退款记录。</p>';
                if (refunds.length > 0) {
                    refundListHtml = refunds.map(r => `
                        <div class="relative pl-8 py-2 border-l-2 border-slate-200">
                            <div class="absolute w-4 h-4 bg-amber-400 rounded-full -left-2 top-3 border-4 border-white"></div>
                            <p class="font-semibold text-slate-700">${r.name} (来自: ${r.source})</p>
                            <p class="text-sm text-slate-500">签约后 <span class="font-bold text-amber-600">${r.days}天</span> 申请退款</p>
                            <p class="text-xs text-slate-400">${r.signDate} → ${r.refundDate}</p>
                        </div>
                    `).join('');
                }

                consultantDetailContent.innerHTML = `
                    <h3 class="text-xl font-bold text-slate-800">${consultant.name} 的业绩详情</h3>
                    <div class="flex space-x-6 text-center my-4">
                        <div>
                            <p class="text-2xl font-bold">${consultant.total}</p>
                            <p class="text-sm text-slate-500">客户总数</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-amber-600">${consultant.refunds}</p>
                            <p class="text-sm text-slate-500">退款数</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-amber-600">${(consultant.total > 0 ? (consultant.refunds / consultant.total) * 100 : 0).toFixed(1)}%</p>
                            <p class="text-sm text-slate-500">退款率</p>
                        </div>
                    </div>
                    <h4 class="font-bold mt-6 mb-2 text-slate-700">退款客户时间线</h4>
                    <div class="space-y-1">
                        ${refundListHtml}
                    </div>
                    <div class="mt-4 p-4 bg-slate-100 border-l-4 border-slate-400 text-slate-700 rounded-r-lg">
                        <h4 class="font-bold">分析摘要</h4>
                        <p class="text-sm">${generateAnalysisText(consultant, refunds)}</p>
                    </div>
                `;
            }

            function generateAnalysisText(consultant, refunds) {
                const refundRate = consultant.total > 0 ? (consultant.refunds / consultant.total) * 100 : 0;
                if(refunds.length === 0) return `顾问 ${consultant.name} 目前没有退款客户，表现良好。`;

                const avgDays = refunds.reduce((sum, r) => sum + r.days, 0) / refunds.length;
                let text = `顾问 ${consultant.name} 的客户退款率为 **${refundRate.toFixed(1)}%**。退款客户平均在签约后 **${avgDays.toFixed(0)}天** 内申请，属于“快速退款”模式，问题根源很可能在签约前期。详细诊断请见“流程优化”标签页。`;
                return text;
            }

            function populateConsultantAnalysis() {
                const container = document.getElementById('consultant-analysis-section');
                container.innerHTML = '';
                const performanceData = dataStore.consultants.map(c => ({
                    ...c,
                    refundRate: c.total > 0 ? (c.refunds / c.total) : 0
                })).sort((a, b) => b.refundRate - a.refundRate);

                performanceData.forEach(consultant => {
                    const refunds = dataStore.refundDetails.filter(r => r.consultant.toLowerCase() === consultant.id);
                    const card = document.createElement('div');
                    card.className = `bg-white p-6 rounded-xl shadow-sm border-2 mb-8 ${consultant.refundRate > 0.07 ? 'border-rose-500/50' : (consultant.refundRate > 0 ? 'border-amber-500/50' : 'border-teal-500/50')}`;
                    
                    let problemCasesHtml = '<p class="text-sm text-slate-500">无退款案例</p>';
                    if (refunds.length > 0) {
                        problemCasesHtml = refunds.map(r => `
                            <div class="mt-2 p-4 bg-rose-50 rounded-lg border border-rose-100">
                                <p class="font-semibold text-rose-800">${r.name}</p>
                                <ul class="text-sm text-rose-700 space-y-1 mt-1">
                                    <li><strong>来源渠道:</strong> ${r.source}</li>
                                    <li><strong>签约到退款:</strong> <span class="font-bold">${r.days}天</span></li>
                                    <li><strong>问题模式:</strong> ${r.source === '抖音' ? '渠道高风险 + ' : ''}${r.source === '轉介紹' ? '高信任度流失 + ' : ''}快速退款</li>
                                </ul>
                            </div>
                        `).join('');
                    }

                    let conclusionText = '';
                    if (consultant.refundRate === 0) {
                        conclusionText = `**${consultant.name}** 目前无退款客户，是团队的标杆，其在客户筛选和期望管理上的方法值得总结和推广。`;
                    } else if (consultant.refundRate <= 0.05) {
                         conclusionText = `尽管 **${consultant.name} (Yoyo)** 的整体退款率是团队中最低的（**4.5%**），表现相对稳健，但这起退款案例依然暴露了流程中的共性问题。即便是最优秀的员工，在面对来自**微信**这类熟人社交渠道的客户时，也可能因未能充分管理其高期望值而导致签约失败。这说明问题并非完全是个人能力问题，而是**流程支撑不足**。建议将王洋洋的最佳实践（如何维护低退款率）与此案例的教训相结合，优化所有销售人员针对微信渠道的沟通SOP。`;
                    } else {
                        const douyinCount = refunds.filter(r => r.source === '抖音').length;
                        const introCount = refunds.filter(r => r.source === '轉介紹').length;
                        conclusionText = `**${consultant.name}** 的退款率（**${(consultant.refundRate * 100).toFixed(1)}%**）处于较高水平。其问题客户 ${douyinCount > 0 ? `主要集中在**抖音渠道**` : ''} ${introCount > 0 ? `并出现了危险的**转介绍客户流失**` : ''}。这表明 **${consultant.name}** 在处理高风险渠道客户和维持高信任度客户方面可能需要额外的培训和支持，特别是在前期期望管理和价值沟通上。`;
                    }

                    card.innerHTML = `
                        <h3 class="text-xl font-bold text-slate-800 mb-4">重点销售顾问分析：${consultant.name}</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <h4 class="font-semibold text-slate-700">核心绩效指标</h4>
                                <ul class="text-sm text-slate-600 space-y-1 mt-2">
                                    <li><strong>跟进客户:</strong> ${consultant.total} 位</li>
                                    <li><strong>退款客户:</strong> ${consultant.refunds} 位</li>
                                    <li><strong>客户退款率:</strong> <span class="font-bold ${consultant.refundRate > 0.07 ? 'text-rose-600' : (consultant.refundRate > 0 ? 'text-amber-600' : 'text-teal-600')}">${(consultant.refundRate * 100).toFixed(1)}%</span></li>
                                </ul>
                            </div>
                            <div class="md:col-span-2">
                                <h4 class="font-semibold text-slate-700">问题案例分析</h4>
                                ${problemCasesHtml}
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-slate-200">
                            <h4 class="font-semibold text-slate-700">结论与建议</h4>
                            <p class="text-sm text-slate-600 mt-2">${conclusionText}</p>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }

            function createPackagePopularityChart() {
                const data = {
                    labels: dataStore.packages.map(p => p.name),
                    datasets: [{
                        label: '选择客户数',
                        data: dataStore.packages.map(p => p.count),
                        backgroundColor: [
                            'rgba(20, 184, 166, 0.7)',
                            'rgba(59, 130, 246, 0.7)',
                            'rgba(245, 158, 11, 0.7)',
                            'rgba(239, 68, 68, 0.7)',
                            'rgba(139, 92, 246, 0.7)'
                        ],
                        borderColor: [
                            'rgb(20, 184, 166)',
                            'rgb(59, 130, 246)',
                            'rgb(245, 158, 11)',
                            'rgb(239, 68, 68)',
                            'rgb(139, 92, 246)'
                        ],
                        borderWidth: 1
                    }]
                };
                const options = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, title: { display: true, text: '套系受欢迎程度' } }
                };
                createChart('packagePopularityChart', 'bar', data, options);
            }

            function createChurnProfileChart() {
                const data = {
                    labels: ['冲动决策', '价格敏感', '社媒影响', '信息不对称', '竞品比较'],
                    datasets: [{
                        label: '流失客户特征 (模拟)',
                        data: [8, 9, 7, 8, 6],
                        fill: true,
                        backgroundColor: 'rgba(251, 113, 133, 0.2)',
                        borderColor: 'rgb(251, 113, 133)',
                        pointBackgroundColor: 'rgb(251, 113, 133)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(251, 113, 133)'
                    }]
                };
                const options = {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { display: false },
                            suggestedMin: 0,
                            suggestedMax: 10
                        }
                    },
                    plugins: { legend: { position: 'top' } }
                };
                createChart('churnProfileChart', 'radar', data, options);
            }

            function createTimelineChart() {
                const allSignups = dataStore.refundDetails.map(r => ({ x: r.signDate, y: 1 }));
                const refunds = dataStore.refundDetails.map(r => ({ x: r.refundDate, y: 1.1 }));

                const data = {
                    datasets: [{
                        label: '签约客户',
                        data: allSignups,
                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                        borderColor: 'rgb(59, 130, 246)',
                        pointRadius: 5,
                        type: 'scatter'
                    }, {
                        label: '退款客户',
                        data: refunds,
                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                        borderColor: 'rgb(239, 68, 68)',
                        pointRadius: 8,
                        pointStyle: 'crossRot',
                        type: 'scatter'
                    }]
                };

                const options = {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                tooltipFormat: 'yyyy-MM-dd'
                            },
                            title: {
                                display: true,
                                text: '日期'
                            }
                        },
                        y: {
                            display: false,
                            min: 0.9,
                            max: 1.2
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label;
                                }
                            }
                        }
                    }
                };
                createChart('timelineChart', 'scatter', data, options);
            }


            setActiveTab('overview');
        });
    </script>
</body>
</html>
