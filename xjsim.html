<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°ç–†ç”µåŠ¨é‡å¡ Â· å…¨å‚æ•°è´¢åŠ¡ä»¿çœŸç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-container { position: relative; width: 100%; height: 300px; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        /* Tab Styling */
        .tab-btn.active { border-bottom: 2px solid #4F46E5; color: #4F46E5; font-weight: 600; }
        .tab-btn { color: #64748B; font-weight: 500; }
        
        /* Inputs */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: #4F46E5; cursor: pointer; margin-top: -6px; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #E2E8F0; border-radius: 2px;
        }
        
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        
        .table-dense td, .table-dense th { padding: 0.5rem 0.75rem; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 h-14 flex items-center px-6 shrink-0 z-20 justify-between shadow-sm">
        <div class="flex items-center gap-2">
            <div class="bg-indigo-600 text-white p-1 rounded font-bold text-xs">FIN</div>
            <h1 class="font-bold text-slate-800">æ–°ç–†ç”µåŠ¨é‡å¡ Â· å…¨è´¢åŠ¡æŠ¥è¡¨ä»¿çœŸ</h1>
        </div>
        <div class="text-xs text-slate-500 flex gap-4">
            <span>åˆå§‹èµ„é‡‘: <strong class="text-emerald-600" id="head-capital">2000ä¸‡</strong></span>
            <span>è´¦æœŸ: <strong class="text-rose-600" id="head-lag">1ä¸ªæœˆ</strong></span>
            <span>è½¦é˜Ÿ: <strong class="text-indigo-600" id="head-trucks">--</strong></span>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <!-- Sidebar: Full Parameters -->
        <aside class="w-80 bg-white border-r border-slate-200 overflow-y-auto custom-scroll flex flex-col shrink-0 z-10">
            
            <!-- 1. Capital & Cash Flow -->
            <details class="group border-b border-slate-100" open>
                <summary class="flex justify-between p-3 cursor-pointer bg-emerald-50 hover:bg-emerald-100 sticky top-0 z-10">
                    <span class="font-bold text-emerald-800 text-xs">ğŸ’° èµ„é‡‘ä¸è´¦æœŸ (Capital)</span>
                    <span class="text-emerald-500">â–¼</span>
                </summary>
                <div class="p-4 space-y-4">
                    <div>
                        <div class="flex justify-between text-xs mb-1"><span>åˆå§‹èµ„æœ¬é‡‘ (ä¸‡)</span><span id="val-capital" class="font-bold text-emerald-600">2000</span></div>
                        <input type="range" id="inp-capital" min="500" max="5000" step="100" value="2000">
                    </div>
                    <div>
                        <div class="flex justify-between text-xs mb-1"><span>å®¢æˆ·ä»˜æ¬¾è´¦æœŸ (æœˆ)</span><span id="val-lag" class="font-bold text-rose-600">1.0</span></div>
                        <input type="range" id="inp-lag" min="0" max="6" step="0.5" value="1">
                    </div>
                </div>
            </details>

            <!-- 2. Business Scale -->
            <details class="group border-b border-slate-100">
                <summary class="flex justify-between p-3 cursor-pointer hover:bg-slate-50 border-t border-slate-100">
                    <span class="font-bold text-slate-700 text-xs">ğŸšš ä¸šåŠ¡è§„æ¨¡ (Scale)</span>
                    <span class="text-slate-400">â–¼</span>
                </summary>
                <div class="p-4 space-y-4">
                    <div>
                        <div class="flex justify-between text-xs mb-1"><span>å¹´è´§è¿æ€»é‡ (ä¸‡å¨)</span><span id="val-volume" class="font-bold">400</span></div>
                        <input type="range" id="inp-volume" min="100" max="1000" step="10" value="400">
                    </div>
                    <div>
                        <div class="flex justify-between text-xs mb-1"><span>è¿ä»· (å…ƒ/å¨/è¶Ÿ)</span><span id="val-price" class="font-bold">43</span></div>
                        <input type="range" id="inp-price" min="20" max="80" step="0.5" value="43">
                    </div>
                    <div>
                        <div class="flex justify-between text-xs mb-1"><span>å•ç¨‹è¿è· (km)</span><span id="val-dist" class="font-bold">180</span></div>
                        <input type="range" id="inp-dist" min="50" max="500" step="10" value="180">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="text-[10px] text-slate-500">è½½é‡(å¨)</label><input type="number" id="inp-load" class="w-full border rounded text-xs px-1" value="32"></div>
                        <div><label class="text-[10px] text-slate-500">æ—¥è¶Ÿæ•°</label><input type="number" id="inp-trips" class="w-full border rounded text-xs px-1" value="1"></div>
                    </div>
                    <div>
                        <div class="flex justify-between text-xs mb-1"><span>å¹´è¿è¥å¤©æ•°</span><span id="val-days" class="font-bold">350</span></div>
                        <input type="range" id="inp-days" min="200" max="365" step="5" value="350">
                    </div>
                </div>
            </details>

            <!-- 3. Asset & Finance -->
            <details class="group border-b border-slate-100">
                <summary class="flex justify-between p-3 cursor-pointer hover:bg-slate-50 border-t border-slate-100">
                    <span class="font-bold text-slate-700 text-xs">ğŸ¦ èµ„äº§ä¸é‡‘è (Capex)</span>
                    <span class="text-slate-400">â–¼</span>
                </summary>
                <div class="p-4 space-y-4">
                    <div class="p-2 bg-indigo-50 rounded border border-indigo-100">
                        <div class="text-[10px] font-bold text-indigo-800 uppercase mb-2">ç‰µå¼•è½¦ (è´·æ¬¾)</div>
                        <div class="flex justify-between text-xs mb-1"><span>å•ä»·(ä¸‡)</span><span id="val-tractor" class="font-bold">44</span></div>
                        <input type="range" id="inp-tractor" min="30" max="60" value="44">
                        <div class="flex gap-2 mt-2">
                            <div class="w-1/2"><label class="text-[10px]">é¦–ä»˜%</label><input type="number" id="inp-down" class="w-full border rounded text-xs px-1" value="15"></div>
                            <div class="w-1/2"><label class="text-[10px]">å¹´é™</label><input type="number" id="inp-years" class="w-full border rounded text-xs px-1" value="3"></div>
                        </div>
                    </div>
                    <div class="p-2 bg-slate-100 rounded border border-slate-200">
                        <div class="text-[10px] font-bold text-slate-600 uppercase mb-2">æŒ‚è½¦ (å…¨æ¬¾)</div>
                        <div class="flex justify-between text-xs mb-1"><span>å•ä»·(ä¸‡)</span><span id="val-trailer" class="font-bold">10</span></div>
                        <input type="range" id="inp-trailer" min="5" max="20" step="0.5" value="10">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="text-[10px] text-slate-500">åˆ©ç‡%</label><input type="number" id="inp-rate" class="w-full border rounded text-xs px-1" value="5"></div>
                        <div><label class="text-[10px] text-slate-500">æŠ˜æ—§å¹´</label><input type="number" id="inp-dep-years" class="w-full border rounded text-xs px-1" value="5"></div>
                    </div>
                     <div><label class="text-[10px] text-slate-500">æ®‹å€¼ç‡%</label><input type="number" id="inp-salvage" class="w-full border rounded text-xs px-1" value="5"></div>
                </div>
            </details>

            <!-- 4. Operational Costs -->
            <details class="group border-b border-slate-100" open>
                <summary class="flex justify-between p-3 cursor-pointer hover:bg-slate-50 border-t border-slate-100">
                    <span class="font-bold text-slate-700 text-xs">ğŸ› ï¸ è¿è¥æˆæœ¬ (Opex)</span>
                    <span class="text-slate-400">â–¼</span>
                </summary>
                <div class="p-4 space-y-4">
                    <div>
                        <div class="flex justify-between text-xs mb-1"><span>ç”µä»· (å…ƒ/kWh)</span><span id="val-elec" class="font-bold">0.8</span></div>
                        <input type="range" id="inp-elec" min="0.3" max="1.5" step="0.05" value="0.8">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="text-[10px] text-slate-500">é‡è½½ç”µè€—</label><input type="number" id="inp-kwh-full" class="w-full border rounded text-xs px-1" value="1.6" step="0.1"></div>
                        <div><label class="text-[10px] text-slate-500">ç©ºè½½ç”µè€—</label><input type="number" id="inp-kwh-empty" class="w-full border rounded text-xs px-1" value="0.8" step="0.1"></div>
                    </div>
                    <div>
                        <div class="flex justify-between text-xs mb-1"><span>å¸æœºæ—¥è–ª (å…ƒ)</span><span id="val-salary" class="font-bold">500</span></div>
                        <input type="range" id="inp-salary" min="300" max="800" step="50" value="500">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <div class="flex justify-between text-[10px] mb-1"><span>è½®èƒ/km</span><span id="val-tire">0.25</span></div>
                            <input type="range" id="inp-tire" min="0" max="1" step="0.05" value="0.25">
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] mb-1"><span>ç»´ä¿/km</span><span id="val-maint">0.30</span></div>
                            <input type="range" id="inp-maint" min="0" max="1" step="0.05" value="0.30">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="text-[10px] text-slate-500">å¹´ä¿é™©</label><input type="number" id="inp-ins" class="w-full border rounded text-xs px-1" value="18000"></div>
                        <div><label class="text-[10px] text-slate-500">æœˆç®¡ç†è´¹</label><input type="number" id="inp-admin" class="w-full border rounded text-xs px-1" value="1000"></div>
                    </div>
                </div>
            </details>
            <div class="h-10"></div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto bg-slate-50 p-6 flex flex-col">
            
            <!-- Tab Navigation -->
            <div class="flex gap-6 border-b border-slate-200 mb-6 sticky top-0 bg-slate-50 z-10 pt-2">
                <button class="tab-btn active pb-2 px-1" onclick="switchTab('dashboard')">èµ„é‡‘æµä¸æ¦‚è§ˆ</button>
                <button class="tab-btn pb-2 px-1" onclick="switchTab('pnl')">åˆ©æ¶¦è¡¨ (P&L)</button>
                <button class="tab-btn pb-2 px-1" onclick="switchTab('bs')">èµ„äº§è´Ÿå€ºè¡¨</button>
            </div>

            <!-- Tab 1: Dashboard & Cash Flow -->
            <div id="tab-dashboard" class="space-y-6">
                <!-- KPI Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <p class="text-xs text-slate-500 uppercase">è½¦é˜Ÿè§„æ¨¡</p>
                        <p class="text-2xl font-bold text-slate-800"><span id="kpi-trucks">--</span> <span class="text-sm font-normal text-slate-400">è¾†</span></p>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <p class="text-xs text-slate-500 uppercase">åˆå§‹ç°é‡‘æµå‡º</p>
                        <p class="text-2xl font-bold text-rose-600"><span id="kpi-init-out">--</span> <span class="text-sm font-normal text-slate-400">ä¸‡</span></p>
                        <p class="text-[10px] text-slate-400">é¦–ä»˜+æŒ‚è½¦+é¦–å¹´ä¿é™©</p>
                    </div>
                     <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <p class="text-xs text-slate-500 uppercase">èµ„äº§æ€»é¢ (åŸå€¼)</p>
                        <p class="text-2xl font-bold text-indigo-600"><span id="kpi-asset">--</span> <span class="text-sm font-normal text-slate-400">ä¸‡</span></p>
                    </div>
                     <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <p class="text-xs text-slate-500 uppercase">èµ„é‡‘æ± æœ€ä½ä½™é¢</p>
                        <p class="text-2xl font-bold" id="kpi-min-cash">--</p>
                        <p class="text-[10px] font-bold" id="kpi-status">--</p>
                    </div>
                </div>

                <!-- Cash Flow Chart -->
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-800">èµ„é‡‘æ± ä»¿çœŸ (36ä¸ªæœˆ)</h3>
                        <div class="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded">çº¢çº¿=èµ„é‡‘æ–­è£‚è­¦æˆ’çº¿</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="chart-flow"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Profit & Loss (P&L) -->
            <div id="tab-pnl" class="hidden space-y-6">
                 <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-slate-100 bg-indigo-50/30 flex justify-between items-center">
                        <div>
                            <h3 class="font-bold text-slate-800">é¢„ä¼°åˆ©æ¶¦è¡¨ (Income Statement)</h3>
                            <p class="text-xs text-slate-500">å•ä½: ä¸‡å…ƒ | åŸºäºæƒè´£å‘ç”Ÿåˆ¶ (å«æŠ˜æ—§/åˆ©æ¯)</p>
                        </div>
                        <div class="text-right text-xs">
                            <span class="block text-slate-400">ç¨³æ€å‡€åˆ©ç‡</span>
                            <span class="font-bold text-emerald-600 text-lg" id="pnl-margin">--</span>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left table-dense">
                            <thead class="bg-slate-50 text-slate-500 text-xs uppercase">
                                <tr>
                                    <th class="pl-6">é¡¹ç›®</th>
                                    <th class="text-right">ç¬¬ä¸€å¹´</th>
                                    <th class="text-right">ç¬¬äºŒå¹´</th>
                                    <th class="text-right">ç¬¬ä¸‰å¹´</th>
                                    <th class="text-right pr-6">ç¨³æ€æœˆåº¦</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100 text-slate-700" id="table-pnl-body">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                    <div class="px-6 py-3 bg-slate-50 text-xs text-slate-500">
                        * æ³¨: "åˆ©æ¯æ”¯å‡º"éšæœ¬é‡‘å‡å°‘è€Œé€å¹´é€’å‡; "è½¦è¾†æŠ˜æ—§"æŒ‰<span id="txt-dep-years">5</span>å¹´ç›´çº¿æ³•è®¡ç®—; åˆ©æ¶¦è¡¨ä¸åŒ…å«æœ¬é‡‘å¿è¿˜ã€‚
                    </div>
                </div>
            </div>

            <!-- Tab 3: Balance Sheet -->
            <div id="tab-bs" class="hidden space-y-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Balance Sheet Table -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden lg:col-span-2">
                        <div class="px-6 py-4 border-b border-slate-100 bg-slate-50">
                            <h3 class="font-bold text-slate-800">ç®€æ˜“èµ„äº§è´Ÿå€ºè¡¨ (Balance Sheet)</h3>
                            <p class="text-xs text-slate-500">å•ä½: ä¸‡å…ƒ | å±•ç¤ºå¹´åº¦æœ«æ—¶ç‚¹çŠ¶æ€</p>
                        </div>
                        <table class="w-full text-sm text-left table-dense">
                            <thead class="bg-white text-slate-500 text-xs uppercase border-b border-slate-200">
                                <tr>
                                    <th class="pl-6 py-3">é¡¹ç›®</th>
                                    <th class="text-right">æœŸåˆ (Day 0)</th>
                                    <th class="text-right">ç¬¬1å¹´æœ«</th>
                                    <th class="text-right">ç¬¬2å¹´æœ«</th>
                                    <th class="text-right pr-6">ç¬¬3å¹´æœ«</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100" id="table-bs-body">
                                <!-- Populated JS -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Charts for BS Structure -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                        <h4 class="font-bold text-slate-700 text-sm mb-4 text-center">èµ„äº§ç»“æ„å˜åŒ–</h4>
                        <div class="h-64 relative w-full">
                            <canvas id="chart-assets"></canvas>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                        <h4 class="font-bold text-slate-700 text-sm mb-4 text-center">è´Ÿå€ºä¸æƒç›Šå˜åŒ–</h4>
                         <div class="h-64 relative w-full">
                            <canvas id="chart-liab"></canvas>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- State ---
        const state = {
            inputs: {
                capital: 2000, lag: 1.0,
                volume: 400, price: 43, dist: 180, load: 32, trips: 1, days: 350,
                tractorPrice: 44, trailerPrice: 10, downPct: 15, years: 3, rate: 5, depYears: 5, salvage: 5,
                elecPrice: 0.8, kwhFull: 1.6, kwhEmpty: 0.8, salary: 500,
                tire: 0.25, maint: 0.30, ins: 18000, admin: 1000
            }
        };

        // Charts
        let flowChart, assetChart, liabChart;

        // Utils
        const fmt = (n) => new Intl.NumberFormat('zh-CN', { maximumFractionDigits: 1 }).format(n);
        const fmtInt = (n) => new Intl.NumberFormat('zh-CN', { maximumFractionDigits: 0 }).format(n);

        // Logic
        function calculate() {
            const i = state.inputs;

            // 1. Scale
            const tonsPerTruck = i.load * i.trips * i.days;
            const trucks = Math.ceil((i.volume * 10000) / tonsPerTruck);

            // 2. Asset Values (Fleet Level)
            const tractorVal = i.tractorPrice * 10000 * trucks;
            const trailerVal = i.trailerPrice * 10000 * trucks;
            const totalAssetOriginal = tractorVal + trailerVal;
            
            const tractorDown = tractorVal * (i.downPct / 100);
            const tractorLoanOriginal = tractorVal - tractorDown;
            const trailerCash = trailerVal;
            
            const initialOutlay = tractorDown + trailerCash + (i.ins * trucks); // + Year 1 Ins

            // 3. Monthly Operational Data (Fleet)
            const tripsPerMonth = (i.trips * i.days) / 12;
            const revMonth = trucks * tripsPerMonth * i.load * i.price;
            
            const kmPerMonth = trucks * tripsPerMonth * i.dist * 2;
            const energyTrip = (i.dist * i.kwhFull) + (i.dist * i.kwhEmpty);
            const energyMonth = trucks * tripsPerMonth * energyTrip * i.elecPrice;
            
            const driverMonth = trucks * i.salary * (i.days / 12);
            const tireMaintMonth = kmPerMonth * (i.tire + i.maint);
            const adminMonth = trucks * i.admin;
            const insMonthAmortized = (trucks * i.ins) / 12;

            const opexCashMonth = energyMonth + driverMonth + tireMaintMonth + adminMonth; // Excl Ins (paid annually in cash flow)
            const ebitdaMonth = revMonth - (opexCashMonth + insMonthAmortized);

            // 4. Finance & Depreciation
            // Loan (PMT)
            const r = (i.rate / 100) / 12;
            const n = i.years * 12;
            const pmtMonth = tractorLoanOriginal * (r * Math.pow(1+r, n)) / (Math.pow(1+r, n) - 1);
            
            // Depreciation (Straight Line)
            const depreciableAmount = totalAssetVal = totalAssetOriginal * (1 - i.salvage/100);
            const depMonth = depreciableAmount / (i.depYears * 12);

            // 5. Simulation Arrays (36 Months)
            let cashBalance = (i.capital * 10000) - initialOutlay;
            let loanBalance = tractorLoanOriginal;
            let accumDep = 0;
            let retainedEarnings = 0; // Cumulative Net Profit

            const cashFlowData = [cashBalance];
            const assetsData = [], liabData = [], equityData = [];
            
            // Snapshots for BS (0, 12, 24, 36)
            const bsSnapshots = [];
            // Push Day 0 Snapshot
            bsSnapshots.push({
                cash: cashBalance,
                fixedAssets: totalAssetOriginal,
                loan: tractorLoanOriginal,
                equity: (i.capital * 10000) + retainedEarnings // Should match Assets - Liabilities
            });

            // P&L Annual Aggregates
            let pnlYears = [{rev:0, cogs:0, gp:0, exp:0, ebitda:0, dep:0, ebit:0, int:0, net:0}, {}, {}, {}]; // Y1, Y2, Y3, MonthlySteady

            for (let m = 1; m <= 36; m++) {
                // --- A. Cash Flow Calculation ---
                // Outflows
                let cashOut = opexCashMonth + pmtMonth;
                if (m === 13 || m === 25) cashOut += (i.ins * trucks); // Annual Ins payment
                
                // Inflows (Lag)
                let cashIn = 0;
                if (m > i.lag) cashIn = revMonth;
                
                cashBalance = cashBalance - cashOut + cashIn;
                cashFlowData.push(cashBalance);

                // --- B. Finance & BS Updates ---
                // Interest & Principal for this month
                let interestPayment = 0;
                let principalPayment = 0;
                
                if (m <= n) { // If loan active
                    interestPayment = loanBalance * r;
                    principalPayment = pmtMonth - interestPayment;
                    loanBalance -= principalPayment;
                }
                
                // Depreciation
                let currentDep = 0;
                if (m <= i.depYears * 12) {
                    currentDep = depMonth;
                    accumDep += currentDep;
                }

                // --- C. P&L Accumulation (Accrual Basis) ---
                const yearIdx = Math.floor((m-1)/12);
                if(yearIdx < 3) {
                    const y = pnlYears[yearIdx];
                    y.rev += revMonth;
                    y.cogs += (energyMonth + driverMonth + tireMaintMonth);
                    y.exp += (adminMonth + insMonthAmortized);
                    y.dep += currentDep;
                    y.int += interestPayment;
                }
                
                // Net Profit for Retained Earnings (Monthly)
                // Profit = Rev - COGS - Exp - Dep - Int
                const monthlyProfit = revMonth - (energyMonth + driverMonth + tireMaintMonth) - (adminMonth + insMonthAmortized) - currentDep - interestPayment;
                retainedEarnings += monthlyProfit;

                // BS Snapshots at year end
                if (m % 12 === 0) {
                    bsSnapshots.push({
                        cash: cashBalance,
                        fixedAssets: totalAssetOriginal - accumDep,
                        loan: loanBalance,
                        equity: (i.capital * 10000) + retainedEarnings // Verify: Assets = Cash + FA. Liab + Eq = Loan + Equity.
                    });
                }
            }

            // Steady State Monthly P&L (Month 37 projection without lag issues, loan active)
            // Avg interest roughly... take Month 1 interest for conservative or mid-term? Let's take Month 18 interest proxy.
            // Better: use Year 1 avg interest / 12.
            const steady = pnlYears[3];
            steady.rev = revMonth;
            steady.cogs = energyMonth + driverMonth + tireMaintMonth;
            steady.exp = adminMonth + insMonthAmortized;
            steady.dep = depMonth;
            steady.int = (pnlYears[0].int / 12); // Use Year 1 avg interest
            steady.net = steady.rev - steady.cogs - steady.exp - steady.dep - steady.int;

            // Derived P&L calculations (Gross Profit, EBITDA, etc)
            pnlYears.slice(0,3).forEach(y => {
                y.gp = y.rev - y.cogs;
                y.ebitda = y.gp - y.exp;
                y.ebit = y.ebitda - y.dep;
                y.net = y.ebit - y.int;
            });
            // Update steady stats
            steady.gp = steady.rev - steady.cogs;
            steady.ebitda = steady.gp - steady.exp;
            steady.ebit = steady.ebitda - steady.dep;

            return {
                trucks,
                initialOutlay,
                totalAssetOriginal,
                bsSnapshots,
                pnlYears,
                cashFlowData,
                minBalance: Math.min(...cashFlowData)
            };
        }

        // UI
        function updateUI() {
            const data = calculate();
            const i = state.inputs;

            // Headers
            document.getElementById('head-capital').innerText = i.capital + "ä¸‡";
            document.getElementById('head-lag').innerText = i.lag + "ä¸ªæœˆ";
            document.getElementById('head-trucks').innerText = data.trucks + "è¾†";

            // KPI Cards
            document.getElementById('kpi-trucks').innerText = data.trucks;
            document.getElementById('kpi-init-out').innerText = fmt(data.initialOutlay/10000);
            document.getElementById('kpi-asset').innerText = fmt(data.totalAssetOriginal/10000);
            
            const minBal = data.minBalance / 10000;
            const minBalEl = document.getElementById('kpi-min-cash');
            const statusEl = document.getElementById('kpi-status');
            
            minBalEl.innerText = fmt(minBal) + " ä¸‡";
            if(minBal < 0) {
                minBalEl.className = "text-2xl font-bold text-rose-600";
                statusEl.innerText = "âš ï¸ èµ„é‡‘é“¾æ–­è£‚";
                statusEl.className = "text-[10px] font-bold text-rose-600";
            } else {
                minBalEl.className = "text-2xl font-bold text-emerald-600";
                statusEl.innerText = "âœ… èµ„é‡‘å®‰å…¨";
                statusEl.className = "text-[10px] font-bold text-emerald-600";
            }

            // Sync Inputs Text
            const setTxt = (id, val) => document.getElementById(id).innerText = val;
            setTxt('val-capital', i.capital); setTxt('val-lag', i.lag);
            setTxt('val-volume', i.volume); setTxt('val-price', i.price);
            setTxt('val-dist', i.dist); setTxt('val-days', i.days);
            setTxt('val-tractor', i.tractorPrice); setTxt('val-trailer', i.trailerPrice);
            setTxt('val-elec', i.elecPrice); setTxt('val-salary', i.salary);
            setTxt('val-tire', i.tire); setTxt('val-maint', i.maint);

            // Chart: Cash Flow
            updateFlowChart(data.cashFlowData);

            // Table: P&L
            renderPnL(data.pnlYears);
            document.getElementById('txt-dep-years').innerText = i.depYears;
            
            // Table: Balance Sheet
            renderBS(data.bsSnapshots);
            updateStructureCharts(data.bsSnapshots);
        }

        function renderPnL(years) {
            const tbody = document.getElementById('table-pnl-body');
            const rows = [
                { l: 'è¥ä¸šæ”¶å…¥', k: 'rev', bold: true, cls: 'text-indigo-700' },
                { l: 'â– è¿è¥æˆæœ¬(COGS)', k: 'cogs', cls: 'text-slate-500' },
                { l: 'ğŸŸ° æ¯›åˆ©æ¶¦', k: 'gp', bold: true, bg: 'bg-slate-50' },
                { l: 'â– ç®¡ç†ä¸ä¿é™©è´¹ç”¨', k: 'exp', cls: 'text-slate-500' },
                { l: 'ğŸ’ EBITDA', k: 'ebitda', bold: true, cls: 'text-blue-600' },
                { l: 'â– è½¦è¾†æŠ˜æ—§æ‘Šé”€', k: 'dep', cls: 'text-slate-400 italic' },
                { l: 'æ¯ç¨å‰åˆ©æ¶¦ (EBIT)', k: 'ebit', cls: 'text-slate-600' },
                { l: 'â– åˆ©æ¯æ”¯å‡º', k: 'int', cls: 'text-rose-400' },
                { l: 'ğŸ’° å‡€åˆ©æ¶¦', k: 'net', bold: true, cls: 'text-emerald-600 text-base', bg: 'bg-emerald-50' }
            ];

            let html = '';
            rows.forEach(r => {
                let rowHtml = `<tr class="${r.bg || ''} hover:bg-slate-50">
                    <td class="pl-6 ${r.bold ? 'font-bold' : ''} ${r.cls || ''}">${r.l}</td>`;
                // Years 1-3
                for(let j=0; j<3; j++) {
                    rowHtml += `<td class="text-right ${r.bold?'font-bold':''}">${fmt(years[j][r.k]/10000)}</td>`;
                }
                // Steady Month
                rowHtml += `<td class="text-right pr-6 border-l border-slate-100 ${r.bold?'font-bold':''}">${fmt(years[3][r.k]/10000)}</td></tr>`;
                html += rowHtml;
            });
            tbody.innerHTML = html;

            const margin = (years[3].net / years[3].rev) * 100;
            document.getElementById('pnl-margin').innerText = margin.toFixed(1) + "%";
        }

        function renderBS(snaps) {
            const tbody = document.getElementById('table-bs-body');
            const data = {
                assets: [
                    { l: 'è´§å¸èµ„é‡‘ (Cash)', k: 'cash', cls: 'text-emerald-600' },
                    { l: 'å›ºå®šèµ„äº§å‡€å€¼', k: 'fixedAssets', cls: 'text-slate-600' },
                ],
                liab: [
                    { l: 'é“¶è¡Œè´·æ¬¾ (è´Ÿå€º)', k: 'loan', cls: 'text-rose-600' },
                    { l: 'æ‰€æœ‰è€…æƒç›Š', k: 'equity', cls: 'text-indigo-600 font-bold' }
                ]
            };

            let html = `<tr class="bg-slate-50 font-bold text-xs"><td colspan="5" class="pl-6 py-2 text-slate-400">èµ„äº§ (Assets)</td></tr>`;
            data.assets.forEach(r => {
                html += `<tr><td class="pl-8 ${r.cls}">${r.l}</td>`;
                snaps.forEach(s => html += `<td class="text-right">${fmt(s[r.k]/10000)}</td>`);
                html += `</tr>`;
            });
            // Total Assets
            html += `<tr class="bg-slate-50 font-bold border-t border-slate-200"><td class="pl-6">èµ„äº§æ€»è®¡</td>`;
            snaps.forEach(s => html += `<td class="text-right text-slate-800">${fmt((s.cash+s.fixedAssets)/10000)}</td>`);
            html += `</tr>`;

            html += `<tr class="bg-slate-50 font-bold text-xs"><td colspan="5" class="pl-6 py-2 text-slate-400 border-t border-slate-200">è´Ÿå€ºä¸æƒç›Š (Liabilities & Equity)</td></tr>`;
            data.liab.forEach(r => {
                html += `<tr><td class="pl-8 ${r.cls}">${r.l}</td>`;
                snaps.forEach(s => html += `<td class="text-right">${fmt(s[r.k]/10000)}</td>`);
                html += `</tr>`;
            });
            // Total L+E
            html += `<tr class="bg-slate-50 font-bold border-t border-slate-200"><td class="pl-6">è´Ÿå€ºä¸æƒç›Šæ€»è®¡</td>`;
            snaps.forEach(s => html += `<td class="text-right text-slate-800">${fmt((s.loan+s.equity)/10000)}</td>`);
            html += `</tr>`;

            tbody.innerHTML = html;
        }

        // --- Charts ---
        function updateFlowChart(data) {
            if(!flowChart) {
                const ctx = document.getElementById('chart-flow').getContext('2d');
                flowChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 37}, (_,i) => i===0 ? 'Day0' : `M${i}`),
                        datasets: [{
                            label: 'èµ„é‡‘ä½™é¢ (å…ƒ)',
                            data: [],
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            pointRadius: 2,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { ticks: { callback: v => v/10000 + 'ä¸‡' } } },
                        plugins: {
                            annotation: {
                                annotations: {
                                    line1: { type: 'line', yMin: 0, yMax: 0, borderColor: 'red', borderWidth: 2, borderDash: [5,5] }
                                }
                            }
                        }
                    }
                });
            }
            const min = Math.min(...data);
            flowChart.data.datasets[0].data = data;
            flowChart.data.datasets[0].borderColor = min < 0 ? '#F43F5E' : '#10B981';
            flowChart.data.datasets[0].backgroundColor = min < 0 ? 'rgba(244, 63, 94, 0.1)' : 'rgba(16, 185, 129, 0.1)';
            flowChart.update();
        }

        function updateStructureCharts(snaps) {
            // Prepare Data for 4 snapshots
            const labels = ['Day 0', 'Year 1', 'Year 2', 'Year 3'];
            const cash = snaps.map(s => s.cash);
            const fixed = snaps.map(s => s.fixedAssets);
            const loan = snaps.map(s => s.loan);
            const equity = snaps.map(s => s.equity);

            if(!assetChart) {
                const ctx1 = document.getElementById('chart-assets').getContext('2d');
                assetChart = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'ç°é‡‘', data: [], backgroundColor: '#34D399' },
                            { label: 'å›ºå®šèµ„äº§', data: [], backgroundColor: '#64748B' }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true, ticks: { display: false } } } }
                });
                const ctx2 = document.getElementById('chart-liab').getContext('2d');
                liabChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'è´Ÿå€º (è´·æ¬¾)', data: [], backgroundColor: '#F43F5E' },
                            { label: 'æƒç›Š (å‡€å€¼)', data: [], backgroundColor: '#4F46E5' }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true, ticks: { display: false } } } }
                });
            }

            assetChart.data.datasets[0].data = cash;
            assetChart.data.datasets[1].data = fixed;
            assetChart.update();

            liabChart.data.datasets[0].data = loan;
            liabChart.data.datasets[1].data = equity;
            liabChart.update();
        }

        function switchTab(tab) {
            ['dashboard', 'pnl', 'bs'].forEach(t => {
                document.getElementById('tab-'+t).classList.add('hidden');
            });
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById('tab-'+tab).classList.remove('hidden');
            event.target.classList.add('active');
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            const inputs = document.querySelectorAll('input');
            inputs.forEach(inp => inp.addEventListener('input', (e) => {
                const id = e.target.id.replace('inp-', '');
                const mapping = {
                    'dist': 'dist', 'kwh-full': 'kwhFull', 'kwh-empty': 'kwhEmpty',
                    'dep-years': 'depYears', 'salvage': 'salvage', 'down': 'downPct'
                };
                const key = mapping[id] || id.replace(/-([a-z])/g, (g) => g[1].toUpperCase());
                
                // Special mapping logic if needed, otherwise camelCase
                let finalKey = key;
                if(id === 'tractor') finalKey = 'tractorPrice';
                if(id === 'trailer') finalKey = 'trailerPrice';
                if(id === 'elec') finalKey = 'elecPrice';
                
                if (state.inputs.hasOwnProperty(finalKey)) {
                     state.inputs[finalKey] = parseFloat(e.target.value);
                }
                updateUI();
            }));

            updateUI();
        });

    </script>
</body>
</html>
