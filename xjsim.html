<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°ç–†é¡¹ç›®å…¨å£å¾„æ¨¡æ‹Ÿ(å®½å±ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-container { position: relative; width: 100%; height: 300px; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        /* Inputs */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: #4F46E5; cursor: pointer; margin-top: -6px; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #E2E8F0; border-radius: 2px;
        }
        
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        
        .table-dense td, .table-dense th { padding: 0.5rem 0.75rem; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 h-14 flex items-center px-6 shrink-0 z-20 justify-between shadow-sm">
        <div class="flex items-center gap-2">
            <div class="bg-indigo-600 text-white p-1 rounded font-bold text-xs">SIM</div>
            <h1 class="font-bold text-slate-800">æ–°ç–†ç”µåŠ¨é‡å¡ Â· åˆ†æœŸæŠ•å…¥è´¢åŠ¡ä»¿çœŸ</h1>
        </div>
        <div class="text-xs text-slate-500 flex gap-4">
            <span>åˆå§‹èµ„é‡‘: <strong class="text-emerald-600" id="head-capital">--</strong></span>
            <span>æ€»è½¦é˜Ÿè§„æ¨¡: <strong class="text-indigo-600" id="head-trucks">--</strong></span>
            <span>é¢„è®¡å¹´è¿åŠ›: <strong class="text-slate-700" id="head-capacity">--</strong> ä¸‡å¨</span>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <!-- Sidebar: Widened to 440px (~30% wider) & 2-Column Grid -->
        <aside class="w-[440px] bg-white border-r border-slate-200 overflow-y-auto custom-scroll flex flex-col shrink-0 z-10">
            
            <!-- 1. Capital & Deployment -->
            <details class="group border-b border-slate-100" open>
                <summary class="flex justify-between p-3 cursor-pointer bg-emerald-50 hover:bg-emerald-100 sticky top-0 z-10">
                    <span class="font-bold text-emerald-800 text-xs">ğŸš€ èµ„é‡‘ä¸åˆ†æœŸæŠ•å…¥ (Deployment)</span>
                    <span class="text-emerald-500">â–¼</span>
                </summary>
                <div class="p-4 grid grid-cols-2 gap-4">
                    <div>
                        <div class="flex justify-between text-xs mb-1"><span>åˆå§‹èµ„é‡‘ (ä¸‡)</span><span id="val-capital" class="font-bold text-emerald-600">2000</span></div>
                        <input type="range" id="inp-capital" min="500" max="10000" step="100" value="2000">
                    </div>
                    <div>
                        <div class="flex justify-between text-xs mb-1"><span>è´¦æœŸ (æœˆ)</span><span id="val-lag" class="font-bold text-rose-600">1.0</span></div>
                        <input type="range" id="inp-lag" min="0" max="6" step="0.5" value="1">
                    </div>
                    
                    <!-- Staged Deployment Inputs (Full Width) -->
                    <div class="col-span-2 bg-white border border-emerald-100 rounded p-2">
                        <div class="text-[10px] font-bold text-emerald-700 uppercase border-b border-emerald-100 pb-1 mb-2">è½¦è¾†åˆ†æœŸæŠ•å…¥è®¡åˆ’ (å°)</div>
                        <div class="grid grid-cols-6 gap-2">
                            <div><label class="text-[10px] text-slate-500 block text-center">M1</label><input type="number" id="inp-batch-1" class="w-full border rounded text-xs px-1 text-center" value="50"></div>
                            <div><label class="text-[10px] text-slate-500 block text-center">M2</label><input type="number" id="inp-batch-2" class="w-full border rounded text-xs px-1 text-center" value="50"></div>
                            <div><label class="text-[10px] text-slate-500 block text-center">M3</label><input type="number" id="inp-batch-3" class="w-full border rounded text-xs px-1 text-center" value="0"></div>
                            <div><label class="text-[10px] text-slate-500 block text-center">M4</label><input type="number" id="inp-batch-4" class="w-full border rounded text-xs px-1 text-center" value="0"></div>
                            <div><label class="text-[10px] text-slate-500 block text-center">M5</label><input type="number" id="inp-batch-5" class="w-full border rounded text-xs px-1 text-center" value="0"></div>
                            <div><label class="text-[10px] text-slate-500 block text-center">M6</label><input type="number" id="inp-batch-6" class="w-full border rounded text-xs px-1 text-center" value="0"></div>
                        </div>
                        <div class="text-right text-[10px] text-slate-400 mt-1">æ€»è®¡: <span id="val-total-trucks" class="font-bold text-slate-700">--</span> è¾†</div>
                    </div>
                </div>
            </details>

            <!-- 2. Business Scale -->
            <details class="group border-b border-slate-100" open>
                <summary class="flex justify-between p-3 cursor-pointer hover:bg-slate-50 border-t border-slate-100">
                    <span class="font-bold text-slate-700 text-xs">âš™ï¸ è¿è¥æ•ˆç‡ (Efficiency)</span>
                    <span class="text-slate-400">â–¼</span>
                </summary>
                <div class="p-4 grid grid-cols-2 gap-4">
                    <!-- Volume Calculated (Full Width) -->
                    <div class="col-span-2 p-2 bg-slate-50 rounded border border-slate-200 flex justify-between items-center">
                        <span class="text-[10px] text-slate-400 uppercase">å¹´è´§è¿æ€»äº§èƒ½ (è®¡ç®—å€¼)</span>
                        <div class="text-lg font-bold text-indigo-600"><span id="calc-volume">--</span> <span class="text-xs text-slate-500">ä¸‡å¨</span></div>
                    </div>

                    <div>
                        <div class="flex justify-between text-xs mb-1"><span>è¿ä»· (å…ƒ/å¨)</span><span id="val-price" class="font-bold">43</span></div>
                        <input type="range" id="inp-price" min="20" max="80" step="0.5" value="43">
                    </div>
                    <div>
                        <div class="flex justify-between text-xs mb-1"><span>å•ç¨‹ (km)</span><span id="val-dist" class="font-bold">180</span></div>
                        <input type="range" id="inp-dist" min="50" max="500" step="10" value="180">
                    </div>
                    <div>
                        <div class="flex justify-between text-xs mb-1"><span>è½½é‡ (å¨)</span><span id="val-load-disp" class="font-bold">32</span></div>
                        <input type="range" id="inp-load" min="20" max="60" step="1" value="32">
                    </div>
                    <div>
                         <div class="flex justify-between text-xs mb-1"><span>æ—¥è¶Ÿæ•°</span><span id="val-trips-disp" class="font-bold">1</span></div>
                         <input type="range" id="inp-trips" min="0.5" max="4" step="0.5" value="1">
                    </div>
                    <div class="col-span-2">
                        <div class="flex justify-between text-xs mb-1"><span>å¹´è¿è¥å¤©æ•°</span><span id="val-days" class="font-bold">350</span></div>
                        <input type="range" id="inp-days" min="200" max="365" step="5" value="350">
                    </div>
                </div>
            </details>

            <!-- 3. Asset & Finance -->
            <details class="group border-b border-slate-100">
                <summary class="flex justify-between p-3 cursor-pointer hover:bg-slate-50 border-t border-slate-100">
                    <span class="font-bold text-slate-700 text-xs">ğŸ¦ èµ„äº§ä¸é‡‘è (Capex)</span>
                    <span class="text-slate-400">â–¼</span>
                </summary>
                <div class="p-4 grid grid-cols-2 gap-4">
                    <!-- Tractor Block -->
                    <div class="col-span-1 p-2 bg-indigo-50 rounded border border-indigo-100">
                        <div class="text-[10px] font-bold text-indigo-800 uppercase mb-2">ç‰µå¼•è½¦ (è´·æ¬¾)</div>
                        <div class="flex justify-between text-xs mb-1"><span>å•ä»·</span><span id="val-tractor" class="font-bold">44</span></div>
                        <input type="range" id="inp-tractor" min="30" max="60" value="44">
                        <div class="grid grid-cols-2 gap-2 mt-2">
                            <div><label class="text-[10px] block">é¦–ä»˜%</label><input type="number" id="inp-down" class="w-full border rounded text-xs px-1" value="15"></div>
                            <div><label class="text-[10px] block">å¹´é™</label><input type="number" id="inp-years" class="w-full border rounded text-xs px-1" value="3"></div>
                        </div>
                    </div>
                    <!-- Trailer Block -->
                    <div class="col-span-1 p-2 bg-slate-100 rounded border border-slate-200">
                        <div class="text-[10px] font-bold text-slate-600 uppercase mb-2">æŒ‚è½¦ (å…¨æ¬¾)</div>
                        <div class="flex justify-between text-xs mb-1"><span>å•ä»·</span><span id="val-trailer" class="font-bold">10</span></div>
                        <input type="range" id="inp-trailer" min="5" max="20" step="0.5" value="10">
                    </div>
                    
                    <div>
                        <div class="flex justify-between text-xs mb-1"><span>åˆ©ç‡%</span><span id="val-rate-disp" class="font-bold">5</span></div>
                        <input type="range" id="inp-rate" min="2" max="10" step="0.1" value="5">
                    </div>
                     <div>
                        <div class="flex justify-between text-xs mb-1"><span>æŠ˜æ—§å¹´</span><span id="val-dep-disp" class="font-bold">5</span></div>
                        <input type="range" id="inp-dep-years" min="3" max="10" step="1" value="5">
                    </div>
                </div>
            </details>

            <!-- 4. Operational Costs -->
            <details class="group border-b border-slate-100" open>
                <summary class="flex justify-between p-3 cursor-pointer hover:bg-slate-50 border-t border-slate-100">
                    <span class="font-bold text-slate-700 text-xs">ğŸ› ï¸ è¿è¥æˆæœ¬ (Opex)</span>
                    <span class="text-slate-400">â–¼</span>
                </summary>
                <div class="p-4 grid grid-cols-2 gap-4">
                    <div>
                        <div class="flex justify-between text-xs mb-1"><span>ç”µä»· (å…ƒ)</span><span id="val-elec" class="font-bold">0.8</span></div>
                        <input type="range" id="inp-elec" min="0.3" max="1.5" step="0.05" value="0.8">
                    </div>
                    <div>
                        <div class="flex justify-between text-xs mb-1"><span>å¸æœºæ—¥è–ª</span><span id="val-salary" class="font-bold">500</span></div>
                        <input type="range" id="inp-salary" min="300" max="800" step="50" value="500">
                    </div>
                    
                    <div>
                         <div class="flex justify-between text-xs mb-1"><span>é‡è½½ç”µè€—</span><span id="val-kwh-full" class="font-bold">1.6</span></div>
                         <input type="range" id="inp-kwh-full" min="1" max="3" step="0.1" value="1.6">
                    </div>
                    <div>
                         <div class="flex justify-between text-xs mb-1"><span>ç©ºè½½ç”µè€—</span><span id="val-kwh-empty" class="font-bold">0.8</span></div>
                         <input type="range" id="inp-kwh-empty" min="0.5" max="1.5" step="0.1" value="0.8">
                    </div>

                    <div>
                        <div class="flex justify-between text-xs mb-1"><span>è½®èƒ/km</span><span id="val-tire" class="font-bold">0.25</span></div>
                        <input type="range" id="inp-tire" min="0" max="1" step="0.05" value="0.25">
                    </div>
                    <div>
                        <div class="flex justify-between text-xs mb-1"><span>ç»´ä¿/km</span><span id="val-maint" class="font-bold">0.30</span></div>
                        <input type="range" id="inp-maint" min="0" max="1" step="0.05" value="0.30">
                    </div>
                    
                    <div><label class="text-[10px] text-slate-500 block mb-1">å¹´ä¿é™©</label><input type="number" id="inp-ins" class="w-full border rounded text-xs px-1 py-1" value="18000"></div>
                    <div><label class="text-[10px] text-slate-500 block mb-1">æœˆç®¡ç†è´¹</label><input type="number" id="inp-admin" class="w-full border rounded text-xs px-1 py-1" value="1000"></div>
                </div>
            </details>
            <div class="h-10"></div>
        </aside>

        <!-- Main Content (Vertical Stack) -->
        <main class="flex-1 overflow-y-auto bg-slate-50 p-6 flex flex-col gap-6">
            
            <!-- SECTION 1: Cash Flow & Dashboard -->
            <div id="section-dashboard" class="space-y-6">
                <div class="flex items-center gap-2 mb-2">
                    <span class="w-1 h-6 bg-emerald-500 rounded"></span>
                    <h2 class="text-lg font-bold text-slate-800">1. èµ„é‡‘æµä¸æ ¸å¿ƒæŒ‡æ ‡</h2>
                </div>

                <!-- KPI Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <p class="text-xs text-slate-500 uppercase">ç´¯è®¡æŠ•å…¥è½¦è¾†</p>
                        <p class="text-2xl font-bold text-slate-800"><span id="kpi-trucks">--</span> <span class="text-sm font-normal text-slate-400">è¾†</span></p>
                        <p class="text-[10px] text-slate-400">åˆ†6æœŸå®ŒæˆæŠ•æ”¾</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <p class="text-xs text-slate-500 uppercase">èµ„äº§æ€»åŸå€¼</p>
                        <p class="text-2xl font-bold text-indigo-600"><span id="kpi-asset">--</span> <span class="text-sm font-normal text-slate-400">ä¸‡</span></p>
                    </div>
                     <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <p class="text-xs text-slate-500 uppercase">æœ€å¤§èµ„é‡‘å ç”¨</p>
                        <p class="text-2xl font-bold text-rose-600" id="kpi-max-out">--</p>
                    </div>
                     <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <p class="text-xs text-slate-500 uppercase">æœ€ä½èµ„é‡‘ä½™é¢</p>
                        <p class="text-2xl font-bold" id="kpi-min-cash">--</p>
                        <p class="text-[10px] font-bold" id="kpi-status">--</p>
                    </div>
                </div>

                <!-- Cash Flow Chart -->
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-800">èµ„é‡‘æ± ä»¿çœŸ (36ä¸ªæœˆ)</h3>
                        <div class="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded">åŸºäºåˆ†æœŸæŠ•å…¥ä¸è´¦æœŸæ»åæ¨¡æ‹Ÿ</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="chart-flow"></canvas>
                    </div>
                </div>
            </div>

            <!-- SECTION 2: P&L -->
            <div id="section-pnl" class="space-y-4">
                 <div class="flex items-center gap-2">
                    <span class="w-1 h-6 bg-indigo-500 rounded"></span>
                    <h2 class="text-lg font-bold text-slate-800">2. åˆ©æ¶¦è¡¨ (Income Statement)</h2>
                </div>

                 <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                        <div>
                            <p class="text-xs text-slate-500">å•ä½: ä¸‡å…ƒ | å«æŠ˜æ—§ä¸åˆ©æ¯ | ä¸å«æœ¬é‡‘å¿è¿˜</p>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left table-dense">
                            <thead class="bg-slate-50 text-slate-500 text-xs uppercase border-b border-slate-200">
                                <tr>
                                    <th class="pl-6 py-3">é¡¹ç›®</th>
                                    <th class="text-right">ç¬¬ä¸€å¹´</th>
                                    <th class="text-right">ç¬¬äºŒå¹´</th>
                                    <th class="text-right pr-6">ç¬¬ä¸‰å¹´</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100 text-slate-700" id="table-pnl-body">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SECTION 3: Balance Sheet -->
            <div id="section-bs" class="space-y-4">
                <div class="flex items-center gap-2">
                    <span class="w-1 h-6 bg-slate-500 rounded"></span>
                    <h2 class="text-lg font-bold text-slate-800">3. èµ„äº§è´Ÿå€ºè¡¨ (Balance Sheet)</h2>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-slate-100 bg-slate-50">
                        <p class="text-xs text-slate-500">å•ä½: ä¸‡å…ƒ | å„å¹´æœ«æ—¶ç‚¹å¿«ç…§</p>
                    </div>
                    <table class="w-full text-sm text-left table-dense">
                        <thead class="bg-white text-slate-500 text-xs uppercase border-b border-slate-200">
                            <tr>
                                <th class="pl-6 py-3">é¡¹ç›®</th>
                                <th class="text-right">æœŸåˆ (Day 0)</th>
                                <th class="text-right">ç¬¬1å¹´æœ«</th>
                                <th class="text-right">ç¬¬2å¹´æœ«</th>
                                <th class="text-right pr-6">ç¬¬3å¹´æœ«</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100" id="table-bs-body">
                            <!-- Populated JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="h-10"></div>
        </main>
    </div>

    <script>
        // --- State ---
        const state = {
            inputs: {
                capital: 2000, lag: 1.0,
                // Deployment Schedule (Batches for first 6 months)
                batches: [50, 50, 0, 0, 0, 0], 
                
                // Op Params
                price: 43, dist: 180, load: 32, trips: 1, days: 350,
                
                // Asset
                tractorPrice: 44, trailerPrice: 10, downPct: 15, years: 3, rate: 5, depYears: 5, salvage: 5,
                
                // Opex
                elecPrice: 0.8, kwhFull: 1.6, kwhEmpty: 0.8, salary: 500,
                tire: 0.25, maint: 0.30, ins: 18000, admin: 1000
            }
        };

        // Charts
        let flowChart;

        // Utils
        const fmt = (n) => new Intl.NumberFormat('zh-CN', { maximumFractionDigits: 1 }).format(n);
        const fmtInt = (n) => new Intl.NumberFormat('zh-CN', { maximumFractionDigits: 0 }).format(n);

        // --- Core Calculation Engine ---
        function calculate() {
            const i = state.inputs;

            // 1. Total Fleet & Capacity (Reverse Logic)
            const totalTrucks = i.batches.reduce((a, b) => a + b, 0);
            const capacityPerTruck = i.load * i.trips * i.days;
            const totalVolumeWanTons = (totalTrucks * capacityPerTruck) / 10000;

            // 2. Unit Economics (Monthly per Truck)
            const tripsPerMonth = (i.trips * i.days) / 12;
            const revPerTruckMonth = tripsPerMonth * i.load * i.price;
            
            const kmPerMonth = tripsPerMonth * i.dist * 2;
            const energyPerTrip = (i.dist * i.kwhFull) + (i.dist * i.kwhEmpty);
            const energyMonth = tripsPerMonth * energyPerTrip * i.elecPrice;
            const driverMonth = i.salary * (i.days / 12);
            const tireMaintMonth = kmPerMonth * (i.tire + i.maint);
            const adminMonth = i.admin;
            const insMonthAmort = i.ins / 12; // For P&L accrual
            
            const cogsMonth = energyMonth + driverMonth + tireMaintMonth;
            const expMonth = adminMonth + insMonthAmort;
            
            // 3. Asset & Loan Logic (Per Unit)
            const tractorVal = i.tractorPrice * 10000;
            const trailerVal = i.trailerPrice * 10000;
            const unitAssetVal = tractorVal + trailerVal;
            
            const tractorDown = tractorVal * (i.downPct / 100);
            const trailerCash = trailerVal; // 100% Cash
            const unitInitialCashOut = tractorDown + trailerCash;
            
            const unitLoanPrincipal = tractorVal - tractorDown;
            
            // PMT Calculation
            const r = (i.rate / 100) / 12;
            const n = i.years * 12;
            const unitPmt = unitLoanPrincipal * (r * Math.pow(1+r, n)) / (Math.pow(1+r, n) - 1);
            
            // Depreciation (Per Unit)
            const unitDepreciable = unitAssetVal * (1 - i.salvage/100);
            const unitDepMonth = unitDepreciable / (i.depYears * 12);

            // 4. Simulation (36 Months)
            let cashBalance = i.capital * 10000;
            let retainedEarnings = 0;
            
            // Track active loans: array of { startMonth: m, principal: p }
            // Simplifying: Aggregate fleet state
            // Instead of tracking individual loans, we track "Active Trucks" and "Loan Schedules"
            
            let activeTrucks = 0;
            let activeAssetOriginalVal = 0;
            let accumDep = 0;
            let totalLoanBalance = 0;

            const cashFlowData = [cashBalance];
            const pnlYears = [{rev:0, cogs:0, exp:0, dep:0, int:0, net:0}, {}, {}]; // Y1, Y2, Y3
            const bsSnapshots = [{
                cash: cashBalance, fixed: 0, loan: 0, equity: cashBalance
            }];

            // To track interest accurately with staged deployment:
            // We need a schedule of added trucks.
            // Let's pre-calculate the loan amortization schedule for ONE truck.
            const singleLoanSchedule = [];
            let tempPrincipal = unitLoanPrincipal;
            for(let lm=1; lm<=n; lm++) {
                let interest = tempPrincipal * r;
                let principal = unitPmt - interest;
                tempPrincipal -= principal;
                singleLoanSchedule.push({int: interest, prin: principal, bal: tempPrincipal});
            }

            for (let m = 1; m <= 36; m++) {
                // A. Deployment (New Batch?)
                let newTrucks = 0;
                if (m <= 6) {
                    newTrucks = i.batches[m-1];
                    if (newTrucks > 0) {
                        activeTrucks += newTrucks;
                        activeAssetOriginalVal += (newTrucks * unitAssetVal);
                        totalLoanBalance += (newTrucks * unitLoanPrincipal);
                        
                        // Cash Out: Down Pmt + Trailer + Year 1 Ins
                        const cashOutCapex = newTrucks * (unitInitialCashOut + i.ins);
                        cashBalance -= cashOutCapex;
                    }
                }

                // B. Insurance Renewals (Year 2 & 3)
                // If trucks deployed in M1, renew in M13, M25.
                // If deployed in M2, renew in M14, M26.
                // Check past batches
                for(let b=0; b<6; b++) {
                    const batchSize = i.batches[b];
                    const deployMonth = b+1;
                    if(batchSize > 0) {
                        if (m === deployMonth + 12 || m === deployMonth + 24) {
                            cashBalance -= (batchSize * i.ins);
                        }
                    }
                }

                // C. Operations (Cash & P&L)
                const revTotal = activeTrucks * revPerTruckMonth;
                const cogsTotal = activeTrucks * cogsMonth; // Cash cost
                const adminTotal = activeTrucks * i.admin; // Cash cost
                
                // Cash Flow In (Lag)
                // Rev generated in 'm' comes in 'm + lag'.
                // So CashIn in 'm' comes from Rev in 'm - lag'.
                // If lag is fractional (e.g. 1.5), we interpolate? 
                // Instruction said "1 month default", let's stick to simple integer lag logic or simple float delay.
                // Simple logic: If m > lag, we receive revenue from active trucks (m - lag).
                // Let's look back 'lag' months to see how many trucks were active.
                // Approx: Revenue inflow based on trucks active (m - lag).
                let trucksGeneratingCash = 0;
                const lookbackIndex = Math.floor(m - i.lag);
                if (lookbackIndex >= 1) {
                    // How many trucks were active at lookbackIndex?
                    // Re-sum batches
                    for(let b=0; b<6; b++) {
                        if((b+1) <= lookbackIndex) trucksGeneratingCash += i.batches[b];
                    }
                }
                const cashInRev = trucksGeneratingCash * revPerTruckMonth;

                // Cash Flow Out (Ops)
                const cashOutOps = (activeTrucks * cogsMonth) + (activeTrucks * i.admin);
                
                // D. Loan Repayment (Principal + Interest)
                let totalIntPayment = 0;
                let totalPrinPayment = 0;
                
                for(let b=0; b<6; b++) {
                    const batchSize = i.batches[b];
                    if(batchSize > 0) {
                        const deployMonth = b+1;
                        const loanMonthIndex = m - deployMonth; // 0-based index for schedule
                        if (loanMonthIndex >= 0 && loanMonthIndex < singleLoanSchedule.length) {
                            totalIntPayment += (batchSize * singleLoanSchedule[loanMonthIndex].int);
                            totalPrinPayment += (batchSize * singleLoanSchedule[loanMonthIndex].prin);
                        }
                    }
                }
                const cashOutLoan = totalIntPayment + totalPrinPayment;
                totalLoanBalance -= totalPrinPayment;

                // E. Net Cash Move
                cashBalance = cashBalance + cashInRev - cashOutOps - cashOutLoan;
                cashFlowData.push(cashBalance);

                // F. Depreciation
                // Only for active trucks
                const currentDep = activeTrucks * unitDepMonth;
                accumDep += currentDep;

                // G. P&L Accumulation
                const yearIdx = Math.floor((m-1)/12);
                if(yearIdx < 3) {
                    const y = pnlYears[yearIdx];
                    y.rev += revTotal;
                    y.cogs += cogsTotal;
                    y.exp += (adminTotal + (activeTrucks * insMonthAmort));
                    y.dep += currentDep;
                    y.int += totalIntPayment;
                }

                // H. Retained Earnings Update
                const monthNetProfit = revTotal - cogsTotal - (adminTotal + (activeTrucks * insMonthAmort)) - currentDep - totalIntPayment;
                retainedEarnings += monthNetProfit;

                // I. BS Snapshot (End of Year)
                if (m % 12 === 0) {
                    bsSnapshots.push({
                        cash: cashBalance,
                        fixed: activeAssetOriginalVal - accumDep,
                        loan: totalLoanBalance,
                        equity: (i.capital * 10000) + retainedEarnings
                    });
                }
            }

            // Calc P&L Net
            pnlYears.forEach(y => {
                y.net = y.rev - y.cogs - y.exp - y.dep - y.int;
            });

            return {
                totalTrucks,
                calcVolume: totalVolumeWanTons,
                totalAssetVal: activeAssetOriginalVal,
                cashFlowData,
                pnlYears,
                bsSnapshots,
                minBalance: Math.min(...cashFlowData),
                maxOutlay: (i.capital * 10000) - Math.min(...cashFlowData)
            };
        }

        // --- UI Updates ---
        function updateUI() {
            const data = calculate();
            const i = state.inputs;

            // Header
            document.getElementById('head-capital').innerText = i.capital + "ä¸‡";
            document.getElementById('head-trucks').innerText = data.totalTrucks + "è¾†";
            document.getElementById('head-capacity').innerText = fmt(data.calcVolume);

            // Sidebar Texts
            const setTxt = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; };
            setTxt('val-capital', i.capital); setTxt('val-lag', i.lag); setTxt('val-total-trucks', data.totalTrucks);
            setTxt('calc-volume', fmt(data.calcVolume));
            setTxt('val-price', i.price); setTxt('val-dist', i.dist); setTxt('val-load-disp', i.load); setTxt('val-trips-disp', i.trips);
            setTxt('val-days', i.days); setTxt('val-tractor', i.tractorPrice); setTxt('val-trailer', i.trailerPrice);
            setTxt('val-rate-disp', i.rate); setTxt('val-dep-disp', i.depYears);
            setTxt('val-elec', i.elecPrice); setTxt('val-salary', i.salary);
            setTxt('val-kwh-full', i.kwhFull); setTxt('val-kwh-empty', i.kwhEmpty);
            setTxt('val-tire', i.tire); setTxt('val-maint', i.maint);

            // KPI Cards
            document.getElementById('kpi-trucks').innerText = data.totalTrucks;
            document.getElementById('kpi-asset').innerText = fmt(data.totalAssetVal/10000);
            document.getElementById('kpi-max-out').innerText = fmt(data.maxOutlay/10000) + " ä¸‡";
            
            const minBal = data.minBalance / 10000;
            const minEl = document.getElementById('kpi-min-cash');
            const statEl = document.getElementById('kpi-status');
            minEl.innerText = fmt(minBal) + " ä¸‡";
            if(minBal < 0) {
                minEl.className = "text-2xl font-bold text-rose-600";
                statEl.innerText = "âš ï¸ èµ„é‡‘æ–­è£‚";
                statEl.className = "text-[10px] font-bold text-rose-600";
            } else {
                minEl.className = "text-2xl font-bold text-emerald-600";
                statEl.innerText = "âœ… èµ„é‡‘å®‰å…¨";
                statEl.className = "text-[10px] font-bold text-emerald-600";
            }

            // Tables & Charts
            updateFlowChart(data.cashFlowData);
            renderPnL(data.pnlYears);
            renderBS(data.bsSnapshots);
        }

        function renderPnL(years) {
            const tbody = document.getElementById('table-pnl-body');
            const rows = [
                { l: 'è¥ä¸šæ”¶å…¥', k: 'rev', b: true, c: 'text-indigo-700' },
                { l: 'â– è¿è¥æˆæœ¬ (COGS)', k: 'cogs', c: 'text-slate-500' },
                { l: 'â– ç®¡ç†ä¸ä¿é™©', k: 'exp', c: 'text-slate-500' },
                { l: 'â– è½¦è¾†æŠ˜æ—§', k: 'dep', c: 'text-slate-400 italic' },
                { l: 'â– åˆ©æ¯æ”¯å‡º', k: 'int', c: 'text-rose-400' },
                { l: 'ğŸ’° å‡€åˆ©æ¶¦', k: 'net', b: true, c: 'text-emerald-600 text-base', bg: 'bg-emerald-50' }
            ];
            let html = '';
            rows.forEach(r => {
                html += `<tr class="${r.bg||''} hover:bg-slate-50"><td class="pl-6 py-2 ${r.b?'font-bold':''} ${r.c||''}">${r.l}</td>`;
                years.forEach(y => html += `<td class="text-right py-2 ${r.b?'font-bold':''}">${fmt(y[r.k]/10000)}</td>`);
                html += `</tr>`;
            });
            tbody.innerHTML = html;
        }

        function renderBS(snaps) {
            const tbody = document.getElementById('table-bs-body');
            const items = [
                { l: 'è´§å¸èµ„é‡‘ (Cash)', k: 'cash', c: 'text-emerald-600' },
                { l: 'å›ºå®šèµ„äº§å‡€å€¼', k: 'fixed', c: 'text-slate-600' },
                { l: 'èµ„äº§æ€»è®¡', k: 'totalA', b: true, bg: 'bg-slate-50 border-t' },
                { l: 'é“¶è¡Œè´·æ¬¾ (è´Ÿå€º)', k: 'loan', c: 'text-rose-600' },
                { l: 'æ‰€æœ‰è€…æƒç›Š', k: 'equity', c: 'text-indigo-600' },
                { l: 'è´Ÿå€ºä¸æƒç›Šæ€»è®¡', k: 'totalLE', b: true, bg: 'bg-slate-50 border-t' }
            ];
            let html = '';
            items.forEach(r => {
                html += `<tr class="${r.bg||''} hover:bg-slate-50"><td class="pl-6 py-2 ${r.b?'font-bold':''} ${r.c||''}">${r.l}</td>`;
                snaps.forEach(s => {
                    let val = 0;
                    if(r.k === 'totalA') val = s.cash + s.fixed;
                    else if(r.k === 'totalLE') val = s.loan + s.equity;
                    else val = s[r.k];
                    html += `<td class="text-right py-2 ${r.b?'font-bold':''}">${fmt(val/10000)}</td>`;
                });
                html += `</tr>`;
            });
            tbody.innerHTML = html;
        }

        function updateFlowChart(data) {
            if(!flowChart) {
                const ctx = document.getElementById('chart-flow').getContext('2d');
                flowChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 37}, (_,i) => i===0 ? 'Start' : `M${i}`),
                        datasets: [{
                            label: 'èµ„é‡‘ä½™é¢ (å…ƒ)',
                            data: [],
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true, tension: 0.4, pointRadius: 2
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: { y: { ticks: { callback: v => v/10000 + 'ä¸‡' } } },
                        plugins: { annotation: { annotations: { line1: { type: 'line', yMin: 0, yMax: 0, borderColor: 'red', borderWidth: 2, borderDash: [5,5] } } } }
                    }
                });
            }
            const min = Math.min(...data);
            flowChart.data.datasets[0].data = data;
            flowChart.data.datasets[0].borderColor = min < 0 ? '#F43F5E' : '#10B981';
            flowChart.data.datasets[0].backgroundColor = min < 0 ? 'rgba(244, 63, 94, 0.1)' : 'rgba(16, 185, 129, 0.1)';
            flowChart.update();
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            const bind = (id, key, isBatch=false, idx=0) => {
                const el = document.getElementById(id);
                if(el) el.addEventListener('input', (e) => {
                    const v = parseFloat(e.target.value);
                    if(isBatch) state.inputs.batches[idx] = v;
                    else state.inputs[key] = v;
                    updateUI();
                });
            };

            bind('inp-capital', 'capital'); bind('inp-lag', 'lag');
            bind('inp-price', 'price'); bind('inp-dist', 'dist'); bind('inp-load', 'load'); bind('inp-trips', 'trips'); bind('inp-days', 'days');
            bind('inp-tractor', 'tractorPrice'); bind('inp-trailer', 'trailerPrice'); bind('inp-down', 'downPct'); bind('inp-years', 'years'); bind('inp-rate', 'rate');
            bind('inp-dep-years', 'depYears'); bind('inp-kwh-full', 'kwhFull'); bind('inp-kwh-empty', 'kwhEmpty');
            bind('inp-elec', 'elecPrice'); bind('inp-salary', 'salary'); bind('inp-tire', 'tire'); bind('inp-maint', 'maint');
            bind('inp-ins', 'ins'); bind('inp-admin', 'admin');

            for(let i=1; i<=6; i++) bind(`inp-batch-${i}`, '', true, i-1);

            updateUI();
        });
    </script>
</body>
</html>
