<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6214772877334340"
     crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 Global Route Profitability Model v6.1 (Stable)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    
    <!-- Plotly.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.27.0/plotly.min.js"></script>

    <!-- Google Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            background-color: #f8fafc;
            color: #0f172a;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        /* Form Controls */
        .input-group label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            font-weight: 700;
            margin-bottom: 2px;
            display: block;
        }
        
        .input-group input[type="number"], .input-group select {
            width: 100%;
            padding: 4px 8px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: #334155;
            transition: all 0.2s;
            background-color: #fff;
            height: 28px;
        }

        .input-group input:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        .input-group input:disabled {
            background-color: #f1f5f9;
            color: #94a3b8;
            cursor: not-allowed;
        }

        /* Range Slider */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.2s;
        }

        /* Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .kpi-value { font-family: 'JetBrains Mono', monospace; }
        
        /* Language Switcher */
        .lang-switch {
            font-size: 0.7rem;
            font-weight: 600;
            background: #1e293b;
            color: #94a3b8;
            padding: 2px;
            border-radius: 4px;
            display: flex;
            cursor: pointer;
            border: 1px solid #334155;
        }
        .lang-option { padding: 2px 6px; border-radius: 2px; transition: all 0.2s; }
        .lang-active { background: #3b82f6; color: white; }

        /* Panel Header */
        .panel-header {
            padding: 0.5rem 1rem;
            background-color: #f1f5f9;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .panel-title { font-size: 0.75rem; font-weight: 700; color: #475569; text-transform: uppercase; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Top Navigation -->
    <header class="relative bg-slate-900 text-white shadow-lg z-30 flex-none h-14 flex items-center justify-between px-4 border-b border-slate-700">
        <!-- Brand -->
        <div class="flex items-center space-x-3 w-1/4">
            <div class="bg-blue-600 w-7 h-7 rounded flex items-center justify-center font-bold text-xs shadow-md">Pro</div>
            <div>
                <h1 class="font-bold text-sm tracking-wide leading-tight" data-i18n="appTitle">全球航线收益精算系统</h1>
                <div class="text-[10px] text-slate-400">Route Profitability Model v6.1</div>
            </div>
        </div>
        
        <!-- Logo -->
        <div class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2">
            <img src="https://globalbusinessinsight.github.io/picture/inossem_logo.svg" alt="Inossem Logo" style="height: 22px; opacity: 0.9;">
        </div>
        
        <!-- Controls -->
        <div class="flex items-center justify-end space-x-4 w-1/4">
            <div class="flex items-center bg-slate-800 rounded px-2 py-1 border border-slate-700">
                <label class="text-[10px] text-slate-400 mr-2 font-bold" data-i18n="lblExch">汇率 (USD/CNY)</label>
                <input type="number" id="global-exch" value="7.28" step="0.01" class="w-12 bg-transparent text-right font-mono font-bold text-green-400 border-none focus:ring-0 p-0 text-xs" onchange="updateFuelFromUSD()">
            </div>
            
            <div class="flex items-center bg-slate-800 rounded px-2 py-1 border border-slate-700">
                <label class="text-[10px] text-slate-400 mr-2 font-bold" data-i18n="lblOil">油价 (Brent)</label>
                <input type="number" id="global-oil" value="78" step="1" class="w-10 bg-transparent text-right font-mono font-bold text-yellow-400 border-none focus:ring-0 p-0 text-xs" onchange="updateFuelFromUSD()">
                <span class="text-[10px] text-slate-500 ml-1">/bbl</span>
            </div>

            <div class="lang-switch" onclick="toggleLanguage()">
                <span id="lang-cn" class="lang-option lang-active">CN</span>
                <span id="lang-en" class="lang-option">EN</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex flex-grow overflow-hidden relative">
        
        <!-- LEFT SIDEBAR: INPUTS -->
        <aside class="w-[380px] bg-white border-r border-slate-200 flex flex-col z-20 shadow-[2px_0_15px_rgba(0,0,0,0.03)] h-full">
            <div class="panel-header">
                <span class="panel-title" data-i18n="secParams">参数配置</span>
                <button onclick="resetDefaults()" class="text-[10px] text-blue-600 hover:text-blue-800 transition-colors font-semibold" data-i18n="btnReset">重置默认值</button>
            </div>
            
            <div class="flex-grow overflow-y-auto custom-scroll p-4 space-y-5">
                
                <!-- Section 1: Route -->
                <div class="space-y-2">
                    <h3 class="text-xs font-bold text-slate-800 border-l-4 border-blue-500 pl-2 flex justify-between items-center">
                        <span data-i18n="secOps">1. 航线与运营</span>
                        <span id="ac-type-badge" class="text-[9px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded border border-slate-200 font-mono">B777-300ER</span>
                    </h3>
                    
                    <div class="bg-slate-50 p-3 rounded border border-slate-200">
                        <div class="input-group mb-3">
                            <label data-i18n="lblRoute">航线预设</label>
                            <select id="sel-route" onchange="updateRouteParams()" class="font-semibold text-slate-700">
                                <optgroup label="跨太平洋 (Trans-Pacific)" data-i18n-label="grpTP">
                                    <option value="PEK-LAX">PEK - LAX (北京-洛杉矶)</option>
                                    <option value="PEK-JFK">PEK - JFK (北京-纽约)</option>
                                    <option value="PVG-SFO">PVG - SFO (上海-旧金山)</option>
                                </optgroup>
                                <optgroup label="跨大西洋 (Trans-Atlantic)" data-i18n-label="grpTA">
                                    <option value="LHR-JFK">LHR - JFK (伦敦-纽约)</option>
                                    <option value="CDG-JFK">CDG - JFK (巴黎-纽约)</option>
                                    <option value="FRA-JFK">FRA - JFK (法兰-纽约)</option>
                                </optgroup>
                                <optgroup label="中国国内干线 (CN Trunk)" data-i18n-label="grpCNTrunk">
                                    <option value="PEK-SHA">PEK - SHA (京沪快线)</option>
                                    <option value="PEK-CAN">PEK - CAN (京广航线)</option>
                                    <option value="SHA-SZX">SHA - SZX (沪深航线)</option>
                                    <option value="PEK-CTU">PEK - CTU (北京-成都)</option>
                                    <option value="SHA-CTU">SHA - CTU (上海-成都)</option>
                                </optgroup>
                                <optgroup label="中国国内支线 (CN Regional)" data-i18n-label="grpCNReg">
                                    <option value="KMG-LJG">KMG - LJG (昆明-丽江)</option>
                                    <option value="CTU-LXA">CTU - LXA (成都-拉萨)</option>
                                    <option value="URC-KHG">URC - KHG (乌鲁木齐-喀什)</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="input-group">
                                <label data-i18n="lblTime">飞行时间 (h)</label>
                                <input type="number" id="in-time" value="12.5" step="0.1" oninput="calculate()">
                            </div>
                            <div class="input-group">
                                <label data-i18n="lblDist">距离 (km)</label>
                                <input type="number" id="in-dist" value="10000" disabled class="bg-gray-100">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Revenue -->
                <div class="space-y-2">
                    <h3 class="text-xs font-bold text-slate-800 border-l-4 border-green-500 pl-2" data-i18n="secRev">2. 收益结构 (单程含税)</h3>
                    
                    <!-- F Class -->
                    <div class="bg-white border border-slate-200 rounded p-2 shadow-sm hover:border-green-300 transition-colors" id="row-f">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-bold text-slate-700"><span data-i18n="lblClassF">头等舱</span> <span id="seat-count-f" class="text-slate-400 font-normal">(8座)</span></span>
                            <span id="txt-lf-f" class="text-[10px] font-mono text-slate-500">LF: 60%</span>
                        </div>
                        <div class="flex space-x-2">
                            <div class="input-group w-1/2">
                                <input type="number" id="in-price-f" value="85000" step="1000" oninput="calculate()">
                            </div>
                            <div class="flex items-center w-1/2 px-1">
                                <input type="range" id="in-lf-f" min="0" max="100" value="60" oninput="calculate()">
                            </div>
                        </div>
                    </div>

                    <!-- C Class -->
                    <div class="bg-white border border-slate-200 rounded p-2 shadow-sm hover:border-green-300 transition-colors">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-bold text-slate-700"><span data-i18n="lblClassC">公务舱</span> <span id="seat-count-c" class="text-slate-400 font-normal">(42座)</span></span>
                            <span id="txt-lf-c" class="text-[10px] font-mono text-slate-500">LF: 75%</span>
                        </div>
                        <div class="flex space-x-2">
                            <div class="input-group w-1/2">
                                <input type="number" id="in-price-c" value="32000" step="500" oninput="calculate()">
                            </div>
                            <div class="flex items-center w-1/2 px-1">
                                <input type="range" id="in-lf-c" min="0" max="100" value="75" oninput="calculate()">
                            </div>
                        </div>
                    </div>

                    <!-- Y Class -->
                    <div class="bg-white border border-slate-200 rounded p-2 shadow-sm hover:border-green-300 transition-colors">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-bold text-slate-700"><span data-i18n="lblClassY">经济舱</span> <span id="seat-count-y" class="text-slate-400 font-normal">(261座)</span></span>
                            <span id="txt-lf-y" class="text-[10px] font-mono text-slate-500">LF: 88%</span>
                        </div>
                        <div class="flex space-x-2">
                            <div class="input-group w-1/2">
                                <input type="number" id="in-price-y" value="6500" step="100" oninput="calculate()">
                            </div>
                            <div class="flex items-center w-1/2 px-1">
                                <input type="range" id="in-lf-y" min="0" max="100" value="88" oninput="calculate()">
                            </div>
                        </div>
                    </div>

                    <!-- Cargo -->
                    <div class="grid grid-cols-2 gap-3 pt-1">
                        <div class="input-group">
                            <label data-i18n="lblCargoLoad">载货量 (吨)</label>
                            <input type="number" id="in-cargo-load" value="12" step="0.5" oninput="calculate()">
                        </div>
                        <div class="input-group">
                            <label data-i18n="lblCargoYield">运价 (CNY/kg)</label>
                            <input type="number" id="in-cargo-yield" value="28" step="1" oninput="calculate()">
                        </div>
                    </div>
                </div>

                <!-- Section 3: Cost -->
                <div class="space-y-2 pb-6">
                    <h3 class="text-xs font-bold text-slate-800 border-l-4 border-red-500 pl-2" data-i18n="secCost">3. 成本因子</h3>
                    
                    <div class="bg-red-50 p-2 rounded border border-red-100">
                        <div class="flex justify-between items-end mb-2">
                            <label class="text-[10px] font-bold text-red-800" data-i18n="lblFuelPrice">航油价格 (CNY/吨)</label>
                            <span class="text-[9px] text-red-400">Auto-calc from Brent</span>
                        </div>
                        <input type="number" id="in-fuel-price-cny" value="7200" step="10" class="w-full text-right font-mono font-bold text-red-700 bg-white border-red-200" oninput="calculate()">
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <div class="input-group">
                            <label data-i18n="lblFees">起降/航路 (CNY)</label>
                            <input type="number" id="in-fees" value="160000" step="1000" oninput="calculate()">
                        </div>
                        <div class="input-group">
                            <label data-i18n="lblOwn">租金/折旧 (CNY)</label>
                            <input type="number" id="in-ownership" value="180000" step="1000" oninput="calculate()">
                        </div>
                        <div class="input-group">
                            <label data-i18n="lblCrew">机组/时 (CNY)</label>
                            <input type="number" id="in-crew-cost" value="6500" step="100" oninput="calculate()">
                        </div>
                        <div class="input-group">
                            <label data-i18n="lblMaint">维修/时 (CNY)</label>
                            <input type="number" id="in-maint" value="8500" step="100" oninput="calculate()">
                        </div>
                        <div class="input-group">
                            <label data-i18n="lblFuelBurn">油耗 (吨/h)</label>
                            <input type="number" id="in-fuel-burn" value="7.5" step="0.1" oninput="calculate()">
                        </div>
                         <div class="input-group">
                             <label data-i18n="lblOverhead">杂费率 (%)</label>
                             <input type="number" id="in-overhead" value="12" step="1" oninput="calculate()">
                         </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- RIGHT DASHBOARD -->
        <main class="flex-grow flex flex-col min-w-0 bg-slate-50">
            
            <!-- KPI Strip -->
            <div class="grid grid-cols-4 gap-4 p-4 border-b border-slate-200 bg-white shadow-sm flex-none">
                <!-- Profit -->
                <div class="p-3 rounded-lg border border-slate-100 bg-gradient-to-br from-white to-slate-50 relative overflow-hidden group">
                    <div class="text-[10px] uppercase text-slate-400 font-bold tracking-wider" data-i18n="kpiProfit">预估单班净利润</div>
                    <div class="text-2xl font-bold mt-1 kpi-value tracking-tight" id="kpi-profit">--</div>
                    <div class="text-[10px] mt-1 font-medium px-2 py-0.5 rounded-full inline-block" id="kpi-status-badge">--</div>
                    <div class="absolute right-0 top-0 h-full w-1 bg-slate-200 transition-all duration-500" id="profit-bar-indicator"></div>
                </div>

                <!-- Margin -->
                <div class="p-3 rounded-lg border border-slate-100 bg-white">
                    <div class="text-[10px] uppercase text-slate-400 font-bold tracking-wider" data-i18n="kpiMargin">利润率</div>
                    <div class="text-2xl font-bold mt-1 kpi-value text-slate-700" id="kpi-margin">--</div>
                    <div class="w-full bg-slate-100 h-1.5 mt-2 rounded-full overflow-hidden">
                        <div id="progress-margin" class="h-full bg-slate-400 transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>

                <!-- BE LF -->
                <div class="p-3 rounded-lg border border-slate-100 bg-white">
                    <div class="text-[10px] uppercase text-slate-400 font-bold tracking-wider" data-i18n="kpiBe">盈亏平衡客座率</div>
                    <div class="text-2xl font-bold mt-1 kpi-value text-orange-600" id="kpi-be">--</div>
                    <div class="text-[10px] text-slate-400 mt-1"><span data-i18n="lblCurrLF">当前</span>: <span class="text-slate-600 font-bold" id="kpi-lf-curr">--</span></div>
                </div>

                <!-- RASK/CASK -->
                <div class="p-3 rounded-lg border border-slate-100 bg-white flex flex-col justify-center space-y-2">
                    <div class="flex justify-between items-baseline border-b border-dashed border-slate-200 pb-1">
                        <span class="text-[10px] font-bold text-slate-500">RASK</span>
                        <span class="text-sm font-bold kpi-value text-indigo-600" id="kpi-rask">--</span>
                    </div>
                    <div class="flex justify-between items-baseline">
                        <span class="text-[10px] font-bold text-slate-500">CASK</span>
                        <span class="text-sm font-bold kpi-value text-red-600" id="kpi-cask">--</span>
                    </div>
                </div>
            </div>

            <!-- Scrollable Charts Area -->
            <div class="flex-grow overflow-y-auto custom-scroll p-4 space-y-4">
                
                <!-- Main Waterfall -->
                <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-sm font-bold text-slate-700 flex items-center">
                            <span class="w-1 h-4 bg-blue-500 mr-2 rounded-full"></span>
                            <span data-i18n="chartWfTitle">收益与成本构成全景瀑布图</span>
                        </h3>
                        <div class="text-[10px] text-slate-400 bg-slate-100 px-2 py-1 rounded" data-i18n="chartUnit">单位: 万元 (CNY)</div>
                    </div>
                    <div id="waterfall-chart" style="width: 100%; height: 350px;"></div>
                </div>

                <!-- Bottom Grid -->
                <div class="grid grid-cols-2 gap-4">
                    <!-- Sensitivity Chart -->
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 h-[320px] flex flex-col">
                        <h3 class="text-sm font-bold text-slate-700 mb-2 flex items-center">
                            <span class="w-1 h-4 bg-orange-500 mr-2 rounded-full"></span>
                            <span data-i18n="chartBeTitle">盈亏平衡敏感性分析</span>
                        </h3>
                        <div class="flex-grow relative w-full">
                            <canvas id="beChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Cost Donut -->
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 h-[320px] flex flex-col">
                        <h3 class="text-sm font-bold text-slate-700 mb-2 flex items-center">
                            <span class="w-1 h-4 bg-red-500 mr-2 rounded-full"></span>
                            <span data-i18n="chartCostTitle">成本结构分布</span>
                        </h3>
                        <div class="flex-grow relative flex justify-center">
                            <canvas id="costChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="text-center py-6 text-[10px] text-slate-400 border-t border-slate-100 mt-4">
                    <span data-i18n="footer">© 2025 Aviation Econ Group | Data for simulation only</span>
                </div>
            </div>
        </main>
    </div>

    <!-- Logic Script -->
    <script>
        // --- Data & Config ---
        const I18N = {
            zh: {
                appTitle: "全球航线收益精算系统",
                lblExch: "汇率 (USD/CNY)",
                lblOil: "油价 (Brent)",
                secParams: "参数配置",
                btnReset: "重置默认值",
                secOps: "1. 航线与运营",
                lblRoute: "航线预设",
                lblTime: "飞行时间 (h)",
                lblDist: "距离 (km)",
                secRev: "2. 收益结构 (单程含税)",
                lblClassF: "头等舱",
                lblClassC: "公务舱",
                lblClassY: "经济舱",
                lblCargoLoad: "载货量 (吨)",
                lblCargoYield: "运价 (CNY/kg)",
                secCost: "3. 成本因子",
                lblFuelPrice: "航油价格 (CNY/吨)",
                lblFees: "起降/航路 (CNY)",
                lblOwn: "租金/折旧 (CNY)",
                lblCrew: "机组/时 (CNY)",
                lblMaint: "维修/时 (CNY)",
                lblFuelBurn: "油耗 (吨/h)",
                lblOverhead: "杂费率 (%)",
                kpiProfit: "预估单班净利润",
                kpiMargin: "利润率",
                kpiBe: "盈亏平衡客座率",
                lblCurrLF: "当前",
                chartWfTitle: "收益与成本构成全景瀑布图",
                chartUnit: "单位: 万元 (CNY)",
                chartBeTitle: "盈亏平衡敏感性分析",
                chartCostTitle: "成本结构分布",
                statusProfit: "盈利",
                statusLoss: "亏损",
                footer: "© 2025 航空经济研究组 | 数据仅供模拟参考",
                wfLabels: ["头等舱", "公务舱", "经济舱", "货运", "总收入", "燃油", "机组", "维修", "费用", "租金", "杂费", "净利润"],
                costLabels: ['燃油', '机组', '维修', '费税', '租金', '杂费'],
                beLegend: ["总成本", "总收入"],
                beAxis: "客座率 (%)",
                grpTP: "跨太平洋 (Trans-Pacific)",
                grpTA: "跨大西洋 (Trans-Atlantic)",
                grpCNTrunk: "中国国内干线 (CN Trunk)",
                grpCNReg: "中国国内支线 (CN Regional)"
            },
            en: {
                appTitle: "Global Route Profitability Model",
                lblExch: "Exch Rate",
                lblOil: "Brent Oil",
                secParams: "Parameters",
                btnReset: "Reset",
                secOps: "1. Operations",
                lblRoute: "Route Profile",
                lblTime: "Time (Hrs)",
                lblDist: "Dist (km)",
                secRev: "2. Revenue (One-way)",
                lblClassF: "First/Prem",
                lblClassC: "Business",
                lblClassY: "Economy",
                lblCargoLoad: "Cargo (Tons)",
                lblCargoYield: "Cargo Yield (CNY/kg)",
                secCost: "3. Costs",
                lblFuelPrice: "Jet Fuel (CNY/Ton)",
                lblFees: "Fees (CNY)",
                lblOwn: "Ownership (CNY)",
                lblCrew: "Crew/Hr (CNY)",
                lblMaint: "Maint/Hr (CNY)",
                lblFuelBurn: "Burn (T/hr)",
                lblOverhead: "Overhead (%)",
                kpiProfit: "Est. Net Profit",
                kpiMargin: "Margin",
                kpiBe: "Breakeven LF",
                lblCurrLF: "Current",
                chartWfTitle: "P&L Waterfall Analysis",
                chartUnit: "Unit: 10k CNY",
                chartBeTitle: "Breakeven Sensitivity",
                chartCostTitle: "Cost Structure",
                statusProfit: "PROFIT",
                statusLoss: "LOSS",
                footer: "© 2025 Aviation Econ Group | Simulation Only",
                wfLabels: ["Premium", "Business", "Economy", "Cargo", "Revenue", "Fuel", "Crew", "Maint", "Fees", "Rent", "Overhead", "Profit"],
                costLabels: ['Fuel', 'Crew', 'Maint', 'Fees', 'Rent', 'Overhead'],
                beLegend: ["Total Cost", "Revenue"],
                beAxis: "Load Factor (%)",
                grpTP: "Trans-Pacific",
                grpTA: "Trans-Atlantic",
                grpCNTrunk: "China Domestic Trunk",
                grpCNReg: "China Domestic Regional"
            }
        };

        const AC_TYPES = {
            'B77W': { label: 'B777-300ER', seatsF: 8, seatsC: 42, seatsY: 261, fuel: 7.5, crew: 6500, maint: 8500 },
            'A330': { label: 'A330-300', seatsF: 0, seatsC: 30, seatsY: 270, fuel: 5.8, crew: 5500, maint: 6500 },
            'B738': { label: 'B737-800', seatsF: 0, seatsC: 8, seatsY: 160, fuel: 2.4, crew: 3500, maint: 2500 }
        };

        let currentAC = AC_TYPES['B77W'];

        const ROUTES = {
            // International Widebody (B77W)
            'PEK-LAX': { type: 'B77W', dist: 10000, time: 12.5, fees: 160000, defaults: { pF: 85000, pC: 32000, pY: 6500, cLoad: 12 } },
            'PEK-JFK': { type: 'B77W', dist: 11000, time: 14.5, fees: 180000, defaults: { pF: 88000, pC: 34000, pY: 6800, cLoad: 10 } },
            'PVG-SFO': { type: 'B77W', dist: 9900, time: 11.5, fees: 155000, defaults: { pF: 82000, pC: 30000, pY: 6200, cLoad: 14 } },
            'LHR-JFK': { type: 'B77W', dist: 5540, time: 7.5, fees: 220000, defaults: { pF: 95000, pC: 38000, pY: 5500, cLoad: 15 } },
            'CDG-JFK': { type: 'B77W', dist: 5835, time: 8.0, fees: 190000, defaults: { pF: 92000, pC: 36000, pY: 5200, cLoad: 12 } },
            'FRA-JFK': { type: 'B77W', dist: 6200, time: 8.5, fees: 185000, defaults: { pF: 90000, pC: 35000, pY: 5400, cLoad: 18 } },
            
            // Domestic Trunk (A330 Widebody)
            'PEK-SHA': { type: 'A330', dist: 1100, time: 2.3, fees: 45000, defaults: { pF: 0, pC: 3500, pY: 1500, cLoad: 8, lfC: 85, lfY: 90 } },
            'PEK-CAN': { type: 'A330', dist: 1900, time: 3.2, fees: 50000, defaults: { pF: 0, pC: 4000, pY: 1800, cLoad: 10, lfC: 80, lfY: 88 } },
            'SHA-SZX': { type: 'A330', dist: 1200, time: 2.5, fees: 48000, defaults: { pF: 0, pC: 3200, pY: 1400, cLoad: 9, lfC: 75, lfY: 85 } },
            'PEK-CTU': { type: 'A330', dist: 1600, time: 3.0, fees: 45000, defaults: { pF: 0, pC: 3000, pY: 1600, cLoad: 6, lfC: 70, lfY: 85 } },
            'SHA-CTU': { type: 'A330', dist: 1700, time: 3.0, fees: 45000, defaults: { pF: 0, pC: 2800, pY: 1500, cLoad: 7, lfC: 70, lfY: 85 } },
            
            // Domestic Regional (B738 Narrowbody)
            'KMG-LJG': { type: 'B738', dist: 320, time: 0.9, fees: 12000, defaults: { pF: 0, pC: 1800, pY: 600, cLoad: 1, lfC: 60, lfY: 80 } },
            'CTU-LXA': { type: 'B738', dist: 1300, time: 2.5, fees: 25000, defaults: { pF: 0, pC: 2500, pY: 1800, cLoad: 2, lfC: 75, lfY: 90 } },
            'URC-KHG': { type: 'B738', dist: 1450, time: 2.0, fees: 15000, defaults: { pF: 0, pC: 2200, pY: 1200, cLoad: 1, lfC: 65, lfY: 85 } }
        };

        let currentLang = 'zh';
        let charts = {};

        // --- Utils ---
        const $ = id => document.getElementById(id);
        const formatMoney = (val, lang) => {
            const absVal = Math.abs(val);
            let s = "";
            if (lang === 'en') {
                if (absVal >= 1000000) s = (absVal/1000000).toFixed(2) + "M";
                else if (absVal >= 1000) s = (absVal/1000).toFixed(1) + "k";
                else s = absVal.toFixed(0);
                return (val < 0 ? "-" : "") + "¥" + s;
            } else {
                return (val < 0 ? "-" : "") + "¥" + Math.round(val).toLocaleString();
            }
        };

        function toggleLanguage() {
            currentLang = currentLang === 'zh' ? 'en' : 'zh';
            
            $('lang-cn').className = `lang-option ${currentLang === 'zh' ? 'lang-active' : ''}`;
            $('lang-en').className = `lang-option ${currentLang === 'en' ? 'lang-active' : ''}`;
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (I18N[currentLang][key]) el.innerText = I18N[currentLang][key];
            });

            document.querySelectorAll('optgroup[data-i18n-label]').forEach(el => {
                const key = el.getAttribute('data-i18n-label');
                if (I18N[currentLang][key]) el.label = I18N[currentLang][key];
            });

            calculate();
        }

        function updateFuelFromUSD() {
            const exch = parseFloat($('global-exch').value);
            const oil = parseFloat($('global-oil').value);
            const priceCNY = (oil + 18) * 7.9 * exch * 1.05;
            $('in-fuel-price-cny').value = Math.round(priceCNY);
            calculate();
        }

        function updateRouteParams() {
            const key = $('sel-route').value;
            const data = ROUTES[key];
            
            const typeKey = data.type || 'B77W';
            currentAC = AC_TYPES[typeKey];
            
            $('ac-type-badge').innerText = currentAC.label;
            $('seat-count-f').innerText = `(${currentAC.seatsF}座)`;
            $('seat-count-c').innerText = `(${currentAC.seatsC}座)`;
            $('seat-count-y').innerText = `(${currentAC.seatsY}座)`;
            
            if (currentAC.seatsF === 0) {
                $('row-f').classList.add('opacity-50', 'pointer-events-none');
                $('in-price-f').value = 0;
            } else {
                $('row-f').classList.remove('opacity-50', 'pointer-events-none');
            }

            $('in-time').value = data.time;
            $('in-dist').value = data.dist;
            $('in-fees').value = data.fees;
            $('in-fuel-burn').value = currentAC.fuel;
            $('in-crew-cost').value = currentAC.crew;
            $('in-maint').value = currentAC.maint;

            if(data.defaults) {
                $('in-price-f').value = data.defaults.pF || 0;
                $('in-price-c').value = data.defaults.pC;
                $('in-price-y').value = data.defaults.pY;
                $('in-cargo-load').value = data.defaults.cLoad;
                if (data.defaults.lfC) $('in-lf-c').value = data.defaults.lfC;
                if (data.defaults.lfY) $('in-lf-y').value = data.defaults.lfY;
            }
            
            calculate();
        }

        function resetDefaults() {
            $('sel-route').value = 'PEK-LAX';
            $('global-exch').value = 7.28;
            $('global-oil').value = 78;
            updateRouteParams(); 
        }

        function calculate() {
            // Safety check
            if (typeof Chart === 'undefined' || typeof Plotly === 'undefined') return;

            const L = I18N[currentLang];
            const inputs = {
                time: parseFloat($('in-time').value) || 0,
                dist: parseFloat($('in-dist').value) || 0,
                pF: parseFloat($('in-price-f').value) || 0,
                pC: parseFloat($('in-price-c').value) || 0,
                pY: parseFloat($('in-price-y').value) || 0,
                lfF: parseFloat($('in-lf-f').value)/100,
                lfC: parseFloat($('in-lf-c').value)/100,
                lfY: parseFloat($('in-lf-y').value)/100,
                cLoad: parseFloat($('in-cargo-load').value) || 0,
                cYield: parseFloat($('in-cargo-yield').value) || 0,
                fuelP: parseFloat($('in-fuel-price-cny').value) || 0,
                burn: parseFloat($('in-fuel-burn').value) || 0,
                fees: parseFloat($('in-fees').value) || 0,
                own: parseFloat($('in-ownership').value) || 0,
                crew: parseFloat($('in-crew-cost').value) || 0,
                maint: parseFloat($('in-maint').value) || 0,
                over: parseFloat($('in-overhead').value)/100
            };

            $('txt-lf-f').innerText = `LF: ${(inputs.lfF*100).toFixed(0)}%`;
            $('txt-lf-c').innerText = `LF: ${(inputs.lfC*100).toFixed(0)}%`;
            $('txt-lf-y').innerText = `LF: ${(inputs.lfY*100).toFixed(0)}%`;

            const rF = currentAC.seatsF * inputs.lfF * inputs.pF;
            const rC = currentAC.seatsC * inputs.lfC * inputs.pC;
            const rY = currentAC.seatsY * inputs.lfY * inputs.pY;
            const rCargo = inputs.cLoad * 1000 * inputs.cYield;
            const totalRev = rF + rC + rY + rCargo;

            const cFuel = inputs.burn * inputs.time * inputs.fuelP;
            const cCrew = inputs.crew * inputs.time;
            const cMaint = inputs.maint * inputs.time;
            const cDirect = cFuel + cCrew + cMaint + inputs.fees + inputs.own;
            const cOver = cDirect * inputs.over;
            const totalCost = cDirect + cOver;

            const profit = totalRev - totalCost;
            const margin = (profit / totalRev) * 100;
            const totalSeats = currentAC.seatsF + currentAC.seatsC + currentAC.seatsY;
            const ask = totalSeats * inputs.dist;
            
            // Breakeven Logic Fix (ReferenceError rCargo)
            const maxPaxRev = (currentAC.seatsF * inputs.pF) + (currentAC.seatsC * inputs.pC) + (currentAC.seatsY * inputs.pY);
            // We use 'rCargo' here, not 'revCargo'
            const beLF = maxPaxRev > 0 ? Math.min(((totalCost - rCargo) / maxPaxRev) * 100, 100) : 0;
            
            const currPax = (currentAC.seatsF * inputs.lfF) + (currentAC.seatsC * inputs.lfC) + (currentAC.seatsY * inputs.lfY);
            const currLF = (currPax / totalSeats) * 100;

            // UI
            $('kpi-profit').innerText = formatMoney(profit, currentLang);
            $('kpi-profit').className = `text-2xl font-bold mt-1 kpi-value tracking-tight ${profit>=0 ? 'text-emerald-600' : 'text-rose-600'}`;
            
            const statusBadge = $('kpi-status-badge');
            statusBadge.innerText = profit >= 0 ? L.statusProfit : L.statusLoss;
            statusBadge.className = `text-[10px] mt-1 font-medium px-2 py-0.5 rounded-full inline-block ${profit>=0 ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700'}`;
            
            $('profit-bar-indicator').className = `absolute right-0 top-0 h-full w-1 transition-all duration-500 ${profit>=0 ? 'bg-emerald-500' : 'bg-rose-500'}`;

            $('kpi-margin').innerText = margin.toFixed(1) + "%";
            $('progress-margin').className = `h-full transition-all duration-500 ${profit>=0 ? 'bg-emerald-500' : 'bg-rose-500'}`;
            $('progress-margin').style.width = Math.min(Math.abs(margin), 100) + "%";

            $('kpi-be').innerText = beLF.toFixed(1) + "%";
            $('kpi-lf-curr').innerText = currLF.toFixed(1) + "%";

            $('kpi-rask').innerText = (totalRev/ask).toFixed(2);
            $('kpi-cask').innerText = (totalCost/ask).toFixed(2);

            // Render
            renderWaterfall(rF, rC, rY, rCargo, cFuel, cCrew, cMaint, inputs.fees, inputs.own, cOver, profit, L);
            renderBeChart(totalCost, rCargo, maxPaxRev, L);
            renderCostChart(cFuel, cCrew, cMaint, inputs.fees, inputs.own, cOver, L);
        }

        function renderWaterfall(rF, rC, rY, rCargo, cF, cC, cM, fees, own, over, prof, L) {
            const data = [{
                type: "waterfall",
                orientation: "v",
                measure: ["relative","relative","relative","relative","total","relative","relative","relative","relative","relative","relative","total"],
                x: L.wfLabels,
                textposition: "outside",
                text: [
                    (rF/10000).toFixed(0), (rC/10000).toFixed(0), (rY/10000).toFixed(0), (rCargo/10000).toFixed(0), ((rF+rC+rY+rCargo)/10000).toFixed(0),
                    "-"+(cF/10000).toFixed(0), "-"+(cC/10000).toFixed(0), "-"+(cM/10000).toFixed(0), 
                    "-"+(fees/10000).toFixed(0), "-"+(own/10000).toFixed(0), "-"+(over/10000).toFixed(0), (prof/10000).toFixed(0)
                ],
                y: [rF, rC, rY, rCargo, 0, -cF, -cC, -cM, -fees, -own, -over, 0],
                connector: { line: { color: "#94a3b8" } },
                increasing: { marker: { color: "#10b981" } },
                decreasing: { marker: { color: "#f43f5e" } },
                totals: { marker: { color: "#3b82f6" } }
            }];

            const layout = {
                autosize: true,
                margin: { l: 40, r: 20, t: 30, b: 30 },
                yaxis: { title: currentLang==='zh' ? "金额 (万元)" : "Amt (10k CNY)", tickformat: ".0f" },
                font: { family: 'Noto Sans SC', size: 10 },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)'
            };

            Plotly.react('waterfall-chart', data, layout, { displayModeBar: false, responsive: true });
        }

        function renderBeChart(totalCost, cargoRev, maxPaxRev, L) {
            const ctx = document.getElementById('beChart').getContext('2d');
            const points = [0, 20, 40, 60, 80, 100];
            const costs = points.map(() => totalCost);
            const revs = points.map(lf => (maxPaxRev * (lf/100)) + cargoRev);

            if (charts.be) charts.be.destroy();
            charts.be = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: points,
                    datasets: [
                        { label: L.beLegend[0], data: costs, borderColor: '#f43f5e', borderWidth: 2, borderDash: [5,5], pointRadius: 0 },
                        { label: L.beLegend[1], data: revs, borderColor: '#10b981', borderWidth: 2 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top', align: 'end' } },
                    scales: {
                        y: { ticks: { callback: v => (v/10000).toFixed(0) + (currentLang==='zh'?'万':'0k') }, grid: { color: '#f1f5f9' } },
                        x: { title: { display: true, text: L.beAxis }, grid: { display: false } }
                    }
                }
            });
        }

        function renderCostChart(f, c, m, fees, own, over, L) {
            const ctx = document.getElementById('costChart').getContext('2d');
            if (charts.cost) charts.cost.destroy();
            charts.cost = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: L.costLabels,
                    datasets: [{
                        data: [f, c, m, fees, own, over],
                        backgroundColor: ['#ef4444', '#f97316', '#eab308', '#3b82f6', '#6366f1', '#94a3b8'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: {size: 10} } } },
                    cutout: '60%'
                }
            });
        }

        // Init with Safe Delay
        window.onload = function() {
            setTimeout(() => {
                resetDefaults(); 
            }, 500); // 500ms delay to ensure libs are ready
        };
        
        // Fixed Resize Handler (Safe Plotly Resize)
        window.addEventListener('resize', () => {
            if (charts.be) charts.be.resize();
            if (charts.cost) charts.cost.resize();
            
            const gd = document.getElementById('waterfall-chart');
            if (gd && gd.data && typeof Plotly !== 'undefined') {
                Plotly.Plots.resize(gd);
            }
        });
    </script>
</body>
</html>
