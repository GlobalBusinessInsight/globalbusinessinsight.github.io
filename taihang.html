<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å……ç”µç½‘ç»œæ™ºèƒ½ç›‘æ§çœ‹æ¿ (åæ ‡ä¿®æ­£ç‰ˆ)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- SheetJS (XLSX) -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #f5f5f4; }
        #map-container { position: relative; height: 100%; min-height: 450px; width: 100%; border-radius: 0.75rem; overflow: hidden; border: 1px solid #e7e5e4; }
        #map { height: 100%; width: 100%; }
        .anchorBL { display: none !important; }
        .station-list::-webkit-scrollbar { width: 6px; }
        .station-list::-webkit-scrollbar-track { background: #f1f1f1; }
        .station-list::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 3px; }
        .chart-container { position: relative; width: 100%; height: 200px; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body class="text-stone-800 h-screen flex flex-col overflow-hidden">

    <!-- Loading -->
    <div id="loading-overlay">
        <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-stone-600 font-medium" id="loading-text">æ­£åœ¨æ›´æ–°ç«™ç‚¹æ•°æ®...</p>
    </div>

    <!-- Header -->
    <header class="bg-white border-b border-stone-200 shadow-sm z-20 shrink-0">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-xl shadow-md">B</div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-stone-900">å……ç”µç½‘ç»œå…¨æ™¯çœ‹æ¿ <span class="text-xs bg-stone-800 text-white px-2 py-0.5 rounded ml-2">Fixed V5</span></h1>
                    <p class="text-xs text-stone-500">
                        No.66 åæ ‡å·²ä¿®æ­£ | 
                        <span class="text-blue-600 font-bold">å…¨é‡ 72 ç«™</span>
                    </p>
                </div>
            </div>
            <div class="hidden sm:flex gap-4 text-sm font-medium text-stone-600">
                <div class="flex items-center gap-2 px-3 py-1 rounded-full bg-emerald-50 border border-emerald-100">
                    <span class="block w-2.5 h-2.5 rounded-full bg-emerald-500"></span>
                    <span>å·²æŠ•è¿ (1-23)</span>
                </div>
                <div class="flex items-center gap-2 px-3 py-1 rounded-full bg-amber-50 border border-amber-100">
                    <span class="block w-2.5 h-2.5 rounded-full bg-amber-500"></span>
                    <span>å»ºè®¾ä¸­ (24-72)</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main -->
    <main class="flex-1 max-w-7xl w-full mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-4 overflow-hidden">
        <!-- Sidebar -->
        <div class="lg:col-span-3 flex flex-col gap-4 h-full overflow-hidden order-2 lg:order-1">
            <div class="bg-white rounded-xl shadow-sm border border-stone-200 p-4 shrink-0 space-y-3">
                <div class="relative">
                    <input type="file" id="file-upload" accept=".xlsx, .xls, .csv" class="hidden" />
                    <label for="file-upload" class="flex items-center justify-center w-full gap-2 px-4 py-2 bg-stone-100 hover:bg-stone-200 text-stone-600 text-sm font-medium rounded-lg cursor-pointer transition-colors shadow-sm border border-stone-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                        å¯¼å…¥æ–‡ä»¶
                    </label>
                </div>
                <hr class="border-stone-100">
                <div class="grid grid-cols-3 gap-2">
                    <button id="filter-all" class="px-2 py-2 text-xs font-medium bg-stone-800 text-white rounded shadow-sm">å…¨éƒ¨</button>
                    <button id="filter-operational" class="px-2 py-2 text-xs font-medium bg-white border border-stone-200 text-stone-600 rounded">å·²æŠ•è¿</button>
                    <button id="filter-construction" class="px-2 py-2 text-xs font-medium bg-white border border-stone-200 text-stone-600 rounded">å»ºè®¾ä¸­</button>
                </div>
                <div class="relative group">
                    <input type="text" id="search-input" placeholder="æœç´¢åºå·ã€åç§°..." class="w-full pl-9 pr-3 py-2 text-sm bg-stone-50 border border-stone-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <span class="absolute left-3 top-2.5 text-stone-400">ğŸ”</span>
                </div>
            </div>
            <!-- List -->
            <div class="bg-white rounded-xl shadow-sm border border-stone-200 flex flex-col flex-1 overflow-hidden">
                <div class="px-4 py-3 border-b border-stone-100 bg-stone-50 flex justify-between items-center">
                    <span class="text-xs font-bold text-stone-500 uppercase">ç«™ç‚¹æ¸…å•</span>
                    <span id="list-count" class="text-xs font-bold bg-stone-200 text-stone-700 px-2 py-0.5 rounded-md">72</span>
                </div>
                <div id="station-list" class="station-list flex-1 overflow-y-auto p-2 space-y-2"></div>
            </div>
        </div>

        <!-- Right -->
        <div class="lg:col-span-9 flex flex-col gap-4 h-full overflow-hidden order-1 lg:order-2">
            <div id="map-container" class="bg-white shadow-sm"><div id="map"></div></div>
            <div class="h-auto lg:h-52 shrink-0 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white rounded-xl shadow-sm border border-stone-200 p-5 flex flex-col justify-center">
                    <h3 class="text-sm font-bold text-stone-500 mb-4">ç½‘ç»œç»Ÿè®¡</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="border-r border-stone-100">
                            <div class="text-3xl font-bold text-emerald-600" id="stat-op">23</div>
                            <div class="text-xs text-stone-500 mt-1">å·²æŠ•è¿ (Row 1-23)</div>
                        </div>
                        <div>
                            <div class="text-3xl font-bold text-amber-500" id="stat-con">49</div>
                            <div class="text-xs text-stone-500 mt-1">å»ºè®¾ä¸­ (Row 24-72)</div>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-stone-200 p-4 flex flex-col">
                    <h3 class="text-sm font-bold text-stone-500 mb-1">å»ºè®¾è¿›åº¦</h3>
                    <div class="flex-1 flex items-center justify-center relative"><div class="chart-container"><canvas id="statusChart"></canvas></div></div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-stone-200 p-4 flex flex-col relative">
                    <div class="flex justify-between items-center mb-1">
                        <h3 class="text-sm font-bold text-stone-500">çœå¸‚åˆ†å¸ƒ</h3>
                        <span id="geo-badge" class="text-[9px] bg-blue-50 text-blue-600 px-1.5 rounded hidden">å®šä½ä¸­</span>
                    </div>
                    <div class="flex-1 flex items-center justify-center"><div class="chart-container"><canvas id="regionChart"></canvas></div></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- 1. HIDDEN API KEY ---
        const _0x4f2 = "aHlIa3VReThoNVViWlZNQzBtcFZXNG1hN1RWeHFtM1c=";
        function loadBaiduMap() {
            const ak = atob(_0x4f2);
            const script = document.createElement("script");
            script.src = `https://api.map.baidu.com/api?v=3.0&ak=${ak}&callback=initApp`;
            document.body.appendChild(script);
        }

        // --- 2. HELPERS (GCJ -> BD09) ---
        const x_pi = 3.14159265358979324 * 3000.0 / 180.0;
        function gcj02tobd09(lng, lat) { 
            const z = Math.sqrt(lng * lng + lat * lat) + 0.00002 * Math.sin(lat * x_pi);
            const theta = Math.atan2(lat, lng) + 0.000003 * Math.cos(lng * x_pi);
            return [z * Math.cos(theta) + 0.0065, z * Math.sin(theta) + 0.006];
        }

        // --- 3. FINAL DATASET ---
        // 1-52: Original
        // 53-61: Part2.csv
        // 62-72: Manual Fix (User Provided)
        const defaultStations = [
            // 1-52 (UNCHANGED)
            { id: 1, name: "ç»¿æ–°èƒ½æºæ½é“æ™ºæ…§ç‰©æµå›­å›­åŒºå†…ï¼ˆæ¢ç”µç«™ï¼‰", coords: "113.28292,36.325017" },
            { id: 2, name: "ç»¿æ–°èƒ½æºé»„åŒ—å……ç”µç«™", coords: "113.134684,36.357572" },
            { id: 3, name: "ç»¿æ–°èƒ½æºæ¶‰å¿ç¥å¤´å……ç”µç«™", coords: "113.598247,36.519466" },
            { id: 4, name: "ç»¿æ–°èƒ½æºçŸ³æ¢å……ç”µç«™", coords: "113.318021,36.453537" },
            { id: 5, name: "ç»¿æ–°èƒ½æºå¡åº•å……ç”µç«™", coords: "113.08529,36.341152" },
            { id: 6, name: "ç»¿æ–°èƒ½æºå²å»»æ±½è´¸å›­å……ç”µç«™", coords: "113.157286,36.349615" },
            { id: 7, name: "ç»¿æ–°èƒ½æºå—ç‹åº„å……ç”µç«™ï¼ˆä¸Šå…šåŒºçšå®¶æ²Ÿï¼‰", coords: "113.054248,36.03518" },
            { id: 8, name: "ç»¿æ–°èƒ½æºåº—ä¸Šå……ç”µç«™1æœŸ", coords: "113.274594,35.989891" },
            { id: 9, name: "ç»¿æ–°èƒ½æºæ­¦ä¹¡èŸ é¾™å……ç”µç«™", coords: "113.134701,36.787052" },
            { id: 10, name: "ç»¿æ–°èƒ½æºçµçŸ³å……ç”µç«™", coords: "111.721147,36.837839" },
            { id: 11, name: "ç»¿æ–°èƒ½æºè«åŸå……ç”µç«™", coords: "113.080556,36.007629" },
            { id: 12, name: "ç»¿æ–°èƒ½æºè¥¿æ± å……ç”µç«™", coords: "112.981881,36.104279" },
            { id: 13, name: "ç»¿æ–°èƒ½æºè‹åº—å……ç”µç«™", coords: "113.076813,36.077271" },
            { id: 14, name: "ç»¿æ–°èƒ½æºè¥¿ç«å……ç”µç«™", coords: "113.28424,35.992813" },
            { id: 15, name: "ç»¿æ–°èƒ½æºå…«ä¹‰å……ç”µç«™", coords: "113.033621,36.035777" },
            { id: 16, name: "ç»¿æ–°èƒ½æºå—å®‹å……ç”µç«™", coords: "113.036081,35.948286" },
            { id: 17, name: "ç»¿æ–°èƒ½æºåŒ—å‘ˆå……ç”µç«™", coords: "113.057321,36.148197" },
            { id: 18, name: "ç»¿æ–°èƒ½æºéŸ©åŒ—å……ç”µç«™", coords: "113.111874,36.151745" },
            { id: 19, name: "ç»¿æ–°èƒ½æºä¸œå’Œå……ç”µç«™", coords: "112.973341,36.143644" },
            { id: 20, name: "ç»¿æ–°èƒ½æºå¸é©¬å……ç”µç«™", coords: "113.033785,36.082717" },
            { id: 21, name: "ç»¿æ–°èƒ½æºè¥¿è¥å……ç”µç«™", coords: "113.064516,35.480031" },
            { id: 22, name: "ç»¿æ–°èƒ½æºä¸œå†¶å¤´å……ç”µç«™", coords: "113.310636,35.539851" },
            { id: 23, name: "ç»¿æ–°èƒ½æºæ¬¡è¥å……ç”µç«™", coords: "113.197967,35.433842" },
            { id: 24, name: "ç»¿æ–°èƒ½æºäº”é¾™å±±å……ç”µç«™", coords: "113.488347,35.501174" },
            { id: 25, name: "ç»¿æ–°èƒ½æºæ¨ªæ°´å……ç”µç«™", coords: "113.626305,36.155892" },
            { id: 26, name: "ç»¿æ–°èƒ½æºäº•å¡å……ç”µç«™", coords: "113.568421,35.553909" },
            { id: 27, name: "ç»¿æ–°èƒ½æºåˆæ²³å……ç”µç«™", coords: "113.971512,35.340078" },
            { id: 28, name: "ç»¿æ–°èƒ½æºä¸´æ·‡å……ç”µç«™", coords: "113.985926,35.895034" },
            { id: 29, name: "ç»¿æ–°èƒ½æºäº”é¾™å……ç”µç«™", coords: "114.103986,35.858763" },
            { id: 30, name: "ç»¿æ–°èƒ½æºä¸œå§šå……ç”µç«™", coords: "113.993083,35.975477" },
            { id: 31, name: "ç»¿æ–°èƒ½æºé‡‡æ¡‘å……ç”µç«™", coords: "113.88602,35.918991" },
            { id: 32, name: "ç»¿æ–°èƒ½æºä¸œå²—å……ç”µç«™", coords: "114.159381,36.257008" },
            { id: 33, name: "ç»¿æ–°èƒ½æºä»»æ‘å……ç”µç«™", coords: "113.931229,36.265731" },
            { id: 34, name: "ç»¿æ–°èƒ½æºå¹³é‚‘å……ç”µç«™", coords: "113.250557,36.319762" },
            { id: 35, name: "ç»¿æ–°èƒ½æºå§šæ‘å……ç”µç«™", coords: "113.840748,36.156828" },
            { id: 36, name: "ç»¿æ–°èƒ½æºæ½é“æ™ºæ…§ç‰©æµå›­ï¼ˆå……ç”µç«™ï¼‰", coords: "113.28424,35.992813" },
            { id: 37, name: "ç»¿æ–°èƒ½æºæŒ¯å…´å……ç”µç«™", coords: "113.064516,35.480031" },
            { id: 38, name: "ç»¿æ–°èƒ½æºå£¶å…³é›†åº—å……ç”µç«™", coords: "113.167824,36.082761" },
            { id: 39, name: "ç»¿æ–°èƒ½æºå¹³é¡ºåŒ—ç¤¾å……ç”µç«™", coords: "113.385906,36.145892" },
            { id: 40, name: "ç»¿æ–°èƒ½æºå±¯ç•™æ¸”æ³½å……ç”µç«™", coords: "112.946351,36.286821" },
            { id: 41, name: "ç»¿æ–°èƒ½æºé•¿æ²»å¿è´¾æŒå……ç”µç«™", coords: "113.003554,35.932824" },
            { id: 42, name: "ç»¿æ–°èƒ½æºæ½åŸå¾®å­é•‡å……ç”µç«™", coords: "113.220197,36.284897" },
            { id: 43, name: "ä»‹ä¼‘å¸‚ä¹‰å®‰é•‡", coords: "111.948054,36.985047" },
            { id: 44, name: "å­ä¹‰å¸‚æŸ±æ¿®é•‡ä¸Šæ™ºå³ªæ‘", coords: "111.691507,37.075799" },
            { id: 45, name: "æ™‹åŸå¸‚æ³½å·å¿å·´å…¬é•‡", coords: "112.912409,35.609078" },
            { id: 46, name: "å®‰é˜³åˆ©æº", coords: "114.344815,36.150114" },
            { id: 47, name: "æ´ªæ´ç”˜äº­é•‡", coords: "111.672237,36.179187" },
            { id: 48, name: "æ—å·æ²³é¡ºé•‡æ¨å®¶è¥æ‘", coords: "113.901521,36.141551" },
            { id: 49, name: "æ™‹åŸå¸‚æ³½å·å¿å¤§ä¸œæ²Ÿé•‡", coords: "112.720088,35.587986" },
            { id: 50, name: "å·¦æƒä¸‹å…¶è‡³æ‘", coords: "113.447107,37.165597" },
            { id: 51, name: "å­ä¹‰å¸‚ä¸œè‘£å±¯æ‘ï¼ˆåŸæ˜†ä»‘åŠ æ°”ç«™ï¼‰", coords: "111.84799,37.044294" },
            { id: 52, name: "é‚¯éƒ¸å³°å³°çŸ¿åŒº", coords: "114.212571,36.419298" },
            
            // 53-61 (PART 2)
            { id: 53, name: "å®‰é˜³é¾™å®‰åŒº", coords: "114.277317,36.077565" },
            { id: 54, name: "æ›²æ²ƒä¹æ˜Œé•‡", coords: "111.4633, 35.6414" },
            { id: 55, name: "æ—å·å¸‚æ²³é¡ºé•‡", coords: "113.832267,36.061732" },
            { id: 56, name: "é•¿æ²»å¸‚æ­¦ä¹¡å¿", coords: "112.8603, 36.8325" },
            { id: 57, name: "æ²³å—çœé¹¤å£å¸‚å±±åŸåŒº", coords: "114.309267,35.769397" },
            { id: 58, name: "æ™‹åŸå¸‚é˜³åŸå¿åŒ—ä»»åº„æ‘", coords: "112.368608,35.520231" },
            { id: 59, name: "ç„¦ä½œå¸‚æ­¦é™Ÿå¿", coords: "113.515695,35.136367" },
            { id: 60, name: "ç„¦ä½œå¸‚æ²é˜³å¸‚", coords: "113.56127,34.819137" },
            { id: 61, name: "å±±ä¸œçœå¹³é˜´å¿", coords: "116.4385, 36.2876" },
            
            // 62-72 (USER UPDATED - FINAL)
            { id: 62, name: "å±±ä¸œçœä¸´æ²‚å¸‚è’å—å¿", coords: "118.8325, 35.1746" },
            { id: 63, name: "å±±ä¸œçœèŠåŸå¸‚å† å¿", coords: "115.441684, 36.484011" },
            { id: 64, name: "ç”˜è‚ƒçœå¼ æ–å¸‚é«˜å°å¿éª†é©¼åŸé•‡", coords: "99.814300, 39.345600" },
            { id: 65, name: "å¼ æ–å¸‚å±±ä¸¹å¿è€å›ä¹¡å³¡å£æ–°æ‘", coords: "101.092100, 38.784500" },
            { id: 66, name: "å¼ æ–å¸‚ä¸´æ³½å¿é‡‘æ²™æ¸¯ç‰©æµé™¢å†…", coords: "100.131691, 39.131125" }, // UPDATED COORD
            { id: 67, name: "é…’æ³‰å¸‚ç‰é—¨å¸‚é¡¶å¥½æœåŠ¡åŒº", coords: "97.107543, 40.243142" },
            { id: 68, name: "å±±ä¸œçœæ—¥ç…§å¸‚ä¸œæ¸¯åŒºé™ˆç–ƒé•‡", coords: "119.26641, 35.505228" },
            { id: 69, name: "å±±ä¸œçœèŠåŸå¸‚å† å¿23ç«™", coords: "115.8838, 36.43048" },
            { id: 70, name: "å±±ä¸œçœæ³°å®‰å¸‚è‚¥åŸå¸‚æ¡ƒæºé•‡", coords: "116.63859, 36.145948" },
            { id: 71, name: "ç”˜è‚ƒçœå˜‰å³ªå…³å¸‚", coords: "98.289200, 39.773100" },
            { id: 72, name: "å±±ä¸œçœè’™é˜´å¿", coords: "118.645613,35.745408" }
        ];

        // Global State
        let appState = { filter: 'all', stations: [] };
        let map, statusChart, regionChart, geocoder, iconGreen, iconAmber;

        // --- INIT ---
        window.initApp = function() {
            // Icons
            iconGreen = new BMap.Icon("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='36' height='36' fill='%2310b981'%3E%3Cpath d='M12 0C7.58 0 4 3.58 4 8c0 5.25 7 13 7 13s7-7.75 7-13c0-4.42-3.58-8-8-8zm0 11c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z'/%3E%3C/svg%3E", new BMap.Size(30, 40), { anchor: new BMap.Size(15, 40) });
            iconAmber = new BMap.Icon("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='36' height='36' fill='%23f59e0b'%3E%3Cpath d='M12 0C7.58 0 4 3.58 4 8c0 5.25 7 13 7 13s7-7.75 7-13c0-4.42-3.58-8-8-8zm0 11c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z'/%3E%3C/svg%3E", new BMap.Size(30, 40), { anchor: new BMap.Size(15, 40) });

            map = new BMap.Map("map");
            map.centerAndZoom(new BMap.Point(110.0, 37.0), 6);
            map.enableScrollWheelZoom(true);
            map.addControl(new BMap.NavigationControl());
            map.addControl(new BMap.ScaleControl());
            geocoder = new BMap.Geocoder();

            processData(defaultStations);
            initCharts();
            renderApp();
            
            document.getElementById('loading-overlay').style.display = 'none';
            startReverseGeocoding();
        };

        // Load Script
        loadBaiduMap();

        document.addEventListener('DOMContentLoaded', () => {
            setupEvents();
            setupImport();
        });

        // --- CORE LOGIC ---
        function processData(rawData) {
            appState.stations = rawData.map((item, index) => {
                if(!item.coords) return null;
                const [rawLng, rawLat] = item.coords.toString().split(/[,ï¼Œ]/).map(n => parseFloat(n.trim()));
                if (isNaN(rawLng)) return null;

                // BD-09 Conversion
                const [bdLng, bdLat] = gcj02tobd09(rawLng, rawLat);

                const serialId = item.id || (index + 1);

                // Status Logic: 1-23 Operational, Rest Construction
                let isOp = false;
                if(item.status && (item.status.includes("æŠ•è¿") || item.status.includes("è¿è¥"))) {
                    isOp = true;
                } else if (!item.status) {
                    if (serialId <= 23) isOp = true; 
                }

                return {
                    id: serialId,
                    name: item.name || `ç«™ç‚¹ #${serialId}`,
                    lat: bdLat,
                    lng: bdLng,
                    region: "å¾…è§£æ", 
                    regionResolved: false,
                    isOperational: isOp,
                    statusText: isOp ? "å·²æŠ•è¿" : "å»ºè®¾ä¸­"
                };
            }).filter(s => s !== null);
        }

        // --- ASYNC GEOCODING ---
        function startReverseGeocoding() {
            const targets = appState.stations.filter(s => !s.regionResolved);
            if(targets.length === 0) return;
            document.getElementById('geo-badge').classList.remove('hidden');
            let processed = 0;
            function processNext(idx) {
                if (idx >= targets.length) {
                    const badge = document.getElementById('geo-badge');
                    if(badge) badge.innerText = "å®šä½å®Œæˆ";
                    updateChartsOnly(); updateListUI(); return;
                }
                const station = targets[idx];
                const pt = new BMap.Point(station.lng, station.lat);
                geocoder.getLocation(pt, function(rs){
                    if (rs) {
                        const comp = rs.addressComponents;
                        station.region = comp.province + " " + comp.city + (comp.district ? " " + comp.district : ""); 
                        station.regionResolved = true;
                    }
                    processed++;
                    if(processed % 5 === 0) { updateChartsOnly(); updateListUI(); }
                    setTimeout(() => processNext(idx + 1), 120);
                });
            }
            processNext(0);
        }

        // --- RENDER ---
        function initCharts() {
            statusChart = new Chart(document.getElementById('statusChart').getContext('2d'), {
                type: 'doughnut',
                data: { labels: ['å·²æŠ•è¿', 'å»ºè®¾ä¸­'], datasets: [{ data: [0, 0], backgroundColor: ['#10b981', '#f59e0b'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'right', labels: { usePointStyle: true, font: {family: 'Noto Sans SC'} } } } }
            });
            regionChart = new Chart(document.getElementById('regionChart').getContext('2d'), {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'æ•°é‡', data: [], backgroundColor: '#78716c', borderRadius: 3 }] },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { display: false }, y: { grid: { display: false } } }, plugins: { legend: { display: false } } }
            });
        }

        function renderApp() {
            if (!map) return;
            const query = document.getElementById('search-input').value.toLowerCase();
            const filter = appState.filter;
            const filtered = appState.stations.filter(s => {
                const matchStatus = filter === 'all' ? true : (filter === 'op' ? s.isOperational : !s.isOperational);
                const matchSearch = s.name.toLowerCase().includes(query) || s.region.toLowerCase().includes(query) || s.id.toString().includes(query);
                return matchStatus && matchSearch;
            });

            document.getElementById('list-count').innerText = filtered.length;
            document.getElementById('stat-op').innerText = appState.stations.filter(s => s.isOperational).length;
            document.getElementById('stat-con').innerText = appState.stations.filter(s => !s.isOperational).length;

            map.clearOverlays();
            const points = [];
            filtered.forEach(s => {
                const pt = new BMap.Point(s.lng, s.lat);
                points.push(pt);
                const myIcon = s.isOperational ? iconGreen : iconAmber;
                const marker = new BMap.Marker(pt, {icon: myIcon});
                const content = `
                    <div class="p-1">
                        <div class="text-xs text-gray-500 mb-1">NO.${s.id} <span class="${s.isOperational?'text-emerald-600':'text-amber-600'} font-bold ml-1">${s.statusText}</span></div>
                        <div class="font-bold text-gray-800">${s.name}</div>
                        <div class="text-xs text-gray-400 mt-1">${s.region}</div>
                    </div>`;
                const infoWindow = new BMap.InfoWindow(content, {width: 250, height: 90, title: "ç«™ç‚¹è¯¦æƒ…"});
                marker.addEventListener("click", () => map.openInfoWindow(infoWindow, pt));
                map.addOverlay(marker);
                s.markerRef = marker; 
                s.pointRef = pt;
            });
            if(points.length > 0) map.setViewport(points);

            updateListUI(filtered);
            updateChartsOnly(filtered);
        }

        function updateListUI(data = null) {
            if (!data) {
                const query = document.getElementById('search-input').value.toLowerCase();
                const filter = appState.filter;
                data = appState.stations.filter(s => {
                    const matchStatus = filter === 'all' ? true : (filter === 'op' ? s.isOperational : !s.isOperational);
                    const matchSearch = s.name.toLowerCase().includes(query) || s.region.toLowerCase().includes(query);
                    return matchStatus && matchSearch;
                });
            }
            const listEl = document.getElementById('station-list');
            listEl.innerHTML = '';
            data.forEach(s => {
                const item = document.createElement('div');
                item.className = `p-3 rounded-lg border border-stone-100 hover:border-blue-300 hover:shadow-sm cursor-pointer transition-all bg-white flex flex-col gap-1 group`;
                item.onclick = () => { map.centerAndZoom(s.pointRef, 15); s.markerRef.dispatchEvent('click'); };
                const dotColor = s.isOperational ? 'bg-emerald-500' : 'bg-amber-500';
                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex gap-2 w-11/12">
                            <span class="text-xs font-mono text-gray-400 bg-gray-100 px-1 rounded h-fit mt-0.5">#${s.id}</span>
                            <h4 class="text-xs font-bold text-stone-700 group-hover:text-blue-600 transition-colors line-clamp-2">${s.name}</h4>
                        </div>
                        <div class="w-2 h-2 rounded-full ${dotColor} mt-1.5 shrink-0"></div>
                    </div>
                    <div class="flex justify-between items-center text-[10px] text-stone-400 mt-1 ml-8">
                        <span>${s.region}</span>
                    </div>`;
                listEl.appendChild(item);
            });
        }

        function updateChartsOnly(data = null) {
            if (!data) return;
            const opCount = appState.stations.filter(s => s.isOperational).length;
            const conCount = appState.stations.filter(s => !s.isOperational).length;
            statusChart.data.datasets[0].data = [opCount, conCount];
            statusChart.update();

            const regCounts = {};
            data.forEach(s => { 
                const displayRegion = s.region.split(" ")[1] || s.region.split(" ")[0] || "æœªçŸ¥"; 
                regCounts[displayRegion] = (regCounts[displayRegion] || 0) + 1; 
            });
            const sortedReg = Object.entries(regCounts).sort((a,b) => b[1] - a[1]).slice(0, 6); 
            regionChart.data.labels = sortedReg.map(x => x[0]);
            regionChart.data.datasets[0].data = sortedReg.map(x => x[1]);
            regionChart.update();
        }

        function setupImport() {
            const fileInput = document.getElementById('file-upload');
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                document.getElementById('loading-overlay').style.display = 'flex';
                document.getElementById('loading-text').innerText = "è§£ææ–‡ä»¶ä¸­...";
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const bstr = evt.target.result;
                    const wb = XLSX.read(bstr, { type: 'binary' });
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    const normalizedData = json.map((row, idx) => {
                        let name = row['åç§°'] || row['name'] || row['é€‰å€åœ°ç‚¹'] || row['ç«™ç‚¹åç§°'] || "";
                        let coords = row['åæ ‡'] || row['coords'] || row['ç»çº¬åº¦'] || "";
                        let status = row['çŠ¶æ€'] || row['status'] || row['è¿è¥çŠ¶æ€'] || "";
                        let sn = row['åºå·'] || (idx + 1);
                        return { id: sn, name, coords, status };
                    });
                    const validData = normalizedData.filter(d => d.name && d.coords);
                    if (validData.length > 0) {
                        processData(validData);
                        renderApp(); 
                        startReverseGeocoding(); 
                        alert(`è¦†ç›–æˆåŠŸï¼å½“å‰å…± ${validData.length} ä¸ªç«™ç‚¹ã€‚`);
                    }
                    document.getElementById('loading-overlay').style.display = 'none';
                    fileInput.value = ''; 
                };
                reader.readAsBinaryString(file);
            });
        }

        function setupEvents() {
            const btns = {
                all: document.getElementById('filter-all'),
                op: document.getElementById('filter-operational'),
                con: document.getElementById('filter-construction')
            };
            function updateBtnStyle(activeType) {
                Object.values(btns).forEach(b => b.className = 'px-2 py-2 text-xs font-medium bg-white border border-stone-200 text-stone-600 rounded hover:bg-stone-50 transition-colors');
                if(activeType === 'all') btns.all.className = 'px-2 py-2 text-xs font-medium bg-stone-800 text-white rounded shadow-sm';
                if(activeType === 'op') btns.op.className = 'px-2 py-2 text-xs font-medium bg-emerald-50 border border-emerald-200 text-emerald-700 rounded font-bold shadow-sm';
                if(activeType === 'con') btns.con.className = 'px-2 py-2 text-xs font-medium bg-amber-50 border border-amber-200 text-amber-700 rounded font-bold shadow-sm';
            }
            btns.all.onclick = () => { appState.filter = 'all'; updateBtnStyle('all'); renderApp(); };
            btns.op.onclick = () => { appState.filter = 'op'; updateBtnStyle('op'); renderApp(); };
            btns.con.onclick = () => { appState.filter = 'con'; updateBtnStyle('con'); renderApp(); };
            document.getElementById('search-input').addEventListener('input', renderApp);
        }
    </script>
</body>
</html>
