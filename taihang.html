<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»¿æ–°èƒ½æºå……ç”µç½‘ç»œæ™ºèƒ½ç›‘æ§çœ‹æ¿</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- SheetJS (XLSX) for Excel Import -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <!-- ç™¾åº¦åœ°å›¾ API -->
    <script type="text/javascript" src="https://api.map.baidu.com/api?v=3.0&ak=hyHkuQy8h5UbZVMC0mpVW4ma7TVxqm3W"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans SC', "Microsoft YaHei", sans-serif;
            background-color: #f5f5f4;
        }
        /* Map Container */
        #map-container {
            position: relative;
            height: 100%;
            min-height: 450px;
            width: 100%;
            border-radius: 0.75rem;
            overflow: hidden;
            z-index: 1;
            border: 1px solid #e7e5e4;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        /* Remove Baidu Logo for clean view */
        .anchorBL { display: none; }
        
        .station-list::-webkit-scrollbar { width: 6px; }
        .station-list::-webkit-scrollbar-track { background: #f1f1f1; }
        .station-list::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 3px; }
        .chart-container { position: relative; width: 100%; height: 200px; }
        
        /* Baidu InfoWindow */
        .BMap_bubble_title {
            color: #1c1917;
            font-weight: bold;
            font-size: 14px;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 5px;
        }
        .BMap_bubble_content {
            font-size: 12px;
            color: #57534e;
            padding-top: 5px;
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
    </style>
</head>
<body class="text-stone-800 h-screen flex flex-col overflow-hidden">

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-stone-600 font-medium" id="loading-text">æ­£åœ¨å¤„ç†æ•°æ®...</p>
    </div>

    <!-- Header -->
    <header class="bg-white border-b border-stone-200 shadow-sm z-20 shrink-0">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-xl shadow-md">
                    B
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-stone-900">å……ç”µç½‘ç»œå…¨æ™¯çœ‹æ¿ <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded ml-2 align-middle">Pro v2</span></h1>
                    <p class="text-xs text-stone-500">
                        å…± 72 ç«™ (23æŠ•è¿) | 
                        <span id="geo-status" class="text-stone-400">ç­‰å¾…å®šä½è§£æ...</span>
                    </p>
                </div>
            </div>
            <div class="hidden sm:flex gap-4 text-sm font-medium text-stone-600">
                <div class="flex items-center gap-2 px-3 py-1 rounded-full bg-emerald-50 border border-emerald-100">
                    <span class="block w-2.5 h-2.5 rounded-full bg-emerald-500"></span>
                    <span>å·²æŠ•è¿</span>
                </div>
                <div class="flex items-center gap-2 px-3 py-1 rounded-full bg-amber-50 border border-amber-100">
                    <span class="block w-2.5 h-2.5 rounded-full bg-amber-500"></span>
                    <span>å»ºè®¾ä¸­</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 max-w-7xl w-full mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-4 overflow-hidden">

        <!-- Sidebar -->
        <div class="lg:col-span-3 flex flex-col gap-4 h-full overflow-hidden order-2 lg:order-1">
            
            <!-- Controls & Import -->
            <div class="bg-white rounded-xl shadow-sm border border-stone-200 p-4 shrink-0 space-y-3">
                
                <!-- Import Button -->
                <div class="relative">
                    <input type="file" id="file-upload" accept=".xlsx, .xls, .csv" class="hidden" />
                    <label for="file-upload" class="flex items-center justify-center w-full gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg cursor-pointer transition-colors shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                        </svg>
                        å¯¼å…¥æ›´æ–° (Excel/CSV)
                    </label>
                    <p class="text-[10px] text-center text-stone-400 mt-1">æ”¯æŒæ‹–æ‹½å¯¼å…¥ï¼Œè‡ªåŠ¨è¦†ç›–å½“å‰æ•°æ®</p>
                </div>

                <hr class="border-stone-100">

                <div class="grid grid-cols-3 gap-2">
                    <button id="filter-all" class="px-2 py-2 text-xs font-medium bg-stone-800 text-white rounded hover:bg-stone-700 transition-colors shadow-sm">å…¨éƒ¨</button>
                    <button id="filter-operational" class="px-2 py-2 text-xs font-medium bg-white border border-stone-200 text-stone-600 rounded hover:bg-emerald-50 hover:text-emerald-700 transition-colors">å·²æŠ•è¿</button>
                    <button id="filter-construction" class="px-2 py-2 text-xs font-medium bg-white border border-stone-200 text-stone-600 rounded hover:bg-amber-50 hover:text-amber-700 transition-colors">å»ºè®¾ä¸­</button>
                </div>
                
                <div class="relative group">
                    <input type="text" id="search-input" placeholder="æœç´¢åç§°æˆ–åœ°åŒº..." class="w-full pl-9 pr-3 py-2 text-sm bg-stone-50 border border-stone-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 focus:bg-white transition-all">
                    <span class="absolute left-3 top-2.5 text-stone-400">ğŸ”</span>
                </div>
            </div>

            <!-- List -->
            <div class="bg-white rounded-xl shadow-sm border border-stone-200 flex flex-col flex-1 overflow-hidden">
                <div class="px-4 py-3 border-b border-stone-100 bg-stone-50 flex justify-between items-center">
                    <span class="text-xs font-bold text-stone-500 uppercase">ç«™ç‚¹åˆ—è¡¨</span>
                    <span id="list-count" class="text-xs font-bold bg-stone-200 text-stone-700 px-2 py-0.5 rounded-md">0</span>
                </div>
                <div id="station-list" class="station-list flex-1 overflow-y-auto p-2 space-y-2">
                    <!-- JS Populated -->
                </div>
            </div>
        </div>

        <!-- Main Area -->
        <div class="lg:col-span-9 flex flex-col gap-4 h-full overflow-hidden order-1 lg:order-2">
            
            <!-- Map Container -->
            <div id="map-container" class="bg-white shadow-sm">
                <div id="map"></div>
                <!-- Legend -->
                <div class="absolute bottom-5 right-5 bg-white/95 backdrop-blur shadow-md border border-stone-100 rounded-lg p-3 z-[400] text-xs">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="w-3 h-3 rounded-full bg-emerald-500 shadow-sm"></span>
                        <span class="text-stone-700 font-medium">æ­£å¸¸è¿è¥</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-amber-500 shadow-sm"></span>
                        <span class="text-stone-700 font-medium">è§„åˆ’å»ºè®¾</span>
                    </div>
                </div>
            </div>

            <!-- Analytics -->
            <div class="h-auto lg:h-52 shrink-0 grid grid-cols-1 md:grid-cols-3 gap-4">
                
                <!-- Stat Card 1 -->
                <div class="bg-white rounded-xl shadow-sm border border-stone-200 p-5 flex flex-col justify-center">
                    <h3 class="text-sm font-bold text-stone-500 mb-4">ç½‘ç»œæ¦‚å†µ</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="border-r border-stone-100">
                            <div class="text-3xl font-bold text-emerald-600" id="stat-op">0</div>
                            <div class="text-xs text-stone-500 mt-1">è¿è¥ä¸­</div>
                        </div>
                        <div>
                            <div class="text-3xl font-bold text-amber-500" id="stat-con">0</div>
                            <div class="text-xs text-stone-500 mt-1">å»ºè®¾ä¸­</div>
                        </div>
                    </div>
                </div>

                <!-- Chart Card 2 -->
                <div class="bg-white rounded-xl shadow-sm border border-stone-200 p-4 flex flex-col">
                    <h3 class="text-sm font-bold text-stone-500 mb-1">å»ºè®¾è¿›åº¦</h3>
                    <div class="flex-1 flex items-center justify-center relative">
                        <div class="chart-container">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Chart Card 3 -->
                <div class="bg-white rounded-xl shadow-sm border border-stone-200 p-4 flex flex-col relative">
                    <div class="flex justify-between items-center mb-1">
                        <h3 class="text-sm font-bold text-stone-500">åŒºåŸŸåˆ†å¸ƒ (æ™ºèƒ½è§£æ)</h3>
                        <span id="geo-badge" class="text-[9px] bg-blue-50 text-blue-600 px-1.5 rounded hidden">è‡ªåŠ¨å®šä½ä¸­</span>
                    </div>
                    <div class="flex-1 flex items-center justify-center">
                        <div class="chart-container">
                            <canvas id="regionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- 1. COORDINATE CONVERSION (GCJ-02 -> BD-09) ---
        const x_pi = 3.14159265358979324 * 3000.0 / 180.0;
        function gcj02tobd09(lng, lat) {
            const z = Math.sqrt(lng * lng + lat * lat) + 0.00002 * Math.sin(lat * x_pi);
            const theta = Math.atan2(lat, lng) + 0.000003 * Math.cos(lng * x_pi);
            const bd_lng = z * Math.cos(theta) + 0.0065;
            const bd_lat = z * Math.sin(theta) + 0.006;
            return [bd_lng, bd_lat];
        }

        // --- 2. CUSTOM ICONS ---
        const iconGreen = new BMap.Icon(
            "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='36' height='36' fill='%2310b981'%3E%3Cpath d='M12 0C7.58 0 4 3.58 4 8c0 5.25 7 13 7 13s7-7.75 7-13c0-4.42-3.58-8-8-8zm0 11c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z'/%3E%3C/svg%3E", 
            new BMap.Size(30, 40), { anchor: new BMap.Size(15, 40) }
        );
        const iconAmber = new BMap.Icon(
            "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='36' height='36' fill='%23f59e0b'%3E%3Cpath d='M12 0C7.58 0 4 3.58 4 8c0 5.25 7 13 7 13s7-7.75 7-13c0-4.42-3.58-8-8-8zm0 11c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z'/%3E%3C/svg%3E",
            new BMap.Size(30, 40), { anchor: new BMap.Size(15, 40) }
        );

        // --- 3. FULL DATA (72 Stations) ---
        // Logic: Index 0-22 (IDs 1-23) -> Operational
        // Logic: Index 23-71 (IDs 24-72) -> Construction
        const defaultStations = [
            // 1-23: Operational
            { name: "ç»¿æ–°èƒ½æºæ½é“æ™ºæ…§ç‰©æµå›­å›­åŒºå†…ï¼ˆæ¢ç”µç«™ï¼‰", coords: "113.28292,36.325017" },
            { name: "ç»¿æ–°èƒ½æºé»„åŒ—å……ç”µç«™", coords: "113.134684,36.357572" },
            { name: "ç»¿æ–°èƒ½æºæ¶‰å¿ç¥å¤´å……ç”µç«™", coords: "113.598247,36.519466" },
            { name: "ç»¿æ–°èƒ½æºçŸ³æ¢å……ç”µç«™", coords: "113.318021,36.453537" },
            { name: "ç»¿æ–°èƒ½æºå¡åº•å……ç”µç«™", coords: "113.08529,36.341152" },
            { name: "ç»¿æ–°èƒ½æºå²å»»æ±½è´¸å›­å……ç”µç«™", coords: "113.157286,36.349615" },
            { name: "ç»¿æ–°èƒ½æºå—ç‹åº„å……ç”µç«™ï¼ˆä¸Šå…šåŒºçšå®¶æ²Ÿï¼‰", coords: "113.054248,36.03518" },
            { name: "ç»¿æ–°èƒ½æºåº—ä¸Šå……ç”µç«™1æœŸ", coords: "113.274594,35.989891" },
            { name: "ç»¿æ–°èƒ½æºæ­¦ä¹¡èŸ é¾™å……ç”µç«™", coords: "113.134701,36.787052" },
            { name: "ç»¿æ–°èƒ½æºçµçŸ³å……ç”µç«™", coords: "111.721147,36.837839" },
            { name: "ç»¿æ–°èƒ½æºè«åŸå……ç”µç«™", coords: "113.080556,36.007629" },
            { name: "ç»¿æ–°èƒ½æºè¥¿æ± å……ç”µç«™", coords: "112.981881,36.104279" },
            { name: "ç»¿æ–°èƒ½æºè‹åº—å……ç”µç«™", coords: "113.076813,36.077271" },
            { name: "ç»¿æ–°èƒ½æºè¥¿ç«å……ç”µç«™", coords: "113.28424,35.992813" },
            { name: "ç»¿æ–°èƒ½æºå…«ä¹‰å……ç”µç«™", coords: "113.033621,36.035777" },
            { name: "ç»¿æ–°èƒ½æºå—å®‹å……ç”µç«™", coords: "113.036081,35.948286" },
            { name: "ç»¿æ–°èƒ½æºåŒ—å‘ˆå……ç”µç«™", coords: "113.057321,36.148197" },
            { name: "ç»¿æ–°èƒ½æºéŸ©åŒ—å……ç”µç«™", coords: "113.111874,36.151745" },
            { name: "ç»¿æ–°èƒ½æºä¸œå’Œå……ç”µç«™", coords: "112.973341,36.143644" },
            { name: "ç»¿æ–°èƒ½æºå¸é©¬å……ç”µç«™", coords: "113.033785,36.082717" },
            { name: "ç»¿æ–°èƒ½æºè¥¿è¥å……ç”µç«™", coords: "113.064516,35.480031" },
            { name: "ç»¿æ–°èƒ½æºä¸œå†¶å¤´å……ç”µç«™", coords: "113.310636,35.539851" },
            { name: "ç»¿æ–°èƒ½æºæ¬¡è¥å……ç”µç«™", coords: "113.197967,35.433842" },
            // 24-72: Construction
            { name: "ç»¿æ–°èƒ½æºäº”é¾™å±±å……ç”µç«™", coords: "113.488347,35.501174" },
            { name: "ç»¿æ–°èƒ½æºæ¨ªæ°´å……ç”µç«™", coords: "113.626305,36.155892" },
            { name: "ç»¿æ–°èƒ½æºäº•å¡å……ç”µç«™", coords: "113.568421,35.553909" },
            { name: "ç»¿æ–°èƒ½æºåˆæ²³å……ç”µç«™", coords: "113.971512,35.340078" },
            { name: "ç»¿æ–°èƒ½æºä¸´æ·‡å……ç”µç«™", coords: "113.985926,35.895034" },
            { name: "ç»¿æ–°èƒ½æºäº”é¾™å……ç”µç«™", coords: "114.103986,35.858763" },
            { name: "ç»¿æ–°èƒ½æºä¸œå§šå……ç”µç«™", coords: "113.993083,35.975477" },
            { name: "ç»¿æ–°èƒ½æºé‡‡æ¡‘å……ç”µç«™", coords: "113.88602,35.918991" },
            { name: "ç»¿æ–°èƒ½æºä¸œå²—å……ç”µç«™", coords: "114.159381,36.257008" },
            { name: "ç»¿æ–°èƒ½æºä»»æ‘å……ç”µç«™", coords: "113.931229,36.265731" },
            { name: "ç»¿æ–°èƒ½æºå¹³é‚‘å……ç”µç«™", coords: "113.250557,36.319762" },
            { name: "ç»¿æ–°èƒ½æºå§šæ‘å……ç”µç«™", coords: "113.840748,36.156828" },
            { name: "ç»¿æ–°èƒ½æºæ½é“æ™ºæ…§ç‰©æµå›­ï¼ˆå……ç”µç«™ï¼‰", coords: "113.28424,35.992813" },
            { name: "ç»¿æ–°èƒ½æºæŒ¯å…´å……ç”µç«™", coords: "113.064516,35.480031" },
            { name: "ç»¿æ–°èƒ½æºå£¶å…³é›†åº—å……ç”µç«™", coords: "113.167824,36.082761" },
            { name: "ç»¿æ–°èƒ½æºå¹³é¡ºåŒ—ç¤¾å……ç”µç«™", coords: "113.385906,36.145892" },
            { name: "ç»¿æ–°èƒ½æºå±¯ç•™æ¸”æ³½å……ç”µç«™", coords: "112.946351,36.286821" },
            { name: "ç»¿æ–°èƒ½æºé•¿æ²»å¿è´¾æŒå……ç”µç«™", coords: "113.003554,35.932824" },
            { name: "ç»¿æ–°èƒ½æºæ½åŸå¾®å­é•‡å……ç”µç«™", coords: "113.220197,36.284897" },
            { name: "ä»‹ä¼‘å¸‚ä¹‰å®‰é•‡", coords: "111.948054,36.985047" },
            { name: "å­ä¹‰å¸‚æŸ±æ¿®é•‡ä¸Šæ™ºå³ªæ‘", coords: "111.691507,37.075799" },
            { name: "æ™‹åŸå¸‚æ³½å·å¿å·´å…¬é•‡", coords: "112.912409,35.609078" },
            { name: "å®‰é˜³åˆ©æº", coords: "114.344815,36.150114" },
            { name: "æ´ªæ´ç”˜äº­é•‡", coords: "111.672237,36.179187" },
            { name: "æ—å·æ²³é¡ºé•‡æ¨å®¶è¥æ‘", coords: "113.901521,36.141551" },
            { name: "æ™‹åŸå¸‚æ³½å·å¿å¤§ä¸œæ²Ÿé•‡", coords: "112.720088,35.587986" },
            { name: "å·¦æƒä¸‹å…¶è‡³æ‘", coords: "113.447107,37.165597" },
            { name: "å­ä¹‰å¸‚ä¸œè‘£å±¯æ‘ï¼ˆåŸæ˜†ä»‘åŠ æ°”ç«™ï¼‰", coords: "111.84799,37.044294" },
            { name: "å­ä¹‰å¸‚ä¸œè®¸åŠäº‹å¤„ä¸œè®¸æ‘ï¼ˆåŸåŠ æ²¹ç«™ï¼‰", coords: "111.848821,37.169123" },
            { name: "å­ä¹‰å¸‚é«˜é˜³é•‡é«˜é˜³æ‘", coords: "111.751684,37.12764" },
            { name: "æ—å·ä¸´æ·‡é•‡å å…ƒæ‘", coords: "113.978276,35.85098" },
            { name: "çµçŸ³å¿å—å…³é•‡çŸ³æŸœæ‘ï¼ˆè¶…é™ç«™å¯¹é¢ï¼‰", coords: "111.737126,36.878772" },
            { name: "çµçŸ³å¿ä¸¤æ¸¡é•‡ä¸¤æ¸¡æ‘", coords: "111.722607,36.83733" },
            { name: "æ´ªæ´å¿èµµåŸé•‡", coords: "111.743126,36.335955" },
            { name: "é•¿å­å¿ä¸¹æœ±é•‡", coords: "112.909068,36.126435" },
            { name: "å®‰é˜³å¿æ°´å†¶é•‡", coords: "114.168545,36.166418" },
            { name: "æ—å·åŸåº·é•‡", coords: "113.923489,35.986877" },
            { name: "æ—å·èŒ¶åº—é•‡", coords: "113.916812,35.923058" },
            { name: "é•¿æ²»å¿å—å®‹ä¹¡", coords: "113.064516,35.480031" },
            { name: "æ³½å·å¿åŒ—ä¹‰åŸé•‡", coords: "112.923971,35.477028" },
            { name: "æ­¦ä¹¡å¿åˆ†æ°´å²­ä¹¡", coords: "113.051918,36.938814" },
            { name: "è¥„å£å¿å¤åº—é•‡", coords: "113.03716,36.564414" },
            { name: "é•¿æ²»å¿è¥¿ç«é•‡", coords: "113.28424,35.992813" },
            { name: "å£¶å…³å¿ç™¾å°ºé•‡", coords: "113.243501,36.033628" },
            { name: "æ—å·ä¸œå§šé•‡", coords: "113.993083,35.975477" },
            { name: "æ—å·æ¨ªæ°´é•‡", coords: "113.626305,36.155892" },
            { name: "æ—å·é‡‡æ¡‘é•‡", coords: "113.88602,35.918991" },
            { name: "æ—å·äº”é¾™é•‡", coords: "114.103986,35.858763" },
            { name: "æ—å·æ¡‚æ—é•‡", coords: "113.999617,35.976077" }
        ];

        // Global State
        let appState = { filter: 'all', stations: [] };
        let map; 
        let statusChart, regionChart;
        let geocoder;

        document.addEventListener('DOMContentLoaded', () => {
            // Load Default Data First
            processData(defaultStations);
            
            // Wait for BMap
            const checkBMap = setInterval(() => {
                if (typeof BMap !== 'undefined') {
                    clearInterval(checkBMap);
                    initMap();
                    geocoder = new BMap.Geocoder();
                    initCharts();
                    renderApp();
                    startReverseGeocoding(); // Start the async lookup
                }
            }, 500);

            setupEvents();
            setupImport();
        });

        // --- 4. DATA PROCESSING ---
        function processData(rawData) {
            appState.stations = rawData.map((item, index) => {
                if(!item.coords) return null;
                const [rawLng, rawLat] = item.coords.toString().split(/[,ï¼Œ]/).map(n => parseFloat(n.trim()));
                
                // Sanity Check
                if (rawLng < 100 || isNaN(rawLng)) return null;

                // Convert GCJ to BD
                const [bdLng, bdLat] = gcj02tobd09(rawLng, rawLat);

                // Status Logic: 
                // 1. If explicitly has "æŠ•è¿", use it.
                // 2. Otherwise use Index logic: 0-22 are Op.
                let isOp = false;
                if(item.status && (item.status.includes("æŠ•è¿") || item.status.includes("è¿è¥"))) {
                    isOp = true;
                } else if (!item.status) {
                    if (index < 23) isOp = true;
                }

                return {
                    name: item.name || `ç«™ç‚¹ ${index+1}`,
                    lat: bdLat,
                    lng: bdLng,
                    region: "å¾…è§£æ...", 
                    regionResolved: false,
                    isOperational: isOp,
                    statusText: isOp ? "å·²æŠ•è¿" : "å»ºè®¾ä¸­"
                };
            }).filter(s => s !== null);
        }

        // --- 5. REVERSE GEOCODING LOGIC ---
        function startReverseGeocoding() {
            const targets = appState.stations.filter(s => !s.regionResolved);
            if(targets.length === 0) return;

            document.getElementById('geo-status').innerText = `æ­£åœ¨è§£æ ${targets.length} ä¸ªåœ°å€...`;
            document.getElementById('geo-badge').classList.remove('hidden');

            let processed = 0;
            
            function processNext(idx) {
                if (idx >= targets.length) {
                    document.getElementById('geo-status').innerText = "åœ°å€è§£æå®Œæˆ";
                    document.getElementById('geo-badge').classList.add('hidden');
                    updateChartsOnly(); 
                    updateListUI(); 
                    return;
                }

                const station = targets[idx];
                const pt = new BMap.Point(station.lng, station.lat);

                geocoder.getLocation(pt, function(rs){
                    if (rs) {
                        const comp = rs.addressComponents;
                        station.region = comp.city; 
                        if(comp.district) station.region += " " + comp.district;
                        station.regionResolved = true;
                    } else {
                        station.region = "æœªçŸ¥åŒºåŸŸ";
                    }
                    
                    processed++;
                    if(processed % 5 === 0) {
                        updateChartsOnly();
                        updateListUI();
                    }
                    
                    setTimeout(() => processNext(idx + 1), 100);
                });
            }

            processNext(0);
        }

        // --- 6. IMPORT LOGIC ---
        function setupImport() {
            const fileInput = document.getElementById('file-upload');
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                document.getElementById('loading-overlay').style.display = 'flex';

                const reader = new FileReader();
                reader.onload = (evt) => {
                    const bstr = evt.target.result;
                    const wb = XLSX.read(bstr, { type: 'binary' });
                    const wsname = wb.SheetNames[0];
                    const ws = wb.Sheets[wsname];
                    const json = XLSX.utils.sheet_to_json(ws);

                    const normalizedData = json.map(row => {
                        let name = row['åç§°'] || row['name'] || row['Name'] || row['é€‰å€åœ°ç‚¹'] || row['ç«™ç‚¹åç§°'] || "";
                        let coords = row['åæ ‡'] || row['coords'] || row['Coords'] || row['ç»çº¬åº¦'] || "";
                        let status = row['çŠ¶æ€'] || row['status'] || row['Status'] || row['è¿è¥çŠ¶æ€'] || "";
                        return { name, coords, status };
                    });

                    const validData = normalizedData.filter(d => d.name && d.coords);

                    if (validData.length > 0) {
                        processData(validData);
                        renderApp(); 
                        startReverseGeocoding(); 
                        alert(`å¯¼å…¥æˆåŠŸï¼å…± ${validData.length} æ¡æ•°æ®ã€‚`);
                    } else {
                        alert("æœªè¯†åˆ«åˆ°æœ‰æ•ˆæ•°æ®ã€‚è¯·ç¡®ä¿åŒ…å«åˆ—ï¼šåç§°ã€åæ ‡");
                    }
                    document.getElementById('loading-overlay').style.display = 'none';
                    fileInput.value = ''; 
                };
                reader.readAsBinaryString(file);
            });
        }

        // --- 7. RENDERING ---
        function initMap() {
            map = new BMap.Map("map");
            map.centerAndZoom(new BMap.Point(113.2, 36.5), 9);
            map.enableScrollWheelZoom(true);
            map.addControl(new BMap.NavigationControl());
            map.addControl(new BMap.ScaleControl());
        }

        function initCharts() {
            statusChart = new Chart(document.getElementById('statusChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['å·²æŠ•è¿', 'å»ºè®¾ä¸­'],
                    datasets: [{ data: [0, 0], backgroundColor: ['#10b981', '#f59e0b'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'right', labels: { usePointStyle: true, font: {family: 'Noto Sans SC'} } } } }
            });

            regionChart = new Chart(document.getElementById('regionChart').getContext('2d'), {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'ç«™ç‚¹æ•°', data: [], backgroundColor: '#78716c', borderRadius: 3 }] },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { display: false }, y: { grid: { display: false }, ticks: { font: { size: 10, family: 'Noto Sans SC' } } } }, plugins: { legend: { display: false } } }
            });
        }

        function renderApp() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const filter = appState.filter;

            const filtered = appState.stations.filter(s => {
                const matchStatus = filter === 'all' ? true : (filter === 'op' ? s.isOperational : !s.isOperational);
                const matchSearch = s.name.toLowerCase().includes(query) || s.region.toLowerCase().includes(query);
                return matchStatus && matchSearch;
            });

            document.getElementById('list-count').innerText = filtered.length;
            document.getElementById('stat-op').innerText = appState.stations.filter(s => s.isOperational).length;
            document.getElementById('stat-con').innerText = appState.stations.filter(s => !s.isOperational).length;

            if (map) {
                map.clearOverlays();
                const points = [];
                filtered.forEach(s => {
                    const pt = new BMap.Point(s.lng, s.lat);
                    points.push(pt);
                    const myIcon = s.isOperational ? iconGreen : iconAmber;
                    const marker = new BMap.Marker(pt, {icon: myIcon});
                    
                    const content = `
                        <div class="p-1">
                            <div style="font-size:12px; color:#666; margin-bottom:4px;">${s.region} <span style="margin-left:5px; color:${s.isOperational?'#10b981':'#f59e0b'}; font-weight:bold;">${s.statusText}</span></div>
                            <div style="font-weight:bold; color:#333; font-size:14px;">${s.name}</div>
                        </div>`;
                    const infoWindow = new BMap.InfoWindow(content, {width: 250, height: 80, title: "ç«™ç‚¹è¯¦æƒ…"});
                    marker.addEventListener("click", () => map.openInfoWindow(infoWindow, pt));
                    
                    map.addOverlay(marker);
                    s.markerRef = marker;
                    s.pointRef = pt;
                });
                if (points.length > 0) map.setViewport(points);
            }

            updateListUI(filtered);
            updateChartsOnly(filtered);
        }

        function updateListUI(data = null) {
            if(!data) {
                const query = document.getElementById('search-input').value.toLowerCase();
                const filter = appState.filter;
                data = appState.stations.filter(s => {
                    const matchStatus = filter === 'all' ? true : (filter === 'op' ? s.isOperational : !s.isOperational);
                    const matchSearch = s.name.toLowerCase().includes(query) || s.region.toLowerCase().includes(query);
                    return matchStatus && matchSearch;
                });
            }

            const listEl = document.getElementById('station-list');
            listEl.innerHTML = '';
            data.forEach(s => {
                const item = document.createElement('div');
                item.className = `p-3 rounded-lg border border-stone-100 hover:border-blue-300 hover:shadow-sm cursor-pointer transition-all bg-white flex flex-col gap-1 group`;
                item.onclick = () => {
                    if(map) {
                        map.centerAndZoom(s.pointRef, 15);
                        s.markerRef.dispatchEvent('click');
                        const infoWindow = new BMap.InfoWindow(`
                            <div class="p-1">
                                <div style="font-size:12px; color:#666; margin-bottom:4px;">${s.region} <span style="margin-left:5px; color:${s.isOperational?'#10b981':'#f59e0b'}; font-weight:bold;">${s.statusText}</span></div>
                                <div style="font-weight:bold; color:#333; font-size:14px;">${s.name}</div>
                            </div>`, {width: 250, height: 80, title: "ç«™ç‚¹è¯¦æƒ…"});
                        map.openInfoWindow(infoWindow, s.pointRef);
                    }
                };
                
                const dotColor = s.isOperational ? 'bg-emerald-500' : 'bg-amber-500';
                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h4 class="text-xs font-bold text-stone-700 group-hover:text-blue-600 transition-colors line-clamp-2 w-11/12">${s.name}</h4>
                        <div class="w-2 h-2 rounded-full ${dotColor} mt-1.5 shrink-0"></div>
                    </div>
                    <div class="flex justify-between items-center text-[10px] text-stone-400 mt-1">
                        <span>${s.region}</span>
                    </div>
                `;
                listEl.appendChild(item);
            });
        }

        function updateChartsOnly(data = null) {
             if(!data) {
                const query = document.getElementById('search-input').value.toLowerCase();
                const filter = appState.filter;
                data = appState.stations.filter(s => {
                    const matchStatus = filter === 'all' ? true : (filter === 'op' ? s.isOperational : !s.isOperational);
                    const matchSearch = s.name.toLowerCase().includes(query) || s.region.toLowerCase().includes(query);
                    return matchStatus && matchSearch;
                });
            }

            const opCount = appState.stations.filter(s => s.isOperational).length;
            const conCount = appState.stations.filter(s => !s.isOperational).length;
            statusChart.data.datasets[0].data = [opCount, conCount];
            statusChart.update();

            const regCounts = {};
            data.forEach(s => { 
                const displayRegion = s.region.split(" ")[0]; 
                regCounts[displayRegion] = (regCounts[displayRegion] || 0) + 1; 
            });
            const sortedReg = Object.entries(regCounts).sort((a,b) => b[1] - a[1]).slice(0, 6); 
            regionChart.data.labels = sortedReg.map(x => x[0]);
            regionChart.data.datasets[0].data = sortedReg.map(x => x[1]);
            regionChart.update();
        }

        function setupEvents() {
            const btns = {
                all: document.getElementById('filter-all'),
                op: document.getElementById('filter-operational'),
                con: document.getElementById('filter-construction')
            };

            function updateBtnStyle(activeType) {
                Object.values(btns).forEach(b => {
                    b.className = 'px-2 py-2 text-xs font-medium bg-white border border-stone-200 text-stone-600 rounded hover:bg-stone-50 transition-colors';
                });
                if(activeType === 'all') btns.all.className = 'px-2 py-2 text-xs font-medium bg-stone-800 text-white rounded shadow-sm';
                if(activeType === 'op') btns.op.className = 'px-2 py-2 text-xs font-medium bg-emerald-50 border border-emerald-200 text-emerald-700 rounded font-bold shadow-sm';
                if(activeType === 'con') btns.con.className = 'px-2 py-2 text-xs font-medium bg-amber-50 border border-amber-200 text-amber-700 rounded font-bold shadow-sm';
            }

            btns.all.onclick = () => { appState.filter = 'all'; updateBtnStyle('all'); renderApp(); };
            btns.op.onclick = () => { appState.filter = 'op'; updateBtnStyle('op'); renderApp(); };
            btns.con.onclick = () => { appState.filter = 'con'; updateBtnStyle('con'); renderApp(); };

            document.getElementById('search-input').addEventListener('input', renderApp);
        }
    </script>
</body>
</html>
